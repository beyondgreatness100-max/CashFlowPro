<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    <title>CashFlow Pro - Budget & Wealth Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Fraunces:opsz,wght@9..144,600;9..144,700&family=Noto+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- FAST CLICK - Immediate touch response -->
    <script>
    (function(){
        if('ontouchstart' in window){
            var findClickable = function(el) {
                for(var i = 0; i < 10 && el && el !== document.body; i++) {
                    if(el.onclick || (el.getAttribute && el.getAttribute('onclick'))) return el;
                    if(el.tagName === 'BUTTON') return el;
                    el = el.parentElement;
                }
                return null;
            };
            
            var touched = null;
            
            document.addEventListener('touchstart', function(e){
                var t = findClickable(e.target);
                if(t) { 
                    t.style.opacity = '0.7'; 
                    touched = t;
                }
            }, {passive: true});
            
            document.addEventListener('touchend', function(e){
                if(touched) {
                    var t = touched;
                    touched = null;
                    t.style.opacity = '1';
                    e.preventDefault();
                    
                    // Try onclick function first
                    if(typeof t.onclick === 'function') {
                        t.onclick(e);
                    } else {
                        // Fallback to click
                        t.click();
                    }
                }
            }, {passive: false});
            
            document.addEventListener('touchmove', function(e){
                if(touched) {
                    touched.style.opacity = '1';
                    touched = null;
                }
            }, {passive: true});
        }
    })();
    </script>
    
    <style>
        /* Reset and Base */
        *, *::before, *::after {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            touch-action: manipulation;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /* iOS Safari click fix */
            cursor: pointer;
        }

        /* Fix for mobile browser buttons */
        button, .nav-item, .btn, .submit-btn, .quick-add-btn, .action-btn {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            touch-action: manipulation;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Ensure clickable elements are tappable */
        a, button, input, select, textarea, [onclick] {
            touch-action: manipulation;
        }

        :root {
            --bg-primary: #faf8f5;
            --bg-card: #ffffff;
            --bg-accent: #f0ebe3;
            --text-primary: #1a1a1a;
            --text-secondary: #6b6b6b;
            --text-muted: #9a9a9a;
            --accent-green: #2d6a4f;
            --accent-green-light: #d8f3dc;
            --accent-red: #c44536;
            --accent-red-light: #fce4e1;
            --accent-blue: #3a86ff;
            --accent-orange: #f48c06;
            --accent-purple: #7b2cbf;
            --border: #e8e4de;
            --shadow: 0 2px 12px rgba(0,0,0,0.06);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.1);
            --radius: 16px;
            --radius-sm: 10px;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-top: env(safe-area-inset-top, 0px);
            --nav-height: 70px;
        }

        /* ==================== */
        /* ONBOARDING SLIDESHOW */
        /* ==================== */
        .onboarding {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            z-index: 10000;
        }

        .onboarding.hidden {
            display: none;
        }

        .slides-container {
            height: calc(100% - 100px);
            position: relative;
            overflow: hidden;
        }

        .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
            text-align: center;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s ease-out;
        }

        .slide.active {
            opacity: 1;
            transform: translateX(0);
        }

        .slide.exit {
            opacity: 0;
            transform: translateX(-100%);
        }

        .slide-icon {
            font-size: 72px;
            margin-bottom: 24px;
        }

        .slide-title {
            font-family: 'Fraunces', serif;
            font-size: 28px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 16px;
            line-height: 1.3;
        }

        .slide-title span {
            background: linear-gradient(135deg, #10b981, #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .slide-text {
            font-size: 16px;
            color: #94a3b8;
            line-height: 1.6;
            max-width: 300px;
            margin-bottom: 24px;
        }

        .slide-features {
            text-align: left;
            width: 100%;
            max-width: 280px;
        }

        .slide-feature {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            margin-bottom: 10px;
            color: #e2e8f0;
            font-size: 14px;
        }

        .name-input {
            width: 100%;
            max-width: 280px;
            padding: 16px 20px;
            font-size: 18px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            color: #ffffff;
            text-align: center;
            outline: none;
        }

        .name-input:focus {
            border-color: #10b981;
        }

        .name-input::placeholder {
            color: #64748b;
        }

        /* Language Selection in Onboarding */
        .language-select-onboarding {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
            max-width: 280px;
            margin-top: 20px;
        }

        .lang-select-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 20px 24px;
            background: rgba(255,255,255,0.08);
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #ffffff;
        }

        .lang-select-btn:hover {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
            transform: scale(1.02);
        }

        .lang-select-btn:active {
            transform: scale(0.98);
        }

        .lang-select-flag {
            font-size: 36px;
        }

        .lang-select-name {
            font-size: 22px;
            font-weight: 600;
        }

        .nav-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px 24px;
            padding-bottom: calc(24px + env(safe-area-inset-bottom, 20px));
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to top, rgba(15, 23, 42, 1) 0%, rgba(15, 23, 42, 0) 100%);
        }

        .dots {
            display: flex;
            gap: 8px;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.3s;
        }

        .dot.active {
            width: 24px;
            border-radius: 4px;
            background: #10b981;
        }

        .nav-buttons {
            display: flex;
            gap: 12px;
        }

        .btn-skip {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #64748b;
            font-size: 14px;
            cursor: pointer;
            -webkit-appearance: none;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            touch-action: manipulation;
        }

        .btn-next {
            padding: 14px 28px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            -webkit-appearance: none;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            touch-action: manipulation;
        }

        .btn-next.finish {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        /* ==================== */
        /* SPLIT COSTS          */
        /* ==================== */
        .split-header {
            padding: 24px 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }

        .split-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .split-header-left h1 {
            font-family: 'Fraunces', serif;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .split-header-left p {
            font-size: 13px;
            color: var(--text-muted);
        }

        .split-balance-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .split-balance-card {
            background: var(--bg-accent);
            padding: 16px;
            border-radius: var(--radius);
            text-align: center;
        }

        .split-balance-card.owed {
            border-left: 4px solid var(--accent-green);
        }

        .split-balance-card.owe {
            border-left: 4px solid var(--accent-red);
        }

        .split-balance-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .split-balance-value {
            font-size: 20px;
            font-weight: 700;
        }

        .split-balance-card.owed .split-balance-value {
            color: var(--accent-green);
        }

        .split-balance-card.owe .split-balance-value {
            color: var(--accent-red);
        }

        .split-content {
            padding: 16px 20px;
            padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 20px);
        }

        .split-quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
        }

        .split-action-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 14px 8px;
            border-radius: var(--radius);
            border: none;
            font-family: 'DM Sans', sans-serif;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .split-action-btn span {
            font-size: 20px;
        }

        .split-action-btn.primary {
            background: linear-gradient(135deg, var(--accent-green), #16a34a);
            color: white;
        }

        .split-action-btn.secondary {
            background: var(--bg-accent);
            color: var(--text-primary);
        }

        .split-section {
            margin-bottom: 24px;
        }

        .split-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .split-section-title {
            font-size: 16px;
            font-weight: 700;
        }

        .split-add-btn {
            font-size: 13px;
            color: var(--accent-green);
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        .split-empty-state {
            text-align: center;
            padding: 32px 20px;
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .split-empty-icon {
            font-size: 40px;
            margin-bottom: 12px;
        }

        .split-empty-state p {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .split-empty-btn {
            background: var(--accent-green);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            cursor: pointer;
        }

        /* Friend Card */
        .split-friend-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 10px;
        }

        .split-friend-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-green), #16a34a);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            font-weight: 700;
        }

        .split-friend-info {
            flex: 1;
        }

        .split-friend-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
        }

        .split-friend-email {
            font-size: 12px;
            color: var(--text-muted);
        }

        .split-friend-balance {
            text-align: right;
        }

        .split-friend-balance-label {
            font-size: 10px;
            color: var(--text-muted);
        }

        .split-friend-balance-value {
            font-size: 15px;
            font-weight: 700;
        }

        .split-friend-balance-value.positive {
            color: var(--accent-green);
        }

        .split-friend-balance-value.negative {
            color: var(--accent-red);
        }

        .split-friend-balance-value.zero {
            color: var(--text-muted);
        }

        .split-friend-actions {
            display: flex;
            gap: 8px;
        }

        .split-friend-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .split-friend-action-btn.settle {
            background: var(--accent-green);
            color: white;
        }

        .split-friend-action-btn.delete {
            background: var(--accent-red-light);
            color: var(--accent-red);
        }

        /* Group Card */
        .split-group-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 12px;
            overflow: hidden;
        }

        .split-group-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            cursor: pointer;
        }

        .split-group-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-sm);
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .split-group-info {
            flex: 1;
        }

        .split-group-name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .split-group-members {
            font-size: 12px;
            color: var(--text-muted);
        }

        .split-group-balance {
            text-align: right;
        }

        .split-group-balance-value {
            font-size: 16px;
            font-weight: 700;
        }

        .split-group-balance-value.positive {
            color: var(--accent-green);
        }

        .split-group-balance-value.negative {
            color: var(--accent-red);
        }

        .split-group-expanded {
            border-top: 1px solid var(--border);
            padding: 12px 16px;
            background: var(--bg-accent);
        }

        .split-group-expense {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .split-group-expense:last-child {
            border-bottom: none;
        }

        .split-expense-icon {
            font-size: 24px;
        }

        .split-expense-info {
            flex: 1;
        }

        .split-expense-desc {
            font-weight: 600;
            font-size: 14px;
        }

        .split-expense-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        .split-expense-amount {
            font-weight: 700;
            font-size: 14px;
        }

        .split-group-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .split-group-action-btn {
            flex: 1;
            padding: 10px;
            border-radius: var(--radius-sm);
            border: none;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .split-group-action-btn.primary {
            background: var(--accent-green);
            color: white;
        }

        .split-group-action-btn.secondary {
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        /* Activity Item */
        .split-activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 8px;
        }

        .split-activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .split-activity-info {
            flex: 1;
        }

        .split-activity-text {
            font-size: 14px;
        }

        .split-activity-text strong {
            font-weight: 600;
        }

        .split-activity-date {
            font-size: 11px;
            color: var(--text-muted);
        }

        .split-activity-amount {
            font-weight: 700;
            font-size: 14px;
        }

        /* Settlement Item */
        .split-settlement-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 10px;
        }

        .split-settlement-avatars {
            display: flex;
            align-items: center;
        }

        .split-settlement-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-green), #16a34a);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            font-weight: 700;
            border: 2px solid var(--bg-card);
        }

        .split-settlement-avatar:nth-child(2) {
            margin-left: -12px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .split-settlement-arrow {
            margin: 0 8px;
            color: var(--text-muted);
        }

        .split-settlement-info {
            flex: 1;
        }

        .split-settlement-text {
            font-size: 14px;
        }

        .split-settlement-amount {
            font-weight: 700;
            font-size: 16px;
            color: var(--accent-red);
        }

        .split-settle-btn {
            background: var(--accent-green);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Split Modal Specific */
        .split-modal-section {
            margin-bottom: 20px;
        }

        .split-modal-section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-secondary);
        }

        .split-member-select {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .split-member-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--bg-accent);
            border-radius: 20px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .split-member-chip.selected {
            border-color: var(--accent-green);
            background: var(--accent-green-light);
        }

        .split-member-chip-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent-green);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            font-weight: 700;
        }

        .split-member-chip-name {
            font-size: 13px;
            font-weight: 500;
        }

        .split-method-options {
            display: flex;
            gap: 10px;
        }

        .split-method-option {
            flex: 1;
            padding: 12px;
            background: var(--bg-accent);
            border-radius: var(--radius-sm);
            border: 2px solid transparent;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }

        .split-method-option.active {
            border-color: var(--accent-green);
            background: var(--accent-green-light);
        }

        .split-method-option-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .split-method-option-label {
            font-size: 12px;
            font-weight: 600;
        }

        .split-custom-amounts {
            margin-top: 12px;
        }

        .split-custom-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .split-custom-name {
            flex: 1;
            font-size: 14px;
        }

        .split-custom-input {
            width: 100px;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            text-align: right;
        }

        /* ==================== */
        /* FINANCIAL HEALTH     */
        /* ==================== */
        .health-header {
            padding: 24px 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }

        .health-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .health-header-left h1 {
            font-family: 'Fraunces', serif;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .health-header-left p {
            font-size: 13px;
            color: var(--text-muted);
        }

        .health-score-container {
            display: flex;
            justify-content: center;
            padding: 20px 0;
        }

        .health-score-circle {
            position: relative;
            width: 200px;
            height: 200px;
        }

        .health-score-svg {
            transform: rotate(-90deg);
            width: 200px;
            height: 200px;
        }

        .health-score-bg {
            fill: none;
            stroke: var(--bg-accent);
            stroke-width: 12;
        }

        .health-score-progress {
            fill: none;
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease, stroke 0.5s ease;
        }

        .health-score-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .health-score-value {
            font-family: 'Fraunces', serif;
            font-size: 56px;
            font-weight: 700;
            line-height: 1;
        }

        .health-score-label {
            font-size: 14px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .health-score-status {
            text-align: center;
            padding: 16px;
            margin: 0 20px 20px;
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .health-score-status-text {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .health-score-status-desc {
            font-size: 13px;
            color: var(--text-muted);
        }

        .health-content {
            padding: 0 20px 120px;
        }

        .health-section {
            margin-bottom: 24px;
        }

        .health-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .health-metrics {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .health-metric-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow);
        }

        .health-metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .health-metric-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .health-metric-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .health-metric-icon.good { background: rgba(16, 185, 129, 0.15); }
        .health-metric-icon.warning { background: rgba(245, 158, 11, 0.15); }
        .health-metric-icon.bad { background: rgba(239, 68, 68, 0.15); }

        .health-metric-name {
            font-weight: 600;
            font-size: 14px;
        }

        .health-metric-value {
            font-family: 'Fraunces', serif;
            font-size: 20px;
            font-weight: 700;
        }

        .health-metric-value.good { color: #10b981; }
        .health-metric-value.warning { color: #f59e0b; }
        .health-metric-value.bad { color: #ef4444; }

        .health-metric-bar {
            height: 8px;
            background: var(--bg-accent);
            border-radius: 4px;
            overflow: hidden;
        }

        .health-metric-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .health-metric-bar-fill.good { background: linear-gradient(90deg, #10b981, #34d399); }
        .health-metric-bar-fill.warning { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .health-metric-bar-fill.bad { background: linear-gradient(90deg, #ef4444, #f87171); }

        .health-metric-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .health-tips {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .health-tip {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 14px 16px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .health-tip-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .health-tip-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .health-tip-text strong {
            color: var(--text-primary);
        }

        /* Theme: Ocean */
        .theme-ocean {
            --bg-primary: #f0f7fa;
            --bg-card: #ffffff;
            --bg-accent: #d6eaf5;
            --text-primary: #1a3a4a;
            --text-secondary: #4a7a9a;
            --text-muted: #7aaaca;
            --accent-green: #0077b6;
            --accent-green-light: #caf0f8;
            --border: #c0dae8;
        }

        /* Theme: Sunset */
        .theme-sunset {
            --bg-primary: #fdf6f0;
            --bg-card: #ffffff;
            --bg-accent: #fce8d8;
            --text-primary: #3d2314;
            --text-secondary: #8a5a4a;
            --text-muted: #b88a7a;
            --accent-green: #e07a5f;
            --accent-green-light: #fce8d8;
            --border: #f0d4c4;
        }

        /* Theme: Lavender */
        .theme-lavender {
            --bg-primary: #f8f5fc;
            --bg-card: #ffffff;
            --bg-accent: #ebe0f5;
            --text-primary: #2d1f3d;
            --text-secondary: #6a5a8a;
            --text-muted: #9a8aba;
            --accent-green: #7c3aed;
            --accent-green-light: #ede9fe;
            --border: #ddd0ea;
        }

        /* Theme: Rose */
        .theme-rose {
            --bg-primary: #fdf2f4;
            --bg-card: #ffffff;
            --bg-accent: #fce4e8;
            --text-primary: #3d1a24;
            --text-secondary: #8a4a5a;
            --text-muted: #ba7a8a;
            --accent-green: #e11d48;
            --accent-green-light: #ffe4e6;
            --border: #f0c4ca;
        }

        /* Theme: Forest */
        .theme-forest {
            --bg-primary: #f0f5f0;
            --bg-card: #ffffff;
            --bg-accent: #d8e8d8;
            --text-primary: #1a2e1a;
            --text-secondary: #4a6a4a;
            --text-muted: #7a9a7a;
            --accent-green: #166534;
            --accent-green-light: #dcfce7;
            --border: #c0d8c0;
        }

        /* Theme: Dark Mode */
        .theme-dark {
            --bg-primary: #111827;
            --bg-card: #1f2937;
            --bg-accent: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --accent-green: #10b981;
            --accent-green-light: rgba(16, 185, 129, 0.15);
            --accent-red: #f87171;
            --accent-red-light: rgba(248, 113, 113, 0.15);
            --border: #374151;
        }

        /* Financial Health Score Page */
        .health-header {
            padding: 24px 20px;
            background: var(--bg-card);
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .health-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .health-header h1 {
            font-family: 'Fraunces', serif;
            font-size: 24px;
            font-weight: 700;
        }

        .health-score-circle {
            width: 180px;
            height: 180px;
            margin: 0 auto 16px;
            position: relative;
        }

        .health-score-ring {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                var(--score-color, #10b981) calc(var(--score, 0) * 3.6deg),
                var(--bg-accent) 0deg
            );
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .health-score-ring::before {
            content: '';
            position: absolute;
            width: 140px;
            height: 140px;
            background: var(--bg-card);
            border-radius: 50%;
        }

        .health-score-value {
            position: relative;
            z-index: 1;
            font-family: 'Fraunces', serif;
            font-size: 48px;
            font-weight: 700;
            color: var(--score-color, #10b981);
        }

        .health-score-label {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .health-score-status {
            font-size: 18px;
            font-weight: 600;
            color: var(--score-color, #10b981);
        }

        .health-content {
            padding: 20px;
            padding-bottom: 120px;
        }

        .health-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .health-metrics {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .health-metric {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow);
        }

        .health-metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .health-metric-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .health-metric-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .health-metric-icon.green { background: var(--accent-green-light); }
        .health-metric-icon.red { background: var(--accent-red-light); }
        .health-metric-icon.blue { background: rgba(59, 130, 246, 0.15); }
        .health-metric-icon.purple { background: rgba(139, 92, 246, 0.15); }
        .health-metric-icon.orange { background: rgba(249, 115, 22, 0.15); }

        .health-metric-name {
            font-weight: 600;
            font-size: 14px;
        }

        .health-metric-value {
            font-family: 'Fraunces', serif;
            font-size: 18px;
            font-weight: 700;
        }

        .health-metric-value.good { color: #10b981; }
        .health-metric-value.warning { color: #f59e0b; }
        .health-metric-value.bad { color: #ef4444; }

        .health-metric-bar {
            height: 8px;
            background: var(--bg-accent);
            border-radius: 4px;
            overflow: hidden;
        }

        .health-metric-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .health-metric-bar-fill.good { background: linear-gradient(90deg, #10b981, #34d399); }
        .health-metric-bar-fill.warning { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .health-metric-bar-fill.bad { background: linear-gradient(90deg, #ef4444, #f87171); }

        .health-tips {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .health-tip {
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            padding: 14px 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            box-shadow: var(--shadow);
        }

        .health-tip-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .health-tip-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .health-tip-text strong {
            color: var(--text-primary);
        }
            --bg-accent: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --accent-green: #10b981;
            --accent-green-light: #064e3b;
            --accent-red: #f87171;
            --accent-red-light: #7f1d1d;
            --accent-blue: #60a5fa;
            --accent-orange: #fbbf24;
            --accent-purple: #a78bfa;
            --border: #374151;
            --shadow: 0 2px 12px rgba(0,0,0,0.3);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
        }

        .theme-dark .header {
            background: linear-gradient(180deg, var(--bg-card) 0%, var(--bg-primary) 100%);
        }

        .theme-dark .balance-card {
            background: linear-gradient(135deg, #065f46 0%, #064e3b 100%);
        }

        .theme-dark .debt-header,
        .theme-dark .wealth-header,
        .theme-dark .empire-header {
            background: var(--bg-card);
        }

        .theme-dark .wealth-summary-card.saved {
            background: linear-gradient(135deg, #065f46 0%, #064e3b 100%);
        }

        .theme-dark .wealth-summary-card.target {
            background: linear-gradient(135deg, #5b21b6 0%, #4c1d95 100%);
        }

        .theme-dark .modal {
            background: var(--bg-card);
        }

        .theme-dark .input-field {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--border);
        }

        .theme-dark .input-field:focus {
            border-color: var(--accent-green);
        }

        .theme-dark .transaction-item,
        .theme-dark .debt-card,
        .theme-dark .goal-card {
            background: var(--bg-card);
        }

        .theme-dark .transaction-icon.food { background: rgba(255,243,224,0.15); }
        .theme-dark .transaction-icon.transport { background: rgba(227,242,253,0.15); }
        .theme-dark .transaction-icon.shopping { background: rgba(252,228,236,0.15); }
        .theme-dark .transaction-icon.bills { background: rgba(243,229,245,0.15); }
        .theme-dark .transaction-icon.income { background: rgba(16,185,129,0.2); }
        .theme-dark .transaction-icon.entertainment { background: rgba(255,248,225,0.15); }
        .theme-dark .transaction-icon.health { background: rgba(232,245,233,0.15); }
        .theme-dark .transaction-icon.other { background: var(--bg-accent); }

        .theme-dark .bottom-nav {
            background: var(--bg-card);
            border-top-color: var(--border);
        }

        .theme-dark .toast {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        /* Dark mode toggle styles */
        .dark-mode-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
        }

        .dark-mode-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
        }

        .dark-mode-icon {
            font-size: 20px;
        }

        /* Global Header with Dark Mode Toggle */
        .global-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-greeting {
            font-size: 13px;
            color: var(--text-muted);
        }

        .user-name {
            font-family: 'Fraunces', serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dark-mode-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--bg-accent);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .lang-toggle-btn-small {
            min-width: 44px;
            height: 40px;
            border-radius: 20px;
            border: 2px solid var(--border);
            background: var(--bg-card);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 0 10px;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .lang-toggle-btn-small:active {
            transform: scale(0.95);
        }

        .lang-toggle-btn-small:hover {
            border-color: var(--accent-green);
        }

        .settings-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--bg-accent);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .settings-btn:active {
            transform: scale(0.9);
        }

        .header-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .dark-mode-btn:active {
            transform: scale(0.95);
        }

        /* Categories Section on Main Page */
        .categories-overview {
            padding: 0 20px;
            margin-bottom: 20px;
        }

        .categories-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 4px 0;
            -webkit-overflow-scrolling: touch;
        }

        .categories-scroll::-webkit-scrollbar {
            display: none;
        }

        .category-chip {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            min-width: 70px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow);
        }

        .category-chip:active {
            transform: scale(0.95);
        }

        .category-chip.selected {
            border-color: var(--accent-green);
            background: var(--accent-green-light);
        }

        .category-chip-icon {
            font-size: 24px;
        }

        .category-chip-name {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .category-chip-amount {
            font-size: 11px;
            font-weight: 700;
            color: var(--accent-red);
        }

        /* Simplified Balance Display */
        .balance-overview {
            padding: 20px;
            text-align: center;
        }

        .balance-main {
            margin-bottom: 20px;
        }

        .balance-main-label {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .balance-main-value {
            font-family: 'Fraunces', serif;
            font-size: 40px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .balance-row {
            display: flex;
            justify-content: center;
            gap: 32px;
        }

        .balance-item {
            text-align: center;
        }

        .balance-item-value {
            font-size: 18px;
            font-weight: 700;
        }

        .balance-item-value.income {
            color: var(--accent-green);
        }

        .balance-item-value.expense {
            color: var(--accent-red);
        }

        .balance-item-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Quick Add Buttons */
        .quick-add-row {
            display: flex;
            gap: 10px;
            padding: 0 20px;
            margin-bottom: 20px;
        }

        .quick-add-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px;
            border-radius: var(--radius-sm);
            border: none;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-add-btn.income {
            background: var(--accent-green);
            color: white;
        }

        .quick-add-btn.expense {
            background: var(--accent-red);
            color: white;
        }

        .quick-add-btn:active {
            transform: scale(0.97);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* Remove tap delay on all elements */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* Fast taps for all interactive elements */
        button, a, input, select, textarea, .nav-item, .category-item, 
        .debt-type-item, .goal-type-item, .empire-type-item, .subscription-type-item,
        .schedule-option, .billing-option, .theme-option, .currency-option,
        .transaction-item, .debt-card, .goal-card, .recurring-item, .empire-item {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            cursor: pointer;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            /* Ensure body allows fast taps */
            touch-action: manipulation;
        }

        .app {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            background: var(--bg-primary);
            overflow: hidden;
            padding-top: var(--safe-top);
        }

        /* Desktop layout - center all content */
        @media (min-width: 768px) {
            .app {
                max-width: 800px;
                margin: 0 auto;
                border-left: 1px solid var(--border);
                border-right: 1px solid var(--border);
                box-shadow: 0 0 40px rgba(0,0,0,0.1);
            }
            
            .balance-main-value {
                font-size: 56px;
            }
            
            .logo {
                font-size: 28px;
            }
            
            .transaction-item {
                padding: 16px;
            }
            
            .debt-card, .goal-card {
                padding: 20px;
            }
        }
        
        /* Large desktop - wider container */
        @media (min-width: 1200px) {
            .app {
                max-width: 900px;
            }
            
            .balance-main-value {
                font-size: 64px;
            }
            
            .logo {
                font-size: 32px;
            }
        }

        /* Header */
        .header {
            padding: 20px 20px 0;
            background: linear-gradient(180deg, #fff 0%, var(--bg-primary) 100%);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .logo {
            font-family: 'Fraunces', serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-green);
            letter-spacing: -0.5px;
        }

        .date-display {
            font-size: 13px;
            color: var(--text-secondary);
            background: var(--bg-card);
            padding: 8px 14px;
            border-radius: 20px;
            border: 1px solid var(--border);
        }

        /* Balance Card */
        .balance-card {
            background: var(--accent-green);
            border-radius: var(--radius);
            padding: 28px 24px;
            margin: 0 20px 20px;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -30%;
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.08);
            border-radius: 50%;
        }

        .balance-card::after {
            content: '';
            position: absolute;
            bottom: -40%;
            left: -20%;
            width: 150px;
            height: 150px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
        }

        .balance-label {
            font-size: 13px;
            opacity: 0.85;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .balance-amount {
            font-family: 'Fraunces', serif;
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 20px;
            letter-spacing: -1px;
        }

        .balance-stats {
            display: flex;
            gap: 24px;
            position: relative;
            z-index: 1;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .stat-icon.income {
            background: rgba(255,255,255,0.2);
        }

        .stat-icon.expense {
            background: rgba(255,255,255,0.2);
        }

        .stat-info {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.75;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 600;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
            padding: 0 20px;
            margin-bottom: 24px;
        }

        .action-btn {
            flex: 1;
            padding: 14px;
            border-radius: var(--radius-sm);
            border: none;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .action-btn.income {
            background: var(--accent-green-light);
            color: var(--accent-green);
        }

        .action-btn.expense {
            background: var(--accent-red-light);
            color: var(--accent-red);
        }

        .action-btn:active {
            transform: scale(0.97);
        }

        /* Chart Section */
        .chart-section {
            background: var(--bg-card);
            margin: 0 20px 20px;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
        }

        .period-selector {
            display: flex;
            gap: 4px;
            background: var(--bg-accent);
            padding: 4px;
            border-radius: 8px;
        }

        .period-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            font-family: 'DM Sans', sans-serif;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .period-btn.active {
            background: var(--bg-card);
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .chart-container {
            height: 160px;
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 8px;
            padding: 10px 0;
        }

        .chart-bar-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .chart-bar {
            width: 100%;
            max-width: 32px;
            border-radius: 6px 6px 4px 4px;
            background: var(--bg-accent);
            position: relative;
            min-height: 8px;
            transition: all 0.3s ease;
        }

        .chart-bar.has-expense::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--accent-red);
            opacity: 0.7;
            border-radius: 0 0 4px 4px;
        }

        .chart-bar.active {
            background: var(--accent-green);
        }

        .chart-label {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Categories */
        .categories-section {
            padding: 0 20px;
            margin-bottom: 20px;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 14px;
        }

        .category-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 8px;
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .category-item:active {
            transform: scale(0.95);
            background: var(--bg-accent);
        }

        .category-item.selected {
            border-color: var(--accent-green);
            background: var(--accent-green-light);
        }

        .category-icon {
            font-size: 22px;
        }

        .category-name {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
            text-align: center;
        }

        /* Transactions */
        .transactions-section {
            flex: 1;
            background: var(--bg-card);
            border-radius: var(--radius) var(--radius) 0 0;
            padding: 20px 20px 100px;
            margin-top: 10px;
        }

        .transaction-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .transaction-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }

        .transaction-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .transaction-icon.food { background: #fff3e0; }
        .transaction-icon.transport { background: #e3f2fd; }
        .transaction-icon.shopping { background: #fce4ec; }
        .transaction-icon.bills { background: #f3e5f5; }
        .transaction-icon.income { background: var(--accent-green-light); }
        .transaction-icon.entertainment { background: #fff8e1; }
        .transaction-icon.health { background: #e8f5e9; }
        .transaction-icon.other { background: var(--bg-accent); }

        .transaction-details {
            flex: 1;
            min-width: 0;
        }

        .transaction-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .transaction-category {
            font-size: 12px;
            color: var(--text-muted);
        }

        .transaction-amount {
            font-size: 15px;
            font-weight: 600;
            text-align: right;
        }

        .transaction-amount.expense {
            color: var(--accent-red);
        }

        .transaction-amount.income {
            color: var(--accent-green);
        }

        .transaction-time {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .transaction-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .transaction-actions {
            display: flex;
            gap: 6px;
        }

        .transaction-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--bg-accent);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .transaction-action-btn:active {
            transform: scale(0.9);
        }

        .transaction-action-btn.edit {
            color: var(--text-secondary);
        }

        .transaction-action-btn.delete {
            color: var(--accent-red);
        }

        .transaction-action-btn.delete:active {
            background: var(--accent-red-light);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 14px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        /* Hide bottom nav when modal is open */
        body.modal-open .bottom-nav {
            transform: translateY(100%) !important;
            pointer-events: none !important;
            opacity: 0 !important;
        }

        .modal {
            background: var(--bg-card);
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            border-radius: var(--radius) var(--radius) 0 0;
            padding: 20px;
            padding-bottom: calc(30px + env(safe-area-inset-bottom, 20px));
            transform: translateY(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 auto;
            position: relative;
            z-index: 10001;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-handle {
            width: 40px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 0 auto 16px;
            flex-shrink: 0;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .modal-header .modal-title {
            margin-bottom: 0;
            flex: 1;
        }

        .modal-close-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--bg-accent);
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            touch-action: manipulation;
        }

        .modal-close-btn:active {
            transform: scale(0.95);
            background: var(--border);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .modal-cancel-btn {
            flex: 1;
            padding: 14px;
            border: 2px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .modal-cancel-btn:active {
            background: var(--bg-accent);
        }

        .modal-save-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            -webkit-appearance: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .modal-save-btn.expense {
            background: var(--accent-red);
        }

        .modal-save-btn.income {
            background: var(--accent-green);
        }

        .modal-save-btn:active {
            transform: scale(0.98);
        }

        .modal-title {
            font-family: 'Fraunces', serif;
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 24px;
            text-align: center;
        }

        .input-group {
            margin-bottom: 16px;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .input-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .input-field {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: 'DM Sans', sans-serif;
            font-size: 16px;
            transition: border-color 0.2s ease;
            background: var(--bg-primary);
            -webkit-appearance: none;
            appearance: none;
            line-height: 1.4;
            min-height: 48px;
            color: var(--text-primary);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .input-field::placeholder {
            color: var(--text-muted);
            opacity: 1;
        }

        /* Fix for iOS date inputs */
        input[type="date"].input-field {
            min-height: 48px;
            line-height: 48px;
            padding: 0 16px;
        }

        /* Prevent iOS zoom on input focus */
        @supports (-webkit-touch-callout: none) {
            .input-field,
            .amount-input,
            select,
            textarea {
                font-size: 16px !important;
            }
        }

        .amount-input-wrapper {
            position: relative;
        }

        .currency-symbol {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .amount-input {
            padding-left: 36px;
            font-size: 24px;
            font-weight: 600;
        }

        .modal-categories {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 24px;
        }

        .submit-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: 'DM Sans', sans-serif;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .submit-btn.income {
            background: var(--accent-green);
            color: white;
        }

        .submit-btn.expense {
            background: var(--accent-red);
            color: white;
        }

        .submit-btn:active {
            transform: scale(0.98);
        }

        /* Settings Modal */
        .settings-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .settings-btn:active {
            background: var(--bg-accent);
        }

        .budget-input-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .budget-input-row .input-field {
            flex: 1;
        }

        .reset-btn {
            padding: 14px 20px;
            background: var(--accent-red-light);
            color: var(--accent-red);
            border: none;
            border-radius: var(--radius-sm);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-primary);
            color: white;
            padding: 14px 24px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 200;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Swipe to delete */
        .transaction-item {
            position: relative;
            overflow: hidden;
        }

        .delete-hint {
            font-size: 11px;
            color: var(--text-muted);
            text-align: center;
            margin-top: 16px;
        }

        /* Budget Progress Bar */
        .budget-progress {
            margin: 0 20px 20px;
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 16px 20px;
            box-shadow: var(--shadow);
        }

        .budget-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .budget-progress-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .budget-progress-amount {
            font-size: 13px;
            font-weight: 600;
        }

        .progress-bar {
            height: 10px;
            background: var(--bg-accent);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-green);
            border-radius: 5px;
            transition: width 0.5s ease, background 0.3s ease;
        }

        .progress-fill.warning {
            background: var(--accent-orange);
        }

        .progress-fill.danger {
            background: var(--accent-red);
        }

        /* Insights Section */
        .insights-section {
            margin: 0 20px 20px;
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 14px;
        }

        .insight-card {
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            padding: 14px;
            text-align: center;
        }

        .insight-value {
            font-family: 'Fraunces', serif;
            font-size: 22px;
            font-weight: 700;
            color: var(--accent-green);
            margin-bottom: 4px;
        }

        .insight-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Theme Picker */
        .theme-picker {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .theme-option {
            aspect-ratio: 1;
            border-radius: 12px;
            border: 3px solid transparent;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .theme-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50%;
        }

        .theme-option::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .theme-option.active {
            border-color: var(--accent-green);
            transform: scale(1.05);
        }

        .theme-option.th-sage::before { background: #2d6a4f; }
        .theme-option.th-sage::after { background: #faf8f5; }
        .theme-option.th-ocean::before { background: #0077b6; }
        .theme-option.th-ocean::after { background: #f0f7fa; }
        .theme-option.th-sunset::before { background: #e07a5f; }
        .theme-option.th-sunset::after { background: #fdf6f0; }
        .theme-option.th-lavender::before { background: #7c3aed; }
        .theme-option.th-lavender::after { background: #f8f5fc; }
        .theme-option.th-midnight::before { background: #22d3ee; }
        .theme-option.th-midnight::after { background: #0f172a; }
        .theme-option.th-rose::before { background: #e11d48; }
        .theme-option.th-rose::after { background: #fdf2f4; }
        .theme-option.th-forest::before { background: #166534; }
        .theme-option.th-forest::after { background: #f0f5f0; }

        /* Currency Selector */
        .currency-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .currency-option {
            padding: 12px 8px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 600;
        }

        .currency-option.active {
            border-color: var(--accent-green);
            background: var(--accent-green-light);
        }

        /* Language Grid */
        .language-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .language-option {
            padding: 16px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .language-option:hover {
            border-color: var(--accent-green);
        }

        .language-option.active {
            border-color: var(--accent-green);
            background: var(--accent-green-light);
        }

        .language-flag {
            font-size: 32px;
        }

        .language-name {
            font-size: 14px;
            font-weight: 600;
        }

        /* RTL Support for Arabic */
        [dir="rtl"] {
            text-align: right;
        }

        [dir="rtl"] .balance-row,
        [dir="rtl"] .quick-add-row,
        [dir="rtl"] .transaction-item,
        [dir="rtl"] .modal-header {
            flex-direction: row-reverse;
        }

        [dir="rtl"] .transaction-info {
            text-align: right;
        }

        [dir="rtl"] .transaction-amount {
            text-align: left;
        }

        /* Custom Category Modal */
        .custom-category-input {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .emoji-picker-btn {
            width: 52px;
            height: 52px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 6px;
            margin-bottom: 16px;
            max-height: 150px;
            overflow-y: auto;
            padding: 10px;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
        }

        .emoji-option {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .emoji-option:hover {
            background: var(--bg-accent);
        }

        /* Export Button */
        .export-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px;
            background: var(--bg-accent);
            color: var(--text-primary);
            border: none;
            border-radius: var(--radius-sm);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 12px;
        }

        /* Tab Navigation for Settings */
        .settings-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-accent);
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .settings-tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .settings-tab.active {
            background: var(--bg-card);
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .settings-panel {
            display: none;
        }

        .settings-panel.active {
            display: block;
        }

        .setting-section {
            margin-bottom: 24px;
        }

        .setting-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Recurring Transaction Badge */
        .recurring-badge {
            font-size: 10px;
            background: var(--accent-blue);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
        }

        .recurring-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
        }

        .toggle-switch {
            width: 50px;
            height: 28px;
            background: var(--border);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: var(--accent-green);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .toggle-switch.active::after {
            transform: translateX(22px);
        }

        .frequency-selector {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .frequency-selector.show {
            display: grid;
        }

        .frequency-option {
            padding: 10px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            text-align: center;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .frequency-option.active {
            border-color: var(--accent-green);
            background: var(--accent-green-light);
        }

        /* Search & Filter */
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            background: var(--bg-card);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .filter-btn {
            padding: 12px 16px;
            background: var(--bg-accent);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 16px;
            cursor: pointer;
        }

        /* Bottom Navigation */
        /* Hide old bottom nav */
        .bottom-nav {
            display: none !important;
        }

        /* Floating Menu Button */
        .floating-menu-btn {
            position: fixed;
            bottom: calc(20px + var(--safe-bottom));
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent-green);
            border: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease, background 0.3s ease;
        }

        .floating-menu-btn:hover {
            transform: scale(1.05);
        }

        .floating-menu-btn.active {
            background: var(--accent-red);
            transform: rotate(90deg);
        }

        .menu-icon {
            font-size: 28px;
            color: white;
            line-height: 1;
        }

        /* RTL positioning */
        [dir="rtl"] .floating-menu-btn {
            right: auto;
            left: 20px;
        }

        [dir="rtl"] .floating-menu {
            right: auto;
            left: 20px;
        }

        /* Floating Menu Overlay */
        .floating-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9996;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .floating-menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Floating Menu Panel */
        .floating-menu {
            position: fixed;
            bottom: calc(90px + var(--safe-bottom));
            right: 20px;
            width: 280px;
            max-width: calc(100vw - 40px);
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 9997;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px) scale(0.95);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .floating-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .floating-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .floating-menu-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .floating-menu-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-primary);
            border: none;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }

        .floating-menu-items {
            padding: 8px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .floating-menu-item {
            display: flex;
            align-items: center;
            gap: 14px;
            width: 100%;
            padding: 14px 16px;
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background 0.2s ease;
            text-align: start;
        }

        .floating-menu-item:hover {
            background: var(--bg-primary);
        }

        .floating-menu-item.active {
            background: var(--accent-green-light);
        }

        .floating-menu-item.active .floating-menu-label {
            color: var(--accent-green);
            font-weight: 600;
        }

        .floating-menu-icon {
            font-size: 24px;
            width: 32px;
            text-align: center;
            flex-shrink: 0;
        }

        .floating-menu-label {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: visible;
        }

        /* Desktop positioning */
        @media (min-width: 768px) {
            .floating-menu-btn {
                bottom: 30px;
                right: calc(50% - 400px + 20px);
            }
            
            .floating-menu {
                bottom: 100px;
                right: calc(50% - 400px + 20px);
            }

            [dir="rtl"] .floating-menu-btn {
                right: auto;
                left: calc(50% - 400px + 20px);
            }

            [dir="rtl"] .floating-menu {
                right: auto;
                left: calc(50% - 400px + 20px);
            }
        }

        .nav-inner {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            max-width: 600px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            padding: 6px 10px;
            flex: 1;
            min-width: 0;
            max-width: 80px;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.2s ease;
            -webkit-appearance: none;
            touch-action: manipulation;
        }

        .nav-item.active {
            color: var(--accent-green);
        }

        .nav-icon {
            font-size: 22px;
            line-height: 1;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* Page Container */
        .page {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding-bottom: calc(100px + var(--safe-bottom));
        }

        .page.active {
            display: flex;
        }

        /* ================================================
           MODERN 3D CAROUSEL NAVIGATION SYSTEM
           ================================================ */
        
        .carousel-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(180deg, #0c0c14 0%, #1a1a2e 50%, #0f0f1a 100%);
            z-index: 9999;
            display: none;
        }

        .carousel-container.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Animated background particles */
        .carousel-bg-glow {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }
        
        .carousel-bg-glow::before {
            content: '';
            position: absolute;
            top: 20%;
            left: 50%;
            width: 500px;
            height: 500px;
            transform: translateX(-50%);
            background: radial-gradient(circle, rgba(34, 197, 94, 0.15) 0%, transparent 70%);
            animation: float1 8s ease-in-out infinite;
        }
        
        .carousel-bg-glow::after {
            content: '';
            position: absolute;
            bottom: 20%;
            left: 30%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
            animation: float2 10s ease-in-out infinite;
        }
        
        @keyframes float1 {
            0%, 100% { transform: translateX(-50%) translateY(0) scale(1); }
            50% { transform: translateX(-50%) translateY(-30px) scale(1.1); }
        }
        
        @keyframes float2 {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(20px) scale(1.05); }
        }

        .carousel-scene {
            position: relative;
            width: 100%;
            height: 70vh;
            max-height: 550px;
            perspective: 1200px;
            perspective-origin: 50% 50%;
            z-index: 1;
        }

        .carousel-track {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            transform-style: preserve-3d;
            transition: transform 0.7s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .carousel-track.dragging {
            transition: none;
        }

        .carousel-page {
            position: absolute;
            width: 260px;
            height: 420px;
            left: 50%;
            top: 50%;
            margin-left: -130px;
            margin-top: -210px;
            background: linear-gradient(165deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(255, 255, 255, 0.02) 50%,
                rgba(0, 0, 0, 0.2) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 28px;
            overflow: hidden;
            transform-style: preserve-3d;
            backface-visibility: hidden;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            cursor: pointer;
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.05) inset;
        }

        .carousel-page::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.4) 50%, 
                transparent 100%);
        }
        
        .carousel-page::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, 
                rgba(255, 255, 255, 0.08) 0%, 
                transparent 40%);
            pointer-events: none;
            border-radius: 28px;
        }

        .carousel-page.active {
            transform: translateZ(80px) scale(1.08) !important;
            border-color: rgba(34, 197, 94, 0.4);
            box-shadow: 
                0 35px 70px -15px rgba(0, 0, 0, 0.6),
                0 0 80px -20px rgba(34, 197, 94, 0.4),
                0 0 0 1px rgba(34, 197, 94, 0.2) inset;
        }
        
        .carousel-page.active::before {
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(34, 197, 94, 0.6) 50%, 
                transparent 100%);
        }

        .carousel-page:not(.active) {
            filter: brightness(0.5) saturate(0.7);
            opacity: 0.6;
        }
        
        .carousel-page.adjacent {
            filter: brightness(0.7) saturate(0.85);
            opacity: 0.8;
        }

        /* Page Preview Content */
        .carousel-page-preview {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 24px 20px;
            position: relative;
            z-index: 1;
        }

        .carousel-page-preview-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .carousel-page-preview-icon {
            font-size: 38px;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.4));
            animation: iconFloat 3s ease-in-out infinite;
        }
        
        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        .carousel-page-preview-title {
            font-size: 17px;
            font-weight: 700;
            color: #fff;
            letter-spacing: -0.3px;
        }

        .carousel-page-preview-subtitle {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .carousel-page-content {
            flex: 1;
            overflow: hidden;
        }

        /* Preview Stats */
        .carousel-preview-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .carousel-preview-stat {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 16px 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .carousel-preview-stat-value {
            font-size: 22px;
            font-weight: 700;
            color: #22c55e;
            letter-spacing: -0.5px;
        }
        
        .carousel-preview-stat-label {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .carousel-preview-list {
            margin-top: 14px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .carousel-preview-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.04);
        }
        
        .carousel-preview-item-icon {
            font-size: 16px;
        }

        /* Navigation Dots */
        .carousel-dots {
            position: fixed;
            bottom: calc(40px + var(--safe-bottom));
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 10001;
            padding: 14px 24px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.25);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            border: none;
            padding: 0;
        }

        .carousel-dot:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.3);
        }

        .carousel-dot.active {
            width: 24px;
            border-radius: 10px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }

        /* Toggle Button - Bottom Left */
        .carousel-toggle-btn {
            position: fixed;
            bottom: calc(24px + var(--safe-bottom));
            left: 20px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 9998;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .carousel-toggle-btn:hover {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.4);
            transform: scale(1.05);
        }
        
        /* RTL Support */
        [dir="rtl"] .carousel-toggle-btn {
            left: auto;
            right: 20px;
        }

        /* Swipe Hint */
        .carousel-swipe-hint {
            position: fixed;
            bottom: calc(110px + var(--safe-bottom));
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            opacity: 0;
            animation: fadeInHint 0.5s ease 0.5s forwards;
            z-index: 10001;
        }

        @keyframes fadeInHint {
            to { opacity: 1; }
        }

        .carousel-swipe-hint::before {
            content: '';
            animation: swipeLeft 2s ease-in-out infinite;
        }
        
        .carousel-swipe-hint::after {
            content: '';
            animation: swipeRight 2s ease-in-out infinite;
        }

        @keyframes swipeLeft {
            0%, 100% { transform: translateX(0); opacity: 0.4; }
            50% { transform: translateX(-8px); opacity: 1; }
        }
        
        @keyframes swipeRight {
            0%, 100% { transform: translateX(0); opacity: 0.4; }
            50% { transform: translateX(8px); opacity: 1; }
        }

        /* Page Title Below Active Card */
        .carousel-active-title {
            position: fixed;
            bottom: calc(160px + var(--safe-bottom));
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 10001;
            opacity: 0;
            animation: fadeIn 0.5s ease 0.3s forwards;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .carousel-active-title-text {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            letter-spacing: -0.5px;
        }
        
        .carousel-active-title-sub {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 4px;
        }

        /* Hide normal UI when carousel is active */
        .carousel-mode .floating-menu-btn,
        .carousel-mode .floating-menu,
        .carousel-mode .floating-menu-overlay {
            display: none !important;
        }
        
        .carousel-mode .app > .page {
            display: none !important;
        }
        
        /* Reflection effect */
        .carousel-reflection {
            position: absolute;
            bottom: -50%;
            left: 0;
            width: 100%;
            height: 50%;
            background: linear-gradient(to bottom, 
                rgba(255,255,255,0.03) 0%, 
                transparent 100%);
            transform: scaleY(-1);
            opacity: 0.3;
            pointer-events: none;
            mask-image: linear-gradient(to bottom, black 0%, transparent 50%);
            -webkit-mask-image: linear-gradient(to bottom, black 0%, transparent 50%);
        }

        /* Debt Crusher Styles */
        .debt-header {
            padding: 24px 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }

        .debt-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .debt-header-left h1 {
            font-family: 'Fraunces', serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .debt-header-left p {
            font-size: 13px;
            color: var(--text-muted);
        }

        .debt-free-badge {
            background: var(--accent-green-light);
            color: var(--accent-green);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .debt-summary-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .debt-summary-card {
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            padding: 16px;
        }

        .debt-summary-card.total {
            background: linear-gradient(135deg, var(--accent-green) 0%, #1e5631 100%);
            color: white;
        }

        .debt-summary-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
            margin-bottom: 6px;
        }

        .debt-summary-value {
            font-family: 'Fraunces', serif;
            font-size: 24px;
            font-weight: 700;
        }

        .debt-summary-card:not(.total) .debt-summary-value {
            color: var(--accent-green);
        }

        /* Empty State - Start Here */
        .debt-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 40px;
            text-align: center;
        }

        .debt-empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .debt-empty-title {
            font-family: 'Fraunces', serif;
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .debt-empty-text {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .start-here-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px 32px;
            background: var(--accent-green);
            color: white;
            border: none;
            border-radius: 30px;
            font-family: 'DM Sans', sans-serif;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(45, 106, 79, 0.3);
            transition: all 0.3s ease;
        }

        .start-here-btn:hover {
            transform: scale(1.05);
        }

        .start-here-btn:active {
            transform: scale(0.98);
        }

        /* Debt List */
        .debt-content {
            flex: 1;
            padding: 20px;
            padding-bottom: 100px;
            overflow-y: auto;
        }

        .debt-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .debt-section-title {
            font-size: 16px;
            font-weight: 600;
        }

        .add-debt-text-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--accent-green-light);
            color: var(--accent-green);
            border: none;
            border-radius: 20px;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-debt-text-btn:active {
            transform: scale(0.95);
        }

        .debt-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--accent-green);
        }

        .debt-card.paid-off {
            border-left-color: #22c55e;
            opacity: 0.7;
        }

        .debt-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .debt-card-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .debt-card-icon {
            width: 44px;
            height: 44px;
            background: var(--bg-accent);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .debt-card-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
        }

        .debt-card-type {
            font-size: 12px;
            color: var(--text-muted);
        }

        .debt-card-balance {
            text-align: right;
        }

        .debt-card-balance-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .debt-card-balance-value {
            font-family: 'Fraunces', serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .debt-card-progress {
            margin-bottom: 12px;
        }

        .debt-progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .debt-progress-paid {
            color: var(--accent-green);
            font-weight: 600;
        }

        .debt-progress-percent {
            color: var(--text-muted);
        }

        .debt-progress-track {
            height: 8px;
            background: var(--bg-accent);
            border-radius: 4px;
            overflow: hidden;
        }

        .debt-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green) 0%, #4ade80 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .debt-card-footer {
            display: flex;
            gap: 8px;
        }

        .debt-action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            touch-action: manipulation;
        }

        .debt-action-btn.primary {
            background: var(--accent-green);
            color: white;
            flex: 1;
        }

        .debt-action-btn.secondary {
            background: var(--bg-accent);
            color: var(--text-secondary);
            flex: 1;
        }

        .debt-action-btn.danger {
            background: var(--accent-red-light);
            color: var(--accent-red);
            padding: 10px 12px;
        }

        .debt-action-btn:active {
            transform: scale(0.97);
        }

        .goal-action-btn.danger {
            background: var(--accent-red-light);
            color: var(--accent-red);
            padding: 10px 12px;
        }

        /* Auto-pay badge */
        .auto-pay-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            background: var(--accent-blue);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        /* Strategy Pills */
        .strategy-pills {
            display: flex;
            gap: 8px;
            padding: 0 20px;
            margin-bottom: 16px;
            overflow-x: auto;
        }

        .strategy-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 25px;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .strategy-pill.active {
            border-color: var(--accent-green);
            background: var(--accent-green-light);
            color: var(--accent-green);
        }

        .strategy-pill-icon {
            font-size: 16px;
        }

        /* Quick Stats Bar */
        .quick-stats-bar {
            display: flex;
            gap: 16px;
            padding: 12px 20px;
            background: var(--bg-accent);
            margin-bottom: 16px;
            overflow-x: auto;
        }

        .quick-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .quick-stat-icon {
            font-size: 18px;
        }

        .quick-stat-text {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .quick-stat-value {
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Celebration Modal */
        .celebration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }

        .celebration-overlay.active {
            display: flex;
        }

        .celebration-content {
            text-align: center;
            color: white;
            padding: 40px;
        }

        .celebration-emoji {
            font-size: 80px;
            animation: celebrate 0.5s ease infinite alternate;
        }

        @keyframes celebrate {
            from { transform: scale(1) rotate(-5deg); }
            to { transform: scale(1.1) rotate(5deg); }
        }

        .celebration-title {
            font-family: 'Fraunces', serif;
            font-size: 28px;
            margin: 20px 0 10px;
        }

        .celebration-text {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 24px;
        }

        .celebration-btn {
            padding: 14px 32px;
            background: white;
            color: var(--accent-green);
            border: none;
            border-radius: 25px;
            font-family: 'DM Sans', sans-serif;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ff6b9d;
            animation: confetti-fall 3s ease-out forwards;
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* Auto-pay Schedule Selector */
        .schedule-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .schedule-option {
            padding: 14px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .schedule-option.active {
            border-color: var(--accent-green);
            background: var(--accent-green-light);
        }

        .schedule-option-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .schedule-option-desc {
            font-size: 11px;
            color: var(--text-muted);
        }

        .custom-schedule-row {
            display: none;
            gap: 10px;
            margin-bottom: 16px;
        }

        .custom-schedule-row.show {
            display: flex;
        }

        .custom-schedule-row input {
            flex: 1;
        }

        .custom-schedule-row select {
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            background: var(--bg-primary);
        }

        /* Debt Type Selector Improved */
        .debt-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .debt-type-item {
            padding: 16px 10px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .debt-type-item.active {
            border-color: var(--accent-green);
            background: var(--accent-green-light);
        }

        .debt-type-item-icon {
            font-size: 28px;
            margin-bottom: 6px;
        }

        .debt-type-item-label {
            font-size: 12px;
            font-weight: 600;
        }

        /* Next payment info */
        .next-payment-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: var(--accent-blue);
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border-radius: var(--radius-sm);
            margin-top: 8px;
            font-size: 12px;
        }

        .next-payment-info-icon {
            font-size: 16px;
        }

        /* Wealth Builder Styles */
        .wealth-header {
            padding: 24px 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }

        .wealth-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .wealth-header-left h1 {
            font-family: 'Fraunces', serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .wealth-header-left p {
            font-size: 13px;
            color: var(--text-muted);
        }

        .wealth-summary-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .wealth-summary-card {
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            padding: 16px;
        }

        .wealth-summary-card.saved {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }

        .wealth-summary-card.target {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            color: white;
        }

        .wealth-summary-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.85;
            margin-bottom: 6px;
        }

        .wealth-summary-value {
            font-family: 'Fraunces', serif;
            font-size: 24px;
            font-weight: 700;
        }

        /* Goals Empty State */
        .goals-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 40px;
            text-align: center;
        }

        .goals-empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .goals-empty-title {
            font-family: 'Fraunces', serif;
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .goals-empty-text {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .start-saving-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px 32px;
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            border: none;
            border-radius: 30px;
            font-family: 'DM Sans', sans-serif;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(5, 150, 105, 0.3);
            transition: all 0.3s ease;
        }

        .start-saving-btn:hover {
            transform: scale(1.05);
        }

        /* Goals Content */
        .goals-content {
            flex: 1;
            padding: 20px;
            padding-bottom: 100px;
            overflow-y: auto;
        }

        .goals-quick-stats {
            display: flex;
            gap: 16px;
            padding: 12px 20px;
            background: var(--bg-accent);
            margin-bottom: 16px;
            overflow-x: auto;
        }

        .goals-quick-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .goals-quick-stat-icon {
            font-size: 18px;
        }

        .goals-quick-stat-text {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .goals-quick-stat-value {
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Goal Cards */
        .goal-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            border-left: 4px solid #059669;
        }

        .goal-card.completed {
            border-left-color: #fbbf24;
            background: linear-gradient(90deg, rgba(251,191,36,0.08) 0%, var(--bg-card) 100%);
        }

        .goal-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .goal-card-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .goal-card-icon {
            width: 44px;
            height: 44px;
            background: var(--bg-accent);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .goal-card-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
        }

        .goal-card-due {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .goal-card-amounts {
            text-align: right;
        }

        .goal-card-saved {
            font-family: 'Fraunces', serif;
            font-size: 20px;
            font-weight: 700;
            color: #059669;
        }

        .goal-card-target {
            font-size: 12px;
            color: var(--text-muted);
        }

        .goal-card-progress {
            margin-bottom: 12px;
        }

        .goal-progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .goal-progress-remaining {
            color: var(--text-muted);
        }

        .goal-progress-percent {
            color: #059669;
            font-weight: 600;
        }

        .goal-progress-track {
            height: 10px;
            background: var(--bg-accent);
            border-radius: 5px;
            overflow: hidden;
        }

        .goal-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #059669 0%, #34d399 100%);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .goal-card.completed .goal-progress-bar {
            background: linear-gradient(90deg, #fbbf24 0%, #fcd34d 100%);
        }

        .goal-card-footer {
            display: flex;
            gap: 8px;
        }

        .goal-action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .goal-action-btn.primary {
            background: #059669;
            color: white;
        }

        .goal-action-btn.secondary {
            background: var(--bg-accent);
            color: var(--text-secondary);
        }

        .goal-action-btn:active {
            transform: scale(0.97);
        }

        /* Auto-save badge */
        .auto-save-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            background: #7c3aed;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        /* Next deposit info */
        .next-deposit-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            color: white;
            border-radius: var(--radius-sm);
            margin-top: 8px;
            font-size: 12px;
        }

        /* Goal Type Grid */
        .goal-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .goal-type-item {
            padding: 16px 10px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .goal-type-item.active {
            border-color: #059669;
            background: rgba(5, 150, 105, 0.1);
        }

        .goal-type-item-icon {
            font-size: 28px;
            margin-bottom: 6px;
        }

        .goal-type-item-label {
            font-size: 12px;
            font-weight: 600;
        }

        /* Celebration for goals */
        .goal-celebration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }

        .goal-celebration-overlay.active {
            display: flex;
        }

        .goal-celebration-content {
            text-align: center;
            color: white;
            padding: 40px;
        }

        .goal-celebration-emoji {
            font-size: 80px;
            animation: celebrate 0.5s ease infinite alternate;
        }

        .goal-celebration-title {
            font-family: 'Fraunces', serif;
            font-size: 28px;
            margin: 20px 0 10px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .goal-celebration-text {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 24px;
        }

        /* Empire (Net Worth) Styles */
        .empire-header {
            padding: 24px 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }

        .empire-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .empire-header-left h1 {
            font-family: 'Fraunces', serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .empire-header-left p {
            font-size: 13px;
            color: var(--text-muted);
        }

        .net-worth-display {
            text-align: center;
            padding: 24px 20px;
            background: var(--bg-primary);
            margin: 0 20px;
            border-radius: var(--radius);
        }

        .net-worth-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .net-worth-value {
            font-family: 'Fraunces', serif;
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .net-worth-value.positive {
            color: #10b981;
        }

        .net-worth-value.negative {
            color: #ef4444;
        }

        .net-worth-bar {
            height: 12px;
            background: var(--bg-accent);
            border-radius: 6px;
            overflow: hidden;
            display: flex;
        }

        .net-worth-bar-assets {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
            transition: width 0.5s ease;
        }

        .net-worth-bar-liabilities {
            height: 100%;
            background: linear-gradient(90deg, #f87171 0%, #ef4444 100%);
            transition: width 0.5s ease;
        }

        .net-worth-bar-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
        }

        .net-worth-bar-labels .assets-label {
            color: #10b981;
            font-weight: 600;
        }

        .net-worth-bar-labels .liabilities-label {
            color: #ef4444;
            font-weight: 600;
        }

        /* Empire Content */
        .empire-content {
            flex: 1;
            padding: 20px;
            padding-bottom: 100px;
            overflow-y: auto;
        }

        .empire-section {
            margin-bottom: 24px;
        }

        .empire-section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .empire-section-icon {
            font-size: 20px;
        }

        .empire-section-title {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .empire-section-title.assets {
            color: #10b981;
        }

        .empire-section-title.liabilities {
            color: #ef4444;
        }

        .empire-add-btn {
            margin-left: auto;
            padding: 6px 12px;
            border: none;
            border-radius: 15px;
            font-family: 'DM Sans', sans-serif;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .empire-add-btn.assets {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .empire-add-btn.liabilities {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .empire-list {
            background: var(--bg-card);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .empire-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .empire-item:last-child {
            border-bottom: none;
        }

        .empire-item:active {
            background: var(--bg-accent);
        }

        .empire-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 12px;
        }

        .empire-item-icon.asset {
            background: rgba(16, 185, 129, 0.15);
        }

        .empire-item-icon.liability {
            background: rgba(239, 68, 68, 0.15);
        }

        .empire-item-info {
            flex: 1;
        }

        .empire-item-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .empire-item-category {
            font-size: 11px;
            color: var(--text-muted);
        }

        .empire-item-value {
            font-family: 'Fraunces', serif;
            font-size: 16px;
            font-weight: 700;
        }

        .empire-item-value.asset {
            color: #10b981;
        }

        .empire-item-value.liability {
            color: #ef4444;
        }

        .empire-item-actions {
            display: flex;
            gap: 6px;
            margin-left: 10px;
        }

        .empire-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-appearance: none;
            touch-action: manipulation;
        }

        .empire-action-btn.edit {
            background: var(--bg-accent);
            color: var(--text-secondary);
        }

        .empire-action-btn.delete {
            background: var(--accent-red-light);
            color: var(--accent-red);
        }

        .empire-section-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: var(--bg-accent);
            border-radius: 0 0 var(--radius) var(--radius);
            margin-top: -1px;
        }

        .empire-total-label {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .empire-total-label.assets {
            color: #10b981;
        }

        .empire-total-label.liabilities {
            color: #ef4444;
        }

        .empire-total-value {
            font-family: 'Fraunces', serif;
            font-size: 20px;
            font-weight: 700;
        }

        .empire-total-value.assets {
            color: #10b981;
        }

        .empire-total-value.liabilities {
            color: #ef4444;
        }

        /* Empire Empty State */
        .empire-empty {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-muted);
        }

        .empire-empty-icon {
            font-size: 32px;
            margin-bottom: 8px;
            opacity: 0.5;
        }

        .empire-empty-text {
            font-size: 13px;
        }

        /* Asset/Liability Type Grid */
        .empire-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .empire-type-item {
            padding: 14px 8px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .empire-type-item.active.asset {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .empire-type-item.active.liability {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .empire-type-item-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .empire-type-item-label {
            font-size: 11px;
            font-weight: 600;
        }

        /* Quick Stats */
        .empire-quick-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 16px 20px;
        }

        .empire-stat {
            text-align: center;
            padding: 12px;
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow);
        }

        .empire-stat-value {
            font-family: 'Fraunces', serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-green);
        }

        .empire-stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Settings Page Styles */
        .settings-page-content {
            padding: 20px;
            padding-bottom: 100px;
            overflow-y: auto;
        }

        /* Recurring Subscriptions Page */
        .recurring-page {
            background: var(--bg-primary);
            min-height: 100vh;
        }

        .recurring-header {
            padding: 24px 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }

        .recurring-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .recurring-header-left h1 {
            font-family: 'Fraunces', serif;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .recurring-header-left p {
            font-size: 13px;
            color: var(--text-muted);
        }

        .recurring-totals {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .recurring-total-card {
            padding: 20px;
            border-radius: var(--radius);
            text-align: center;
        }

        .recurring-total-card.monthly {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }

        .recurring-total-card.yearly {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }

        .recurring-total-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .recurring-total-value {
            font-family: 'Fraunces', serif;
            font-size: 32px;
            font-weight: 700;
        }

        .recurring-content {
            padding: 20px;
            padding-bottom: 120px;
        }

        .recurring-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .recurring-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .recurring-item {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease;
        }

        .recurring-item:active {
            transform: scale(0.98);
        }

        .recurring-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: var(--accent-green-light);
            flex-shrink: 0;
        }

        .recurring-item-icon.streaming { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .recurring-item-icon.music { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
        .recurring-item-icon.fitness { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .recurring-item-icon.shopping { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .recurring-item-icon.cloud { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .recurring-item-icon.gaming { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .recurring-item-icon.phone { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); }
        .recurring-item-icon.vpn { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
        .recurring-item-icon.other { background: linear-gradient(135deg, #64748b 0%, #475569 100%); }

        .recurring-item-details {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .recurring-item-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .recurring-item-meta {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .recurring-item-cycle {
            background: var(--bg-accent);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .recurring-item-amounts {
            text-align: right;
            flex-shrink: 0;
            min-width: 60px;
        }

        .recurring-item-monthly {
            font-family: 'Fraunces', serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .recurring-item-yearly {
            font-size: 11px;
            color: var(--accent-red);
            font-weight: 600;
        }

        .recurring-item-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex-shrink: 0;
        }

        .recurring-item-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: var(--bg-accent);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .recurring-item-action-btn:hover {
            background: var(--border);
        }

        .recurring-item-action-btn.delete {
            color: var(--accent-red);
        }

        .recurring-empty {
            text-align: center;
            padding: 60px 20px;
            background: var(--bg-card);
            border-radius: var(--radius);
        }

        .recurring-empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .recurring-empty-title {
            font-family: 'Fraunces', serif;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .recurring-empty-text {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        .add-subscription-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 16px;
            margin-top: 20px;
            background: linear-gradient(135deg, var(--accent-green) 0%, #047857 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
            transition: all 0.2s ease;
        }

        .add-subscription-btn:active {
            transform: scale(0.98);
        }

        /* Summary Stats Row */
        .recurring-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .recurring-stat {
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            padding: 10px 8px;
            text-align: center;
        }

        .recurring-stat-value {
            font-family: 'Fraunces', serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-green);
        }

        .recurring-stat-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Subscription type grid */
        .subscription-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .subscription-type-item {
            padding: 8px 4px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 56px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }

        .subscription-type-item.active {
            border-color: var(--accent-green);
            background: var(--accent-green-light);
        }

        .subscription-type-item-icon {
            font-size: 18px;
            line-height: 1;
        }

        .subscription-type-item-label {
            font-size: 9px;
            font-weight: 600;
            color: var(--text-secondary);
            line-height: 1.2;
            white-space: nowrap;
        }

        .billing-cycle-options {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .billing-cycle-option {
            flex: 1;
            padding: 12px 8px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .billing-cycle-option.active {
            border-color: var(--accent-green);
            background: var(--accent-green-light);
            color: var(--accent-green);
        }

        /* Upcoming bills highlight */
        .recurring-item.due-soon .recurring-item-icon {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .due-badge {
            background: var(--accent-red);
            color: white;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 700;
        }

        .example-badge {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 700;
            margin-left: 6px;
        }

        .example-item {
            position: relative;
            border: 1px dashed rgba(139, 92, 246, 0.4);
        }

        /* ==================== */
        /* SPLIT COST STYLES    */
        /* ==================== */
        
        .split-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }
        
        .split-btn:active {
            transform: scale(0.95);
        }

        .split-header {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            padding: 24px 20px;
            color: white;
            padding-top: calc(24px + var(--safe-top));
        }

        .split-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .split-header-left h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .split-header-left p {
            font-size: 14px;
            opacity: 0.9;
        }

        .split-balance-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .split-balance-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
        }

        .split-balance-card.owed {
            border-left: 3px solid #22c55e;
        }

        .split-balance-card.owe {
            border-left: 3px solid #ef4444;
        }

        .split-balance-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .split-balance-value {
            font-size: 24px;
            font-weight: 700;
        }

        .split-content {
            padding: 20px;
            padding-bottom: calc(100px + var(--safe-bottom));
        }

        .split-quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
        }

        .split-action-btn {
            flex: 1;
            padding: 12px 8px;
            border: none;
            border-radius: var(--radius);
            font-family: 'DM Sans', sans-serif;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
        }

        .split-action-btn span {
            font-size: 20px;
        }

        .split-action-btn.primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .split-action-btn.secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            box-shadow: var(--shadow);
        }

        .split-action-btn:active {
            transform: scale(0.97);
        }

        .split-section {
            margin-bottom: 24px;
        }

        .split-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .split-section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .split-add-btn {
            padding: 6px 12px;
            background: var(--accent-green-light);
            color: var(--accent-green);
            border: none;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .split-empty-state {
            text-align: center;
            padding: 24px;
            background: var(--bg-card);
            border-radius: var(--radius);
        }

        .split-empty-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .split-empty-state p {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 12px;
        }

        .split-empty-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .split-friend-item, .split-group-item {
            display: flex;
            align-items: center;
            padding: 14px;
            background: var(--bg-card);
            border-radius: var(--radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .split-friend-item:active, .split-group-item:active {
            transform: scale(0.98);
        }

        .split-friend-avatar, .split-group-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            margin-right: 12px;
        }

        .split-friend-info, .split-group-info {
            flex: 1;
        }

        .split-friend-name, .split-group-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .split-friend-balance, .split-group-balance {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .split-friend-balance.positive, .split-group-balance.positive {
            color: var(--accent-green);
        }

        .split-friend-balance.negative, .split-group-balance.negative {
            color: var(--accent-red);
        }

        .split-friend-amount, .split-group-amount {
            font-size: 16px;
            font-weight: 700;
        }

        .split-friend-amount.positive, .split-group-amount.positive {
            color: var(--accent-green);
        }

        .split-friend-amount.negative, .split-group-amount.negative {
            color: var(--accent-red);
        }

        .split-activity-item {
            display: flex;
            align-items: center;
            padding: 14px;
            background: var(--bg-card);
            border-radius: var(--radius);
            margin-bottom: 8px;
        }

        .split-activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--bg-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-right: 12px;
        }

        .split-activity-info {
            flex: 1;
        }

        .split-activity-desc {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .split-activity-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .split-activity-amount {
            font-size: 15px;
            font-weight: 700;
        }

        .split-settlement-item {
            display: flex;
            align-items: center;
            padding: 14px;
            background: var(--bg-card);
            border-radius: var(--radius);
            margin-bottom: 8px;
        }

        .split-settlement-info {
            flex: 1;
        }

        .split-settlement-text {
            font-size: 14px;
            color: var(--text-primary);
        }

        .split-settlement-text strong {
            font-weight: 700;
        }

        .settle-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--accent-green) 0%, #047857 100%);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .split-icon-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }

        .split-icon-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .split-icon-item.active {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }

        .split-members-select {
            max-height: 200px;
            overflow-y: auto;
        }

        .split-member-checkbox {
            display: flex;
            align-items: center;
            padding: 10px;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
            cursor: pointer;
        }

        .split-member-checkbox input {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }

        .split-member-checkbox label {
            font-size: 14px;
            cursor: pointer;
        }

        .split-method-options {
            display: flex;
            gap: 8px;
        }

        .split-method-option {
            flex: 1;
            padding: 12px 8px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            text-align: center;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
        }

        .split-method-option span {
            font-size: 18px;
        }

        .split-method-option.active {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
        }

        .split-amount-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .split-amount-row label {
            flex: 1;
            font-size: 14px;
        }

        .split-amount-row input {
            width: 100px;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .settle-up-info {
            text-align: center;
            padding: 20px;
            background: var(--bg-accent);
            border-radius: var(--radius);
            margin-bottom: 16px;
        }

        .settle-up-info .amount {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent-red);
        }

        .settle-up-info .text {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .group-detail-content {
            padding: 10px 0;
        }

        .group-detail-balance {
            text-align: center;
            padding: 16px;
            background: var(--bg-accent);
            border-radius: var(--radius);
            margin-bottom: 16px;
        }

        .group-detail-members {
            margin-bottom: 16px;
        }

        .group-detail-member {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        .group-detail-expenses {
            margin-bottom: 16px;
        }

        .group-expense-item {
            padding: 12px;
            background: var(--bg-accent);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }

        .split-friend-actions {
            display: flex;
            gap: 8px;
        }

        .split-friend-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .split-friend-action-btn.delete {
            background: var(--accent-red-light);
            color: var(--accent-red);
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            padding-left: 4px;
        }

        .settings-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow);
        }

        .settings-card .input-group {
            margin-bottom: 0;
        }

        .settings-card .custom-category-input {
            margin-bottom: 0;
        }

        /* ==================== */
        /* RESPONSIVE / MOBILE  */
        /* ==================== */
        
        /* Small phones (iPhone SE, etc.) */
        @media (max-width: 375px) {
            .nav-item {
                padding: 4px 4px;
                min-width: 44px;
            }
            
            .nav-icon {
                font-size: 18px;
            }
            
            .nav-label {
                font-size: 8px;
            }
            
            .balance-main-value {
                font-size: 32px;
            }
            
            .modal {
                padding: 14px;
                padding-bottom: calc(14px + env(safe-area-inset-bottom, 20px));
            }
            
            .modal-categories {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }
            
            .category-item {
                padding: 8px 4px;
            }
            
            .category-icon {
                font-size: 20px;
            }
            
            .category-name {
                font-size: 9px;
            }
            
            .transaction-item {
                padding: 10px;
            }
            
            .debt-card,
            .goal-card {
                padding: 12px;
            }
            
            .subscription-type-grid {
                gap: 6px;
            }
            
            .subscription-type-item {
                padding: 8px 4px;
                min-height: 50px;
            }
            
            .subscription-type-item-icon {
                font-size: 16px;
            }
            
            .subscription-type-item-label {
                font-size: 8px;
            }
            
            .recurring-item {
                padding: 10px;
                gap: 8px;
            }
            
            .recurring-item-icon {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
            
            .recurring-item-name {
                font-size: 13px;
            }
            
            .recurring-item-monthly {
                font-size: 14px;
            }
            
            .recurring-item-action-btn {
                width: 24px;
                height: 24px;
                font-size: 10px;
            }
            
            .recurring-stats {
                gap: 6px;
            }
            
            .recurring-stat {
                padding: 8px 6px;
            }
            
            .recurring-stat-value {
                font-size: 14px;
            }
        }
        
        /* Medium phones */
        @media (min-width: 376px) and (max-width: 430px) {
            .nav-item {
                padding: 6px 6px;
                min-width: 48px;
            }
            
            .nav-icon {
                font-size: 20px;
            }
            
            .nav-label {
                font-size: 9px;
            }
        }
        
        /* Tablets and desktop - nav stays centered */
        @media (min-width: 431px) {
            .nav-inner {
                max-width: 500px;
            }
            
            .nav-icon {
                font-size: 24px;
            }
            
            .nav-label {
                font-size: 11px;
            }
        }
        
        /* Large screens - bigger nav */
        @media (min-width: 768px) {
            .nav-inner {
                max-width: 600px;
            }
            
            .nav-item {
                padding: 8px 16px;
                gap: 4px;
            }
            
            .nav-icon {
                font-size: 26px;
            }
            
            .nav-label {
                font-size: 12px;
            }
        }
        
        /* Fix for phones with notch (iPhone X+) */
        @supports (padding-top: env(safe-area-inset-top)) {
            .bottom-nav {
                padding-bottom: calc(8px + env(safe-area-inset-bottom));
            }
            
            .modal {
                padding-bottom: calc(20px + env(safe-area-inset-bottom));
            }
            
            .onboarding .nav-container {
                padding-bottom: calc(24px + env(safe-area-inset-bottom));
            }
        }
        
        /* Landscape mode fixes */
        @media (max-height: 500px) and (orientation: landscape) {
            .bottom-nav {
                padding: 4px 4px;
                padding-bottom: calc(4px + env(safe-area-inset-bottom, 0px));
                min-height: 50px;
            }
            
            .nav-icon {
                font-size: 18px;
            }
            
            .nav-label {
                display: none;
            }
            
            .modal {
                max-height: 80vh;
            }
            
            .slide-icon {
                font-size: 48px;
                margin-bottom: 12px;
            }
            
            .slide-title {
                font-size: 22px;
            }
            
            .page {
                padding-bottom: 60px;
            }
        }
        
        /* Dark mode bottom nav */
        .theme-dark .bottom-nav {
            background: #1f2937;
            border-top-color: #374151;
        }
    </style>
</head>
<body>
    <!-- ONBOARDING -->
    <div class="onboarding" id="onboarding">
        <div class="slides-container">
            <!-- Language Selection Slide (NEW - First Slide) -->
            <div class="slide active" id="slide-lang">
                <div class="slide-icon"></div>
                <h1 class="slide-title">Choose Language<br><span> </span></h1>
                <p class="slide-text">Select your preferred language</p>
                <div class="language-select-onboarding">
                    <button class="lang-select-btn" onclick="selectOnboardingLanguage('en')">
                        <span class="lang-select-flag"></span>
                        <span class="lang-select-name">English</span>
                    </button>
                    <button class="lang-select-btn" onclick="selectOnboardingLanguage('ar-funny')">
                        <span class="lang-select-flag"></span>
                        <span class="lang-select-name"></span>
                    </button>
                </div>
            </div>

            <div class="slide" id="slide-0">
                <div class="slide-icon"></div>
                <h1 class="slide-title" id="welcomeTitle">Welcome to<br><span>CashFlow Pro</span></h1>
                <p class="slide-text" id="welcomeText">Your all-in-one personal finance companion. Take control of your money today.</p>
            </div>

            <div class="slide" id="slide-1">
                <div class="slide-icon"></div>
                <h1 class="slide-title" id="trackTitle">Track Everything</h1>
                <p class="slide-text" id="trackText">Log income and expenses in seconds with beautiful insights.</p>
                <div class="slide-features">
                    <div class="slide-feature" id="trackFeature1"> Quick transaction entry</div>
                    <div class="slide-feature" id="trackFeature2"> Smart categories</div>
                    <div class="slide-feature" id="trackFeature3"> Monthly reports</div>
                </div>
            </div>

            <div class="slide" id="slide-2">
                <div class="slide-icon"></div>
                <h1 class="slide-title" id="debtTitle">Crush Your Debts</h1>
                <p class="slide-text" id="debtText">Use proven strategies to become debt-free faster.</p>
                <div class="slide-features">
                    <div class="slide-feature" id="debtFeature1"> Avalanche & Snowball methods</div>
                    <div class="slide-feature" id="debtFeature2"> Auto-payment tracking</div>
                    <div class="slide-feature" id="debtFeature3"> Progress celebrations</div>
                </div>
            </div>

            <div class="slide" id="slide-3">
                <div class="slide-icon"></div>
                <h1 class="slide-title" id="empireTitle">Build Your Empire</h1>
                <p class="slide-text" id="empireText">Set goals, track net worth, and watch your wealth grow.</p>
                <div class="slide-features">
                    <div class="slide-feature" id="empireFeature1"> Savings goals</div>
                    <div class="slide-feature" id="empireFeature2"> Net worth tracking</div>
                    <div class="slide-feature" id="empireFeature3"> Financial health score</div>
                </div>
            </div>

            <div class="slide" id="slide-4">
                <div class="slide-icon"></div>
                <h1 class="slide-title" id="letsGoTitle">Let's Go!</h1>
                <p class="slide-text" id="letsGoText">What should we call you?</p>
                <input type="text" class="name-input" id="nameInput" placeholder="Enter your name">
            </div>
        </div>

        <div class="nav-container">
            <div class="dots">
                <div class="dot active" data-slide="lang" onclick="if(window.showOnboardingSlide)window.showOnboardingSlide('lang')"></div>
                <div class="dot" data-slide="0" onclick="if(window.showOnboardingSlide)window.showOnboardingSlide(0)"></div>
                <div class="dot" data-slide="1" onclick="if(window.showOnboardingSlide)window.showOnboardingSlide(1)"></div>
                <div class="dot" data-slide="2" onclick="if(window.showOnboardingSlide)window.showOnboardingSlide(2)"></div>
                <div class="dot" data-slide="3" onclick="if(window.showOnboardingSlide)window.showOnboardingSlide(3)"></div>
                <div class="dot" data-slide="4" onclick="if(window.showOnboardingSlide)window.showOnboardingSlide(4)"></div>
            </div>
            <div class="nav-buttons">
                <button type="button" class="btn-skip" id="btnSkip" onclick="window.skipOnboarding && window.skipOnboarding()">Skip</button>
                <button type="button" class="btn-next" id="btnNext" onclick="window.nextOnboardingSlide && window.nextOnboardingSlide()">Next </button>
            </div>
        </div>
    </div>
    <script>
        // Check if already completed - hide onboarding
        if (localStorage.getItem('pocketflow_welcomed') === 'true') {
            document.getElementById('onboarding').classList.add('hidden');
        }
    </script>

    <div class="app">
        <!-- 3D Carousel Navigation -->
        <div class="carousel-container" id="carouselContainer">
            <div class="carousel-bg-glow"></div>
            <div class="carousel-scene">
                <div class="carousel-track" id="carouselTrack">
                    <!-- Carousel pages will be generated by JavaScript -->
                </div>
            </div>
            <div class="carousel-active-title" id="carouselActiveTitle">
                <div class="carousel-active-title-text" id="carouselActiveTitleText">Cash Flow</div>
                <div class="carousel-active-title-sub">Tap card to open</div>
            </div>
            <div class="carousel-swipe-hint" id="carouselHint">Swipe to navigate</div>
            <div class="carousel-dots" id="carouselDots"></div>
        </div>
        
        <button class="carousel-toggle-btn" id="carouselToggleBtn" onclick="toggleCarouselMode()">
            <span id="carouselToggleIcon"></span>
        </button>

        <!-- Cash Flow Page -->
        <div class="page active" id="page-cashflow">
            <!-- Global Header -->
            <div class="global-header">
                <div class="header-left">
                    <div>
                        <div class="user-greeting" id="greetingText">Good morning,</div>
                        <div class="user-name" id="userName">Friend</div>
                    </div>
                </div>
                <div class="header-right header-buttons">
                    <button class="lang-toggle-btn-small" onclick="window.toggleLanguageQuick && window.toggleLanguageQuick()" id="langToggle"><span class="lang-flag"></span><span class="lang-text"></span></button>
                    <button class="split-btn" onclick="window.switchPage && window.switchPage('split')" title="Split Costs"></button>
                    <button class="settings-btn" onclick="window.switchPage && window.switchPage('settings')" title="Settings"></button>
                    <button class="dark-mode-btn" onclick="window.toggleDarkMode && window.toggleDarkMode()" id="darkModeBtn1"></button>
                </div>
            </div>

            <!-- Balance Overview -->
            <div class="balance-overview">
                <div class="balance-main">
                    <div class="balance-main-label" id="balanceMainLabel"> This Month's Balance</div>
                    <div class="balance-main-value" id="balance">$0.00</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;" id="balanceSubLabel">Income minus Expenses</div>
                </div>
                <div class="balance-row">
                    <div class="balance-item">
                        <div class="balance-item-value income" id="totalIncome">$0</div>
                        <div class="balance-item-label" id="totalIncomeLabel"> Total Income</div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-item-value expense" id="totalExpense">$0</div>
                        <div class="balance-item-label" id="totalExpenseLabel"> Total Spent</div>
                    </div>
                </div>
            </div>

            <!-- Quick Add Buttons -->
            <div class="quick-add-row">
                <button class="quick-add-btn income" onclick="window.openModal && window.openModal('income')" style="-webkit-appearance: none; touch-action: manipulation;">
                    <span>+</span> Add Income
                </button>
                <button class="quick-add-btn expense" onclick="window.openModal && window.openModal('expense')" style="-webkit-appearance: none; touch-action: manipulation;">
                    <span></span> Add Expense
                </button>
            </div>

            <!-- Categories Overview -->
            <div class="categories-overview">
                <div class="section-header">
                    <h2 class="section-title"> Spending by Category</h2>
                </div>
                <div class="categories-scroll" id="categoriesScroll"></div>
            </div>

            <!-- Transactions Section -->
            <section class="transactions-section" style="margin-top: 0; border-radius: var(--radius) var(--radius) 0 0;">
                <div class="section-header">
                    <h2 class="section-title"> Recent Transactions</h2>
                    <span class="date-display" id="currentDate"></span>
                </div>
                <div class="search-bar">
                    <input type="text" class="search-input" id="searchInput" placeholder=" Search transactions...">
                </div>
                <div class="transaction-list" id="transactionList"></div>
                <p class="delete-hint" id="deleteHint" style="display: none;">Tap a transaction to delete it</p>
            </section>
        </div>
        <!-- End Cash Flow Page -->

        <!-- Debt Crusher Page -->
        <div class="page" id="page-debt">
            <div class="debt-header">
                <div class="debt-header-top">
                    <div class="debt-header-left">
                        <h1 id="debtPageTitle">Debt Crusher</h1>
                        <p id="debtPageSubtitle">Track and eliminate your debts</p>
                    </div>
                    <div class="header-buttons">
                        <button class="lang-toggle-btn-small" onclick="window.toggleLanguageQuick && window.toggleLanguageQuick()" id="langToggle"><span class="lang-flag"></span><span class="lang-text"></span></button>
                        <button class="settings-btn" onclick="window.switchPage && window.switchPage('settings')" title="Settings"></button>
                        <button class="dark-mode-btn" onclick="window.toggleDarkMode && window.toggleDarkMode()" id="darkModeBtn2"></button>
                    </div>
                </div>
                <div class="debt-summary-cards">
                    <div class="debt-summary-card total">
                        <div class="debt-summary-label" id="debtTotalLabel">Total Remaining</div>
                        <div class="debt-summary-value" id="totalDebt">$0</div>
                    </div>
                    <div class="debt-summary-card">
                        <div class="debt-summary-label" id="debtPaidLabel">Total Paid Off</div>
                        <div class="debt-summary-value" id="totalPaidAmount">$0</div>
                    </div>
                </div>
            </div>

            <div class="quick-stats-bar" id="quickStatsBar" style="display: none;">
                <div class="quick-stat">
                    <span class="quick-stat-icon"></span>
                    <span class="quick-stat-text"><span class="quick-stat-value" id="debtsPaidOff">0</span> paid off</span>
                </div>
                <div class="quick-stat">
                    <span class="quick-stat-icon"></span>
                    <span class="quick-stat-text"><span class="quick-stat-value" id="avgProgress">0%</span> progress</span>
                </div>
                <div class="quick-stat">
                    <span class="quick-stat-icon"></span>
                    <span class="quick-stat-text"><span class="quick-stat-value" id="nextAutoPayment">-</span></span>
                </div>
            </div>

            <div class="strategy-pills" id="strategyPills" style="display: none;">
                <div class="strategy-pill active" data-strategy="avalanche" onclick="selectStrategy('avalanche')">
                    <span class="strategy-pill-icon"></span>
                    Avalanche (High Interest)
                </div>
                <div class="strategy-pill" data-strategy="snowball" onclick="selectStrategy('snowball')">
                    <span class="strategy-pill-icon"></span>
                    Snowball (Low Balance)
                </div>
            </div>

            <div class="debt-content">
                <!-- Empty State -->
                <div class="debt-empty-state" id="debtEmptyState">
                    <div class="debt-empty-icon"></div>
                    <h2 class="debt-empty-title">Start Crushing Your Debt</h2>
                    <p class="debt-empty-text">Track credit cards, loans, and mortgages.<br>See your payoff progress and become debt-free!</p>
                    <button class="start-here-btn" onclick="openDebtModal()" style="-webkit-appearance: none; touch-action: manipulation;">
                        <span></span> Add Your First Debt
                    </button>
                </div>

                <!-- Debt List (hidden when empty) -->
                <div id="debtListContainer" style="display: none;">
                    <div class="debt-section-header">
                        <h2 class="debt-section-title"> Your Debts</h2>
                        <button class="add-debt-text-btn" onclick="openDebtModal()" style="-webkit-appearance: none; touch-action: manipulation;">
                            <span>+</span> Add Debt
                        </button>
                    </div>
                    <div id="debtList"></div>
                </div>
            </div>
        </div>
        <!-- End Debt Crusher Page -->

        <!-- Wealth Builder Page -->
        <div class="page" id="page-wealth">
            <div class="wealth-header">
                <div class="wealth-header-top">
                    <div class="wealth-header-left">
                        <h1 id="wealthPageTitle"> Savings Goals</h1>
                        <p id="wealthPageSubtitle">Save for what matters most</p>
                    </div>
                    <div class="header-buttons">
                        <button class="lang-toggle-btn-small" onclick="window.toggleLanguageQuick && window.toggleLanguageQuick()" id="langToggle"><span class="lang-flag"></span><span class="lang-text"></span></button>
                        <button class="settings-btn" onclick="window.switchPage && window.switchPage('settings')" title="Settings"></button>
                        <button class="dark-mode-btn" onclick="window.toggleDarkMode && window.toggleDarkMode()" id="darkModeBtn3"></button>
                    </div>
                </div>
                <div class="wealth-summary-cards">
                    <div class="wealth-summary-card saved">
                        <div class="wealth-summary-label" id="wealthSavedLabel"> Total Saved</div>
                        <div class="wealth-summary-value" id="totalSaved">$0</div>
                    </div>
                    <div class="wealth-summary-card target">
                        <div class="wealth-summary-label" id="wealthTargetLabel"> Goal Amount</div>
                        <div class="wealth-summary-value" id="totalTarget">$0</div>
                    </div>
                </div>
            </div>

            <div class="goals-quick-stats" id="goalsQuickStats" style="display: none;">
                <div class="goals-quick-stat">
                    <span class="goals-quick-stat-icon"></span>
                    <span class="goals-quick-stat-text"><span class="goals-quick-stat-value" id="goalsCompleted">0</span> completed</span>
                </div>
                <div class="goals-quick-stat">
                    <span class="goals-quick-stat-icon"></span>
                    <span class="goals-quick-stat-text"><span class="goals-quick-stat-value" id="goalsProgress">0%</span> overall</span>
                </div>
                <div class="goals-quick-stat">
                    <span class="goals-quick-stat-icon"></span>
                    <span class="goals-quick-stat-text"><span class="goals-quick-stat-value" id="goalsRemaining">$0</span> to go</span>
                </div>
            </div>

            <div class="goals-content">
                <!-- Empty State -->
                <div class="goals-empty-state" id="goalsEmptyState">
                    <div class="goals-empty-icon"></div>
                    <h2 class="goals-empty-title">Start Building Wealth</h2>
                    <p class="goals-empty-text">Set savings goals for your dreams,<br>track progress, and automate your savings!</p>
                    <button class="start-saving-btn" onclick="window.openGoalModal && window.openGoalModal()">
                        <span></span> Create Your First Goal
                    </button>
                </div>

                <!-- Goals List -->
                <div id="goalsListContainer" style="display: none;">
                    <div class="debt-section-header">
                        <h2 class="debt-section-title">Your Goals</h2>
                        <button class="add-debt-text-btn" onclick="window.openGoalModal && window.openGoalModal()" style="background: rgba(5,150,105,0.15); color: #059669;">
                            <span>+</span> Add Goal
                        </button>
                    </div>
                    <div id="goalsList"></div>
                </div>
            </div>
        </div>
        <!-- End Wealth Builder Page -->

        <!-- Empire (Net Worth) Page -->
        <div class="page" id="page-empire">
            <div class="empire-header">
                <div class="empire-header-top">
                    <div class="empire-header-left">
                        <h1 id="empirePageTitle">Empire</h1>
                        <p id="empirePageSubtitle">Track your net worth</p>
                    </div>
                    <div class="header-buttons">
                        <button class="lang-toggle-btn-small" onclick="window.toggleLanguageQuick && window.toggleLanguageQuick()" id="langToggle"><span class="lang-flag"></span><span class="lang-text"></span></button>
                        <button class="settings-btn" onclick="window.switchPage && window.switchPage('settings')" title="Settings"></button>
                        <button class="dark-mode-btn" onclick="window.toggleDarkMode && window.toggleDarkMode()" id="darkModeBtn4"></button>
                    </div>
                </div>
            </div>

            <div class="net-worth-display">
                <div class="net-worth-label" id="netWorthLabel">Net Worth</div>
                <div class="net-worth-value positive" id="netWorthValue">$0</div>
                <div class="net-worth-bar">
                    <div class="net-worth-bar-assets" id="assetsBar" style="width: 50%"></div>
                    <div class="net-worth-bar-liabilities" id="liabilitiesBar" style="width: 50%"></div>
                </div>
                <div class="net-worth-bar-labels">
                    <span class="assets-label" id="assetsBarLabel">$0 Assets</span>
                    <span class="liabilities-label" id="liabilitiesBarLabel">$0 Liabilities</span>
                </div>
            </div>

            <div class="empire-quick-stats">
                <div class="empire-stat">
                    <div class="empire-stat-value" id="assetCount">0</div>
                    <div class="empire-stat-label" id="assetCountLabel">Assets</div>
                </div>
                <div class="empire-stat">
                    <div class="empire-stat-value" id="liabilityCount">0</div>
                    <div class="empire-stat-label">Liabilities</div>
                </div>
                <div class="empire-stat">
                    <div class="empire-stat-value" id="wealthRatio">0%</div>
                    <div class="empire-stat-label">Wealth Ratio</div>
                </div>
            </div>

            <div class="empire-content">
                <!-- Assets Section -->
                <div class="empire-section">
                    <div class="empire-section-header">
                        <span class="empire-section-icon"></span>
                        <span class="empire-section-title assets">Assets</span>
                        <button class="empire-add-btn assets" onclick="window.openEmpireModal && window.openEmpireModal('asset')">+ Add</button>
                    </div>
                    <div class="empire-list" id="assetsList">
                        <div class="empire-empty">
                            <div class="empire-empty-icon"></div>
                            <p class="empire-empty-text">No assets yet. Add your first!</p>
                        </div>
                    </div>
                </div>

                <!-- Liabilities Section -->
                <div class="empire-section">
                    <div class="empire-section-header">
                        <span class="empire-section-icon"></span>
                        <span class="empire-section-title liabilities">Liabilities</span>
                        <button class="empire-add-btn liabilities" onclick="window.openEmpireModal && window.openEmpireModal('liability')">+ Add</button>
                    </div>
                    <div class="empire-list" id="liabilitiesList">
                        <div class="empire-empty">
                            <div class="empire-empty-icon"></div>
                            <p class="empire-empty-text">No liabilities. Great job!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Empire Page -->

        <!-- Recurring Subscriptions Page -->
        <div class="page recurring-page" id="page-recurring">
            <div class="recurring-header">
                <div class="recurring-header-top">
                    <div class="recurring-header-left">
                        <h1 id="subsPageTitle">Subscriptions</h1>
                        <p id="subsPageSubtitle">Track your recurring payments</p>
                    </div>
                    <div class="header-buttons">
                        <button class="lang-toggle-btn-small" onclick="window.toggleLanguageQuick && window.toggleLanguageQuick()" id="langToggle"><span class="lang-flag"></span><span class="lang-text"></span></button>
                        <button class="settings-btn" onclick="window.switchPage && window.switchPage('settings')" title="Settings"></button>
                        <button class="dark-mode-btn" onclick="window.toggleDarkMode && window.toggleDarkMode()" id="darkModeBtn5"></button>
                    </div>
                </div>
                <div class="recurring-totals">
                    <div class="recurring-total-card monthly">
                        <div class="recurring-total-label" id="subsMonthlyLabel">Monthly Total</div>
                        <div class="recurring-total-value" id="recurringMonthlyTotal">$0</div>
                    </div>
                    <div class="recurring-total-card yearly">
                        <div class="recurring-total-label" id="subsYearlyLabel">Yearly Cost</div>
                        <div class="recurring-total-value" id="recurringYearlyTotal">$0</div>
                    </div>
                </div>
            </div>

            <div class="recurring-content">
                <!-- Stats Row -->
                <div class="recurring-stats" id="recurringStats">
                    <div class="recurring-stat">
                        <div class="recurring-stat-value" id="recurringCount">0</div>
                        <div class="recurring-stat-label" id="subsActiveLabel">Active</div>
                    </div>
                    <div class="recurring-stat">
                        <div class="recurring-stat-value" id="recurringAvg">$0</div>
                        <div class="recurring-stat-label" id="subsAvgLabel">Avg/Month</div>
                    </div>
                    <div class="recurring-stat">
                        <div class="recurring-stat-value" id="recurringNext">-</div>
                        <div class="recurring-stat-label" id="subsNextLabel">Next Bill</div>
                    </div>
                </div>

                <!-- Subscriptions List -->
                <div id="recurringListContainer">
                    <div class="recurring-section-title">
                        <span></span> Your Subscriptions
                    </div>
                    <div class="recurring-list" id="recurringList">
                        <!-- Subscriptions will be rendered here -->
                    </div>
                </div>

                <div class="recurring-empty" id="recurringEmpty" style="display: none;">
                    <div class="recurring-empty-icon"></div>
                    <div class="recurring-empty-title">No Subscriptions Yet</div>
                    <div class="recurring-empty-text">Start tracking your Netflix, Spotify, gym membership and more!</div>
                </div>

                <button class="add-subscription-btn" onclick="openSubscriptionModal()">
                    <span></span> Add Subscription
                </button>
            </div>
        </div>
        <!-- End Recurring Page -->

        <!-- Financial Health Score Page -->
        <div class="page" id="page-health">
            <div class="health-header">
                <div class="health-header-top">
                    <div class="health-header-left">
                        <h1>Financial Health</h1>
                        <p>Your overall financial wellness</p>
                    </div>
                    <div class="header-buttons">
                        <button class="settings-btn" onclick="window.switchPage && window.switchPage('settings')" title="Settings"></button>
                        <button class="dark-mode-btn" onclick="window.toggleDarkMode && window.toggleDarkMode()" id="darkModeBtn6"></button>
                    </div>
                </div>
            </div>

            <div class="health-score-container">
                <div class="health-score-circle">
                    <svg class="health-score-svg" viewBox="0 0 200 200">
                        <circle class="health-score-bg" cx="100" cy="100" r="88"></circle>
                        <circle class="health-score-progress" id="healthScoreCircle" cx="100" cy="100" r="88" 
                            stroke-dasharray="553" stroke-dashoffset="553"></circle>
                    </svg>
                    <div class="health-score-text">
                        <div class="health-score-value" id="healthScoreValue">0</div>
                        <div class="health-score-label">out of 100</div>
                    </div>
                </div>
            </div>

            <div class="health-score-status" id="healthScoreStatus">
                <div class="health-score-status-text" id="healthStatusText">Calculating...</div>
                <div class="health-score-status-desc" id="healthStatusDesc">Add some data to see your score</div>
            </div>

            <div class="health-content">
                <div class="health-section">
                    <div class="health-section-title">
                        <span></span> Key Metrics
                    </div>
                    <div class="health-metrics">
                        <div class="health-metric-card">
                            <div class="health-metric-header">
                                <div class="health-metric-left">
                                    <div class="health-metric-icon good" id="savingsRateIcon"></div>
                                    <div class="health-metric-name">Savings Rate</div>
                                </div>
                                <div class="health-metric-value good" id="savingsRateValue">0%</div>
                            </div>
                            <div class="health-metric-bar">
                                <div class="health-metric-bar-fill good" id="savingsRateBar" style="width: 0%"></div>
                            </div>
                            <div class="health-metric-hint" id="savingsRateHint">Aim for 20% or more of your income</div>
                        </div>

                        <div class="health-metric-card">
                            <div class="health-metric-header">
                                <div class="health-metric-left">
                                    <div class="health-metric-icon good" id="budgetAdherenceIcon"></div>
                                    <div class="health-metric-name">Budget Adherence</div>
                                </div>
                                <div class="health-metric-value good" id="budgetAdherenceValue">0%</div>
                            </div>
                            <div class="health-metric-bar">
                                <div class="health-metric-bar-fill good" id="budgetAdherenceBar" style="width: 0%"></div>
                            </div>
                            <div class="health-metric-hint" id="budgetAdherenceHint">Stay within your monthly budget</div>
                        </div>

                        <div class="health-metric-card">
                            <div class="health-metric-header">
                                <div class="health-metric-left">
                                    <div class="health-metric-icon good" id="debtRatioIcon"></div>
                                    <div class="health-metric-name">Debt-to-Income</div>
                                </div>
                                <div class="health-metric-value good" id="debtRatioValue">0%</div>
                            </div>
                            <div class="health-metric-bar">
                                <div class="health-metric-bar-fill good" id="debtRatioBar" style="width: 0%"></div>
                            </div>
                            <div class="health-metric-hint" id="debtRatioHint">Keep debt payments under 36% of income</div>
                        </div>

                        <div class="health-metric-card">
                            <div class="health-metric-header">
                                <div class="health-metric-left">
                                    <div class="health-metric-icon good" id="emergencyFundIcon"></div>
                                    <div class="health-metric-name">Emergency Fund</div>
                                </div>
                                <div class="health-metric-value good" id="emergencyFundValue">0 mo</div>
                            </div>
                            <div class="health-metric-bar">
                                <div class="health-metric-bar-fill good" id="emergencyFundBar" style="width: 0%"></div>
                            </div>
                            <div class="health-metric-hint" id="emergencyFundHint">Aim for 3-6 months of expenses saved</div>
                        </div>

                        <div class="health-metric-card">
                            <div class="health-metric-header">
                                <div class="health-metric-left">
                                    <div class="health-metric-icon good" id="netWorthIcon"></div>
                                    <div class="health-metric-name">Net Worth Trend</div>
                                </div>
                                <div class="health-metric-value good" id="netWorthValue">$0</div>
                            </div>
                            <div class="health-metric-bar">
                                <div class="health-metric-bar-fill good" id="netWorthBar" style="width: 0%"></div>
                            </div>
                            <div class="health-metric-hint" id="netWorthHint">Growing net worth is key to financial freedom</div>
                        </div>
                    </div>
                </div>

                <div class="health-section">
                    <div class="health-section-title">
                        <span></span> Tips to Improve
                    </div>
                    <div class="health-tips" id="healthTips">
                        <!-- Tips will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
        <!-- End Health Score Page -->

        <!-- Financial Health Score Page -->
        <div class="page" id="page-health">
            <div class="health-header">
                <div class="health-header-top">
                    <h1 id="healthPageTitle"> Financial Health</h1>
                    <div class="header-buttons">
                        <button class="lang-toggle-btn-small" onclick="window.toggleLanguageQuick && window.toggleLanguageQuick()" id="langToggle"><span class="lang-flag"></span><span class="lang-text"></span></button>
                        <button class="dark-mode-btn" onclick="window.toggleDarkMode && window.toggleDarkMode()" id="darkModeBtn6"></button>
                    </div>
                </div>
                
                <div class="health-score-circle">
                    <div class="health-score-ring" id="healthScoreRing" style="--score: 0; --score-color: #10b981;">
                        <div class="health-score-value" id="healthScoreValue">0</div>
                    </div>
                </div>
                <div class="health-score-label" id="healthScoreLabel">Your Financial Health Score</div>
                <div class="health-score-status" id="healthScoreStatus">Calculating...</div>
            </div>

            <div class="health-content">
                <div class="health-section-title" id="healthBreakdownTitle">
                    <span></span> Score Breakdown
                </div>
                <div class="health-metrics" id="healthMetrics">
                    <!-- Metrics will be rendered here -->
                </div>

                <div class="health-section-title" id="healthTipsTitle">
                    <span></span> Tips to Improve
                </div>
                <div class="health-tips" id="healthTips">
                    <!-- Tips will be rendered here -->
                </div>
            </div>
        </div>
        <!-- End Health Score Page -->

        <!-- Split Cost Page -->
        <div class="page" id="page-split">
            <div class="split-header">
                <div class="split-header-top">
                    <div class="split-header-left">
                        <h1 id="splitPageTitle"> Split Costs</h1>
                        <p id="splitPageSubtitle">Share expenses with friends</p>
                    </div>
                    <div class="header-buttons">
                        <button class="lang-toggle-btn-small" onclick="window.toggleLanguageQuick && window.toggleLanguageQuick()" id="langToggle"><span class="lang-flag"></span><span class="lang-text"></span></button>
                        <button class="settings-btn" onclick="window.switchPage && window.switchPage('settings')" title="Settings"></button>
                        <button class="dark-mode-btn" onclick="window.toggleDarkMode && window.toggleDarkMode()" id="darkModeBtnSplit"></button>
                    </div>
                </div>
                
                <!-- Balance Summary -->
                <div class="split-balance-summary">
                    <div class="split-balance-card owed">
                        <div class="split-balance-label" id="splitOwedLabel">You are owed</div>
                        <div class="split-balance-value" id="splitOwedToYou">$0.00</div>
                    </div>
                    <div class="split-balance-card owe">
                        <div class="split-balance-label" id="splitOweLabel">You owe</div>
                        <div class="split-balance-value" id="splitYouOwe">$0.00</div>
                    </div>
                </div>
            </div>
            
            <div class="split-content">
                <!-- Quick Actions -->
                <div class="split-quick-actions">
                    <button class="split-action-btn primary" onclick="window.openAddExpenseModal && window.openAddExpenseModal()" id="splitAddExpenseBtn">
                        <span></span> <span data-i18n="addExpense">Add Expense</span>
                    </button>
                    <button class="split-action-btn secondary" onclick="window.openAddFriendModal && window.openAddFriendModal()" id="splitAddFriendBtn">
                        <span></span> <span data-i18n="addFriend">Add Friend</span>
                    </button>
                    <button class="split-action-btn secondary" onclick="window.openCreateGroupModal && window.openCreateGroupModal()" id="splitNewGroupBtn">
                        <span></span> <span data-i18n="newGroup">New Group</span>
                    </button>
                </div>
                
                <!-- Friends Section -->
                <div class="split-section">
                    <div class="split-section-header">
                        <h2 class="split-section-title"> Friends</h2>
                        <button class="split-add-btn" onclick="window.openAddFriendModal && window.openAddFriendModal()">+ Add</button>
                    </div>
                    <div class="split-friends-list" id="splitFriendsList">
                        <div class="split-empty-state">
                            <div class="split-empty-icon"></div>
                            <p>No friends added yet</p>
                            <button class="split-empty-btn" onclick="window.openAddFriendModal && window.openAddFriendModal()">Add Your First Friend</button>
                        </div>
                    </div>
                </div>
                
                <!-- Groups Section -->
                <div class="split-section">
                    <div class="split-section-header">
                        <h2 class="split-section-title"> Groups</h2>
                        <button class="split-add-btn" onclick="window.openCreateGroupModal && window.openCreateGroupModal()">+ Create</button>
                    </div>
                    <div class="split-groups-list" id="splitGroupsList">
                        <div class="split-empty-state">
                            <div class="split-empty-icon"></div>
                            <p>No groups created yet</p>
                            <button class="split-empty-btn" onclick="window.openCreateGroupModal && window.openCreateGroupModal()">Create Your First Group</button>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="split-section">
                    <div class="split-section-header">
                        <h2 class="split-section-title"> Recent Activity</h2>
                    </div>
                    <div class="split-activity-list" id="splitActivityList">
                        <div class="split-empty-state">
                            <div class="split-empty-icon"></div>
                            <p>No expenses to split yet</p>
                        </div>
                    </div>
                </div>
                
                <!-- Settlements Section -->
                <div class="split-section">
                    <div class="split-section-header">
                        <h2 class="split-section-title"> Settle Up</h2>
                    </div>
                    <div class="split-settlements-list" id="splitSettlementsList">
                        <div class="split-empty-state">
                            <div class="split-empty-icon"></div>
                            <p>All settled up!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Split Cost Page -->

        <!-- Settings Page -->
        <div class="page" id="page-settings">
            <div class="global-header">
                <div class="header-left">
                    <button class="back-btn" onclick="window.switchPage && window.switchPage('cashflow')" style="background: var(--bg-primary); border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; cursor: pointer; margin-left: -8px;"></button>
                    <div>
                        <div class="user-name" id="settingsPageTitle"></div>
                    </div>
                </div>
                <div class="header-right">
                    <button class="lang-toggle-btn-small" onclick="window.toggleLanguageQuick && window.toggleLanguageQuick()" id="langToggle"><span class="lang-flag"></span><span class="lang-text">EN</span></button>
                    <button class="dark-mode-btn" onclick="window.toggleDarkMode && window.toggleDarkMode()" id="darkModeBtn7"></button>
                </div>
            </div>

            <div class="settings-page-content">
                <!-- Profile Section -->
                <div class="settings-section">
                    <div class="settings-section-title" id="profileSectionTitle"> Profile</div>
                    <div class="settings-card">
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label" id="yourNameLabel">Your Name</label>
                            <input type="text" class="input-field" id="userNameInput" placeholder="Enter your name">
                        </div>
                    </div>
                </div>

                <!-- Budget Section -->
                <div class="settings-section">
                    <div class="settings-section-title" id="budgetSectionTitle"> Budget</div>
                    <div class="settings-card">
                        <div class="input-group" style="margin-bottom: 16px;">
                            <label class="input-label" id="monthlyBudgetLabel">Monthly Budget</label>
                            <div class="amount-input-wrapper">
                                <span class="currency-symbol">$</span>
                                <input type="number" class="input-field amount-input" id="settingsBudgetInput" placeholder="0.00" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="input-label" id="currencyLabel">Currency</label>
                            <div class="currency-grid">
                                <!-- Gulf Countries -->
                                <div class="currency-option" data-currency="." data-code="AED" onclick="selectCurrency(this, '.', 'AED')">. AED </div>
                                <div class="currency-option" data-currency="." data-code="SAR" onclick="selectCurrency(this, '.', 'SAR')">. SAR </div>
                                <div class="currency-option" data-currency="." data-code="OMR" onclick="selectCurrency(this, '.', 'OMR')">. OMR </div>
                                <div class="currency-option" data-currency="." data-code="KWD" onclick="selectCurrency(this, '.', 'KWD')">. KWD </div>
                                <div class="currency-option" data-currency="." data-code="QAR" onclick="selectCurrency(this, '.', 'QAR')">. QAR </div>
                                <div class="currency-option" data-currency="." data-code="BHD" onclick="selectCurrency(this, '.', 'BHD')">. BHD </div>
                                <!-- Middle East -->
                                <div class="currency-option" data-currency="." data-code="EGP" onclick="selectCurrency(this, '.', 'EGP')">. EGP </div>
                                <div class="currency-option" data-currency="." data-code="IQD" onclick="selectCurrency(this, '.', 'IQD')">. IQD </div>
                                <div class="currency-option" data-currency="." data-code="JOD" onclick="selectCurrency(this, '.', 'JOD')">. JOD </div>
                                <div class="currency-option" data-currency="." data-code="LBP" onclick="selectCurrency(this, '.', 'LBP')">. LBP </div>
                                <div class="currency-option" data-currency="." data-code="SYP" onclick="selectCurrency(this, '.', 'SYP')">. SYP </div>
                                <div class="currency-option" data-currency="" data-code="ILS" onclick="selectCurrency(this, '', 'ILS')"> ILS </div>
                                <div class="currency-option" data-currency="." data-code="TND" onclick="selectCurrency(this, '.', 'TND')">. TND </div>
                                <div class="currency-option" data-currency="." data-code="MAD" onclick="selectCurrency(this, '.', 'MAD')">. MAD </div>
                                <div class="currency-option" data-currency="." data-code="DZD" onclick="selectCurrency(this, '.', 'DZD')">. DZD </div>
                                <div class="currency-option" data-currency="." data-code="LYD" onclick="selectCurrency(this, '.', 'LYD')">. LYD </div>
                                <div class="currency-option" data-currency="." data-code="YER" onclick="selectCurrency(this, '.', 'YER')">. YER </div>
                                <div class="currency-option" data-currency="." data-code="SDG" onclick="selectCurrency(this, '.', 'SDG')">. SDG </div>
                                <!-- International -->
                                <div class="currency-option active" data-currency="$" data-code="USD" onclick="selectCurrency(this, '$', 'USD')">$ USD </div>
                                <div class="currency-option" data-currency="" data-code="EUR" onclick="selectCurrency(this, '', 'EUR')"> EUR </div>
                                <div class="currency-option" data-currency="" data-code="GBP" onclick="selectCurrency(this, '', 'GBP')"> GBP </div>
                                <div class="currency-option" data-currency="" data-code="TRY" onclick="selectCurrency(this, '', 'TRY')"> TRY </div>
                                <div class="currency-option" data-currency="" data-code="INR" onclick="selectCurrency(this, '', 'INR')"> INR </div>
                                <div class="currency-option" data-currency="Rs" data-code="PKR" onclick="selectCurrency(this, 'Rs', 'PKR')">Rs PKR </div>
                            </div>
                            
                            <!-- Custom Currency Input -->
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                                <label class="input-label" id="customCurrencyLabel">Custom Currency</label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="text" class="input-field" id="customCurrencySymbol" placeholder="Symbol (e.g. )" style="width: 80px; text-align: center;" maxlength="3">
                                    <input type="text" class="input-field" id="customCurrencyCode" placeholder="Code (e.g. BTC)" style="flex: 1;" maxlength="5">
                                    <button class="quick-add-btn income" id="customCurrencySetBtn" onclick="applyCustomCurrency()" style="padding: 14px 18px;">Set</button>
                                </div>
                                <p id="customCurrencyHint" style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">Enter any currency symbol and code</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Appearance Section -->
                <div class="settings-section">
                    <div class="settings-section-title" id="appearanceSectionTitle"> Appearance</div>
                    <div class="settings-card">
                        <div class="input-group" style="margin-bottom: 16px;">
                            <label class="input-label" id="colorThemeLabel">Color Theme</label>
                            <div class="theme-picker">
                                <div class="theme-option th-sage active" data-theme="" title="Sage" onclick="selectTheme(this, '')"></div>
                                <div class="theme-option th-ocean" data-theme="theme-ocean" title="Ocean" onclick="selectTheme(this, 'theme-ocean')"></div>
                                <div class="theme-option th-sunset" data-theme="theme-sunset" title="Sunset" onclick="selectTheme(this, 'theme-sunset')"></div>
                                <div class="theme-option th-lavender" data-theme="theme-lavender" title="Lavender" onclick="selectTheme(this, 'theme-lavender')"></div>
                                <div class="theme-option th-rose" data-theme="theme-rose" title="Rose" onclick="selectTheme(this, 'theme-rose')"></div>
                                <div class="theme-option th-forest" data-theme="theme-forest" title="Forest" onclick="selectTheme(this, 'theme-forest')"></div>
                            </div>
                            <p id="themeDisabledHint" style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">Themes disabled when dark mode is on</p>
                        </div>
                    </div>
                </div>

                <!-- Language Section -->
                <div class="settings-section">
                    <div class="settings-section-title">  / Language</div>
                    <div class="settings-card">
                        <div class="input-group" style="margin-bottom: 0;">
                            <div class="language-grid">
                                <div class="language-option" data-lang="en" onclick="setLanguage('en')">
                                    <span class="language-flag"></span>
                                    <span class="language-name">English</span>
                                </div>
                                <div class="language-option active" data-lang="ar-funny" onclick="setLanguage('ar-funny')">
                                    <span class="language-flag"></span>
                                    <span class="language-name"> </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Categories Section -->
                <div class="settings-section">
                    <div class="settings-section-title" id="categoriesSectionTitle"> Custom Categories</div>
                    <div class="settings-card">
                        <div class="custom-category-input">
                            <button class="emoji-picker-btn" id="selectedEmoji" onclick="toggleEmojiPicker()"></button>
                            <input type="text" class="input-field" id="newCategoryName" placeholder="Category name" style="flex:1">
                            <button class="quick-add-btn income" onclick="addCustomCategory()" style="padding: 14px 18px;">+</button>
                        </div>
                        <div class="emoji-grid" id="emojiGrid" style="display: none;"></div>
                        <div id="categoryList" style="margin-top: 12px;"></div>
                    </div>
                </div>

                <!-- Data Section -->
                <div class="settings-section">
                    <div class="settings-section-title" id="dataSectionTitle"> Data</div>
                    <div class="settings-card">
                        <button class="export-btn" id="exportJsonBtn" onclick="window.exportData && window.exportData()"> Export Data (JSON)</button>
                        <button class="export-btn" id="exportCsvBtn" onclick="exportCSV()"> Export as CSV</button>
                        <label class="export-btn" id="importDataBtn" style="cursor: pointer;">
                             Import Data
                            <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                        </label>
                    </div>
                </div>

                <!-- Welcome Tour -->
                <div class="settings-section">
                    <div class="settings-section-title" id="welcomeTourSectionTitle"> Welcome Tour</div>
                    <div class="settings-card">
                        <button class="submit-btn" id="replayTourBtn" onclick="window.replayOnboarding && window.replayOnboarding()" style="width: 100%; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Replay Welcome Tour</button>
                    </div>
                </div>

                <!-- Example Data -->
                <div class="settings-section">
                    <div class="settings-section-title" id="exampleDataSectionTitle"> Example Data</div>
                    <div class="settings-card">
                        <p id="exampleDataDesc" style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">Sample entries are marked with a purple "EXAMPLE" badge. Clear them when you're ready to add your own data.</p>
                        <button class="submit-btn" id="clearExamplesBtn" onclick="clearExamples()" style="width: 100%; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); -webkit-appearance: none; touch-action: manipulation;"> Clear All Examples</button>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="settings-section">
                    <div class="settings-section-title" id="dangerZoneSectionTitle" style="color: var(--accent-red);"> Danger Zone</div>
                    <div class="settings-card">
                        <p id="dangerZoneDesc" style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">This will permanently delete all your data including transactions, debts, goals, and more.</p>
                        <button type="button" class="reset-btn" id="resetAllBtn" onclick="window.resetData()" style="width: 100%; -webkit-appearance: none; touch-action: manipulation;"> Reset All Data</button>
                    </div>
                </div>

                <!-- App Info -->
                <div class="settings-section">
                    <div class="settings-section-title" id="aboutSectionTitle"> About</div>
                    <div class="settings-card" style="text-align: center;">
                        <p style="font-size: 14px; font-weight: 600; color: var(--accent-green); margin-bottom: 4px;">CashFlow Pro</p>
                        <p id="appTagline" style="font-size: 12px; color: var(--text-muted);">Your personal finance companion</p>
                        <p id="dataStorageNote" style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">All data stored locally on your device</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Settings Page -->

        <!-- Bottom Navigation -->
        <!-- Floating Menu Button -->
        <button class="floating-menu-btn" id="floatingMenuBtn" onclick="toggleFloatingMenu()">
            <span class="menu-icon"></span>
        </button>

        <!-- Expandable Menu Overlay -->
        <div class="floating-menu-overlay" id="floatingMenuOverlay" onclick="toggleFloatingMenu()"></div>
        
        <!-- Expandable Menu -->
        <div class="floating-menu" id="floatingMenu">
            <div class="floating-menu-header">
                <span class="floating-menu-title" data-i18n="menu"></span>
                <button class="floating-menu-close" onclick="toggleFloatingMenu()"></button>
            </div>
            <div class="floating-menu-items">
                <button class="floating-menu-item active" onclick="switchPageFromMenu('cashflow')">
                    <span class="floating-menu-icon"></span>
                    <span class="floating-menu-label" data-i18n="cashflow">  </span>
                </button>
                <button class="floating-menu-item" onclick="switchPageFromMenu('debt')">
                    <span class="floating-menu-icon"></span>
                    <span class="floating-menu-label" data-i18n="debtCrusher"> </span>
                </button>
                <button class="floating-menu-item" onclick="switchPageFromMenu('wealth')">
                    <span class="floating-menu-icon"></span>
                    <span class="floating-menu-label" data-i18n="wealthBuilder"> </span>
                </button>
                <button class="floating-menu-item" onclick="switchPageFromMenu('empire')">
                    <span class="floating-menu-icon"></span>
                    <span class="floating-menu-label" data-i18n="empire"></span>
                </button>
                <button class="floating-menu-item" onclick="switchPageFromMenu('recurring')">
                    <span class="floating-menu-icon"></span>
                    <span class="floating-menu-label" data-i18n="subscriptions"></span>
                </button>
                <button class="floating-menu-item" onclick="switchPageFromMenu('health')">
                    <span class="floating-menu-icon"></span>
                    <span class="floating-menu-label" data-i18n="health"> </span>
                </button>
                <button class="floating-menu-item" onclick="switchPageFromMenu('split')">
                    <span class="floating-menu-icon"></span>
                    <span class="floating-menu-label" data-i18n="split"> </span>
                </button>
                <button class="floating-menu-item" onclick="switchPageFromMenu('settings')">
                    <span class="floating-menu-icon"></span>
                    <span class="floating-menu-label" data-i18n="settings"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div class="modal-overlay" id="transactionModal">
        <div class="modal">
            <div class="modal-header">
                <button type="button" class="modal-close-btn" onclick="window.closeModal && window.closeModal('transactionModal')"></button>
                <h2 class="modal-title" id="modalTitle">Add Expense</h2>
                <div style="width: 32px;"></div>
            </div>
            
            <div class="input-group">
                <label class="input-label">Amount</label>
                <div class="amount-input-wrapper">
                    <span class="currency-symbol">$</span>
                    <input type="number" class="input-field amount-input" id="amountInput" placeholder="0.00" step="0.01" min="0">
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">Description</label>
                <input type="text" class="input-field" id="descriptionInput" placeholder="What was it for?">
            </div>

            <div class="input-group" id="categoryGroup">
                <label class="input-label">Category</label>
                <div class="modal-categories" id="modalCategories"></div>
            </div>

            <div class="recurring-toggle">
                <span style="font-size: 14px; font-weight: 500;">Recurring Transaction</span>
                <div class="toggle-switch" id="recurringToggle" onclick="toggleRecurring()"></div>
            </div>
            <div class="frequency-selector" id="frequencySelector">
                <div class="frequency-option active" data-freq="weekly" onclick="selectFrequency(this, 'weekly')">Weekly</div>
                <div class="frequency-option" data-freq="biweekly" onclick="selectFrequency(this, 'biweekly')">Bi-weekly</div>
                <div class="frequency-option" data-freq="monthly" onclick="selectFrequency(this, 'monthly')">Monthly</div>
            </div>

            <div class="modal-actions">
                <button type="button" class="modal-cancel-btn" onclick="window.closeModal && window.closeModal('transactionModal')">Cancel</button>
                <button type="button" class="modal-save-btn expense" id="submitBtn" onclick="addTransaction()">Save</button>
            </div>
        </div>
    </div>

    <!-- Add Debt Modal -->
    <div class="modal-overlay debt-modal" id="debtModal">
        <div class="modal" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <button type="button" class="modal-close-btn" onclick="window.closeModal && window.closeModal('debtModal')"></button>
                <h2 class="modal-title" id="debtModalTitle">Add Debt</h2>
                <div style="width: 32px;"></div>
            </div>
            
            <div class="input-group">
                <label class="input-label">Debt Type</label>
                <div class="debt-type-grid">
                    <div class="debt-type-item active" data-type="credit" data-icon="" onclick="selectDebtType(this, 'credit', '')">
                        <div class="debt-type-item-icon"></div>
                        <div class="debt-type-item-label">Credit Card</div>
                    </div>
                    <div class="debt-type-item" data-type="auto" data-icon="" onclick="selectDebtType(this, 'auto', '')">
                        <div class="debt-type-item-icon"></div>
                        <div class="debt-type-item-label">Auto Loan</div>
                    </div>
                    <div class="debt-type-item" data-type="student" data-icon="" onclick="selectDebtType(this, 'student', '')">
                        <div class="debt-type-item-icon"></div>
                        <div class="debt-type-item-label">Student</div>
                    </div>
                    <div class="debt-type-item" data-type="mortgage" data-icon="" onclick="selectDebtType(this, 'mortgage', '')">
                        <div class="debt-type-item-icon"></div>
                        <div class="debt-type-item-label">Mortgage</div>
                    </div>
                    <div class="debt-type-item" data-type="personal" data-icon="" onclick="selectDebtType(this, 'personal', '')">
                        <div class="debt-type-item-icon"></div>
                        <div class="debt-type-item-label">Personal</div>
                    </div>
                    <div class="debt-type-item" data-type="other" data-icon="" onclick="selectDebtType(this, 'other', '')">
                        <div class="debt-type-item-icon"></div>
                        <div class="debt-type-item-label">Other</div>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">Account Name</label>
                <input type="text" class="input-field" id="debtNameInput" placeholder="e.g., Chase Visa">
            </div>

            <div class="input-group">
                <label class="input-label">Original Amount</label>
                <div class="amount-input-wrapper">
                    <span class="currency-symbol">$</span>
                    <input type="number" class="input-field amount-input" id="debtOriginalInput" placeholder="0.00" step="0.01" min="0">
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">Current Balance</label>
                <div class="amount-input-wrapper">
                    <span class="currency-symbol">$</span>
                    <input type="number" class="input-field amount-input" id="debtBalanceInput" placeholder="0.00" step="0.01" min="0">
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">Interest Rate (APR %)</label>
                <input type="number" class="input-field" id="debtInterestInput" placeholder="0.00" step="0.01" min="0" max="100">
            </div>

            <div class="input-group">
                <label class="input-label">Payment Amount</label>
                <div class="amount-input-wrapper">
                    <span class="currency-symbol">$</span>
                    <input type="number" class="input-field amount-input" id="debtMinPaymentInput" placeholder="0.00" step="0.01" min="0">
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">Auto-Deduct Schedule</label>
                <div class="schedule-options">
                    <div class="schedule-option" data-schedule="none" onclick="selectDebtSchedule(this, 'none')">
                        <div class="schedule-option-title"> Off</div>
                        <div class="schedule-option-desc">Manual only</div>
                    </div>
                    <div class="schedule-option active" data-schedule="weekly" onclick="selectDebtSchedule(this, 'weekly')">
                        <div class="schedule-option-title"> Weekly</div>
                        <div class="schedule-option-desc">Every week</div>
                    </div>
                    <div class="schedule-option" data-schedule="biweekly" onclick="selectDebtSchedule(this, 'biweekly')">
                        <div class="schedule-option-title"> Bi-weekly</div>
                        <div class="schedule-option-desc">Every 2 weeks</div>
                    </div>
                    <div class="schedule-option" data-schedule="monthly" onclick="selectDebtSchedule(this, 'monthly')">
                        <div class="schedule-option-title"> Monthly</div>
                        <div class="schedule-option-desc">Once a month</div>
                    </div>
                </div>
                <div class="custom-schedule-row" id="customScheduleRow">
                    <input type="number" class="input-field" id="customDaysInput" placeholder="Days" min="1" max="365">
                    <span style="display: flex; align-items: center; color: var(--text-muted);">days</span>
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">Start Date</label>
                <input type="date" class="input-field" id="debtStartDateInput">
            </div>

            <div class="modal-actions">
                <button type="button" class="modal-cancel-btn" onclick="window.closeModal && window.closeModal('debtModal')">Cancel</button>
                <button type="button" class="modal-save-btn income" id="debtSubmitBtn" onclick="addDebt()">Add Debt</button>
            </div>
            <button type="button" class="submit-btn secondary" id="debtDeleteBtn" onclick="deleteCurrentDebt()" style="display: none; margin-top: 10px; background: var(--accent-red-light); color: var(--accent-red);"> Delete Debt</button>
        </div>
    </div>

    <!-- Make Payment Modal -->
    <div class="modal-overlay" id="paymentModal">
        <div class="modal">
            <div class="modal-header">
                <button type="button" class="modal-close-btn" onclick="window.closeModal && window.closeModal('paymentModal')"></button>
                <h2 class="modal-title">Make Payment</h2>
                <div style="width: 32px;"></div>
            </div>
            <p id="paymentDebtName" style="text-align:center; color: var(--text-secondary); margin-bottom: 20px;"></p>
            
            <div class="input-group">
                <label class="input-label">Payment Amount</label>
                <div class="amount-input-wrapper">
                    <span class="currency-symbol">$</span>
                    <input type="number" class="input-field amount-input" id="paymentAmountInput" placeholder="0.00" step="0.01" min="0">
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="modal-cancel-btn" onclick="window.closeModal && window.closeModal('paymentModal')">Cancel</button>
                <button type="button" class="modal-save-btn income" id="crushItBtn" onclick="handleCrushIt()"> Crush It!</button>
            </div>
        </div>
    </div>

    <!-- Add Asset/Liability Modal -->
    <div class="modal-overlay" id="empireModal">
        <div class="modal" style="max-height: 85vh; overflow-y: auto;">
            <div class="modal-header">
                <button type="button" class="modal-close-btn" onclick="window.closeModal && window.closeModal('empireModal')"></button>
                <h2 class="modal-title" id="empireModalTitle">Add Asset</h2>
                <div style="width: 32px;"></div>
            </div>
            
            <div class="input-group">
                <label class="input-label">Type</label>
                <div class="empire-type-grid" id="empireTypeGrid">
                    <!-- Filled dynamically -->
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">Name</label>
                <input type="text" class="input-field" id="empireNameInput" placeholder="e.g., Savings Account">
            </div>

            <div class="input-group">
                <label class="input-label">Value</label>
                <div class="amount-input-wrapper">
                    <span class="currency-symbol">$</span>
                    <input type="number" class="input-field amount-input" id="empireValueInput" placeholder="0.00" step="0.01" min="0">
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">Notes (Optional)</label>
                <input type="text" class="input-field" id="empireNotesInput" placeholder="Any additional details">
            </div>

            <div class="modal-actions">
                <button type="button" class="modal-cancel-btn" onclick="window.closeModal && window.closeModal('empireModal')">Cancel</button>
                <button type="button" class="modal-save-btn income" id="empireSubmitBtn" onclick="addEmpireItem()">Add Asset</button>
            </div>
            <button type="button" class="submit-btn secondary" id="empireDeleteBtn" onclick="deleteCurrentEmpireItem()" style="display: none; margin-top: 10px; background: var(--accent-red-light); color: var(--accent-red);"> Delete</button>
        </div>
    </div>

    <!-- Add Goal Modal -->
    <div class="modal-overlay" id="goalModal">
        <div class="modal" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <button type="button" class="modal-close-btn" onclick="window.closeModal && window.closeModal('goalModal')"></button>
                <h2 class="modal-title" id="goalModalTitle">Create Goal</h2>
                <div style="width: 32px;"></div>
            </div>
            
            <div class="input-group">
                <label class="input-label">Goal Type</label>
                <div class="goal-type-grid">
                    <div class="goal-type-item active" data-type="emergency" data-icon="" onclick="selectGoalType(this, 'emergency', '')">
                        <div class="goal-type-item-icon"></div>
                        <div class="goal-type-item-label">Emergency</div>
                    </div>
                    <div class="goal-type-item" data-type="vacation" data-icon="" onclick="selectGoalType(this, 'vacation', '')">
                        <div class="goal-type-item-icon"></div>
                        <div class="goal-type-item-label">Vacation</div>
                    </div>
                    <div class="goal-type-item" data-type="tech" data-icon="" onclick="selectGoalType(this, 'tech', '')">
                        <div class="goal-type-item-icon"></div>
                        <div class="goal-type-item-label">Tech</div>
                    </div>
                    <div class="goal-type-item" data-type="gift" data-icon="" onclick="selectGoalType(this, 'gift', '')">
                        <div class="goal-type-item-icon"></div>
                        <div class="goal-type-item-label">Gifts</div>
                    </div>
                    <div class="goal-type-item" data-type="house" data-icon="" onclick="selectGoalType(this, 'house', '')">
                        <div class="goal-type-item-icon"></div>
                        <div class="goal-type-item-label">House</div>
                    </div>
                    <div class="goal-type-item" data-type="car" data-icon="" onclick="selectGoalType(this, 'car', '')">
                        <div class="goal-type-item-icon"></div>
                        <div class="goal-type-item-label">Car</div>
                    </div>
                    <div class="goal-type-item" data-type="education" data-icon="" onclick="selectGoalType(this, 'education', '')">
                        <div class="goal-type-item-icon"></div>
                        <div class="goal-type-item-label">Education</div>
                    </div>
                    <div class="goal-type-item" data-type="wedding" data-icon="" onclick="selectGoalType(this, 'wedding', '')">
                        <div class="goal-type-item-icon"></div>
                        <div class="goal-type-item-label">Wedding</div>
                    </div>
                    <div class="goal-type-item" data-type="other" data-icon="" onclick="selectGoalType(this, 'other', '')">
                        <div class="goal-type-item-icon"></div>
                        <div class="goal-type-item-label">Other</div>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">Goal Name</label>
                <input type="text" class="input-field" id="goalNameInput" placeholder="e.g., Emergency Fund">
            </div>

            <div class="input-group">
                <label class="input-label">Target Amount</label>
                <div class="amount-input-wrapper">
                    <span class="currency-symbol">$</span>
                    <input type="number" class="input-field amount-input" id="goalTargetInput" placeholder="0.00" step="0.01" min="0">
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">Already Saved (Optional)</label>
                <div class="amount-input-wrapper">
                    <span class="currency-symbol">$</span>
                    <input type="number" class="input-field amount-input" id="goalSavedInput" placeholder="0.00" step="0.01" min="0">
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">Target Date</label>
                <input type="date" class="input-field" id="goalDueDateInput">
            </div>

            <div class="input-group">
                <label class="input-label">Auto-Save Schedule</label>
                <div class="schedule-options">
                    <div class="schedule-option" data-schedule="none" onclick="selectGoalSchedule(this, 'none')">
                        <div class="schedule-option-title"> Off</div>
                        <div class="schedule-option-desc">Manual only</div>
                    </div>
                    <div class="schedule-option active" data-schedule="weekly" onclick="selectGoalSchedule(this, 'weekly')">
                        <div class="schedule-option-title"> Weekly</div>
                        <div class="schedule-option-desc">Every week</div>
                    </div>
                    <div class="schedule-option" data-schedule="biweekly" onclick="selectGoalSchedule(this, 'biweekly')">
                        <div class="schedule-option-title"> Bi-weekly</div>
                        <div class="schedule-option-desc">Every 2 weeks</div>
                    </div>
                    <div class="schedule-option" data-schedule="monthly" onclick="selectGoalSchedule(this, 'monthly')">
                        <div class="schedule-option-title"> Monthly</div>
                        <div class="schedule-option-desc">Once a month</div>
                    </div>
                </div>
            </div>

            <div class="input-group" id="goalAutoAmountGroup">
                <label class="input-label">Auto-Save Amount</label>
                <div class="amount-input-wrapper">
                    <span class="currency-symbol">$</span>
                    <input type="number" class="input-field amount-input" id="goalAutoAmountInput" placeholder="0.00" step="0.01" min="0">
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="modal-cancel-btn" onclick="window.closeModal && window.closeModal('goalModal')">Cancel</button>
                <button type="button" class="modal-save-btn income" id="goalSubmitBtn" onclick="addGoal()">Create Goal</button>
            </div>
            <button type="button" class="submit-btn secondary" id="goalDeleteBtn" onclick="deleteCurrentGoal()" style="display: none; margin-top: 10px; background: var(--accent-red-light); color: var(--accent-red);"> Delete Goal</button>
        </div>
    </div>

    <!-- Make Deposit Modal -->
    <div class="modal-overlay" id="depositModal">
        <div class="modal">
            <div class="modal-header">
                <button type="button" class="modal-close-btn" onclick="window.closeModal && window.closeModal('depositModal')"></button>
                <h2 class="modal-title">Add Savings</h2>
                <div style="width: 32px;"></div>
            </div>
            <p id="depositGoalName" style="text-align:center; color: var(--text-secondary); margin-bottom: 20px;"></p>
            
            <div class="input-group">
                <label class="input-label">Amount to Save</label>
                <div class="amount-input-wrapper">
                    <span class="currency-symbol">$</span>
                    <input type="number" class="input-field amount-input" id="depositAmountInput" placeholder="0.00" step="0.01" min="0">
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="modal-cancel-btn" onclick="window.closeModal && window.closeModal('depositModal')">Cancel</button>
                <button type="button" class="modal-save-btn income" onclick="makeDeposit()"> Save It!</button>
            </div>
        </div>
    </div>

    <!-- Goal Celebration Overlay -->
    <div class="goal-celebration-overlay" id="goalCelebrationOverlay">
        <div class="goal-celebration-content">
            <div class="goal-celebration-emoji"></div>
            <h2 class="goal-celebration-title">GOAL REACHED!</h2>
            <p class="goal-celebration-text" id="goalCelebrationText">You did it!</p>
            <button class="celebration-btn" onclick="closeGoalCelebration()">Celebrate! </button>
        </div>
    </div>

    <!-- Celebration Overlay -->
    <div class="celebration-overlay" id="celebrationOverlay">
        <div class="celebration-content">
            <div class="celebration-emoji"></div>
            <h2 class="celebration-title">DEBT CRUSHED!</h2>
            <p class="celebration-text" id="celebrationText">You paid off your debt!</p>
            <button class="celebration-btn" onclick="closeCelebration()">Keep Crushing! </button>
        </div>
    </div>

    <!-- Add Subscription Modal -->
    <div class="modal-overlay" id="subscriptionModal">
        <div class="modal" style="max-height: 85vh; overflow-y: auto;">
            <div class="modal-header">
                <button type="button" class="modal-close-btn" onclick="window.closeModal && window.closeModal('subscriptionModal')"></button>
                <h2 class="modal-title" id="subscriptionModalTitle">Add Subscription</h2>
                <div style="width: 32px;"></div>
            </div>
            
            <div class="input-group">
                <label class="input-label">Service Type</label>
                <div class="subscription-type-grid">
                    <div class="subscription-type-item active" data-type="streaming" data-icon="" onclick="selectSubscriptionType(this, 'streaming', '')">
                        <div class="subscription-type-item-icon"></div>
                        <div class="subscription-type-item-label">Streaming</div>
                    </div>
                    <div class="subscription-type-item" data-type="music" data-icon="" onclick="selectSubscriptionType(this, 'music', '')">
                        <div class="subscription-type-item-icon"></div>
                        <div class="subscription-type-item-label">Music</div>
                    </div>
                    <div class="subscription-type-item" data-type="fitness" data-icon="" onclick="selectSubscriptionType(this, 'fitness', '')">
                        <div class="subscription-type-item-icon"></div>
                        <div class="subscription-type-item-label">Fitness</div>
                    </div>
                    <div class="subscription-type-item" data-type="shopping" data-icon="" onclick="selectSubscriptionType(this, 'shopping', '')">
                        <div class="subscription-type-item-icon"></div>
                        <div class="subscription-type-item-label">Shopping</div>
                    </div>
                    <div class="subscription-type-item" data-type="cloud" data-icon="" onclick="selectSubscriptionType(this, 'cloud', '')">
                        <div class="subscription-type-item-icon"></div>
                        <div class="subscription-type-item-label">Cloud</div>
                    </div>
                    <div class="subscription-type-item" data-type="gaming" data-icon="" onclick="selectSubscriptionType(this, 'gaming', '')">
                        <div class="subscription-type-item-icon"></div>
                        <div class="subscription-type-item-label">Gaming</div>
                    </div>
                    <div class="subscription-type-item" data-type="phone" data-icon="" onclick="selectSubscriptionType(this, 'phone', '')">
                        <div class="subscription-type-item-icon"></div>
                        <div class="subscription-type-item-label">Phone</div>
                    </div>
                    <div class="subscription-type-item" data-type="vpn" data-icon="" onclick="selectSubscriptionType(this, 'vpn', '')">
                        <div class="subscription-type-item-icon"></div>
                        <div class="subscription-type-item-label">VPN</div>
                    </div>
                    <div class="subscription-type-item" data-type="other" data-icon="" onclick="selectSubscriptionType(this, 'other', '')">
                        <div class="subscription-type-item-icon"></div>
                        <div class="subscription-type-item-label">Other</div>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">Service Name</label>
                <input type="text" class="input-field" id="subscriptionNameInput" placeholder="e.g., Netflix, Spotify">
            </div>

            <div class="input-group">
                <label class="input-label">Amount</label>
                <div class="amount-input-wrapper">
                    <span class="currency-symbol">$</span>
                    <input type="number" class="input-field amount-input" id="subscriptionAmountInput" placeholder="0.00" step="0.01" min="0">
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">Billing Cycle</label>
                <div class="billing-cycle-options">
                    <div class="billing-cycle-option active" data-cycle="monthly" onclick="selectBillingCycle(this, 'monthly')">Monthly</div>
                    <div class="billing-cycle-option" data-cycle="yearly" onclick="selectBillingCycle(this, 'yearly')">Yearly</div>
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">Next Billing Date</label>
                <input type="date" class="input-field" id="subscriptionBillDateInput">
            </div>

            <div class="modal-actions">
                <button type="button" class="modal-cancel-btn" onclick="window.closeModal && window.closeModal('subscriptionModal')">Cancel</button>
                <button type="button" class="modal-save-btn income" id="subscriptionSubmitBtn" onclick="addSubscription()">Add Subscription</button>
            </div>
            <button type="button" class="submit-btn secondary" id="subscriptionDeleteBtn" onclick="deleteCurrentSubscription()" style="display: none; margin-top: 10px; background: var(--accent-red-light); color: var(--accent-red);"> Delete Subscription</button>
        </div>
    </div>

    <!-- Add Friend Modal -->
    <div class="modal-overlay" id="addFriendModal">
        <div class="modal">
            <div class="modal-header">
                <button type="button" class="modal-close-btn" onclick="window.closeModal && window.closeModal('addFriendModal')"></button>
                <h2 class="modal-title">Add Friend</h2>
                <div style="width: 32px;"></div>
            </div>
            
            <div class="input-group">
                <label class="input-label">Friend's Name</label>
                <input type="text" class="input-field" id="friendNameInput" placeholder="e.g., John Doe">
            </div>
            
            <div class="input-group">
                <label class="input-label">Email (optional)</label>
                <input type="email" class="input-field" id="friendEmailInput" placeholder="friend@email.com">
            </div>
            
            <div class="modal-actions">
                <button type="button" class="modal-cancel-btn" onclick="window.closeModal && window.closeModal('addFriendModal')">Cancel</button>
                <button type="button" class="modal-save-btn income" onclick="addFriend()">Add Friend</button>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div class="modal-overlay" id="createGroupModal">
        <div class="modal" style="max-height: 85vh; overflow-y: auto;">
            <div class="modal-header">
                <button type="button" class="modal-close-btn" onclick="window.closeModal && window.closeModal('createGroupModal')"></button>
                <h2 class="modal-title" id="groupModalTitle">Create Group</h2>
                <div style="width: 32px;"></div>
            </div>
            
            <div class="input-group">
                <label class="input-label">Group Name</label>
                <input type="text" class="input-field" id="groupNameInput" placeholder="e.g., Roommates, Trip to Paris">
            </div>
            
            <div class="input-group">
                <label class="input-label">Group Icon</label>
                <div class="split-icon-grid" id="groupIconGrid">
                    <div class="split-icon-item active" data-icon="" onclick="selectGroupIcon(this, '')"></div>
                    <div class="split-icon-item" data-icon="" onclick="selectGroupIcon(this, '')"></div>
                    <div class="split-icon-item" data-icon="" onclick="selectGroupIcon(this, '')"></div>
                    <div class="split-icon-item" data-icon="" onclick="selectGroupIcon(this, '')"></div>
                    <div class="split-icon-item" data-icon="" onclick="selectGroupIcon(this, '')"></div>
                    <div class="split-icon-item" data-icon="" onclick="selectGroupIcon(this, '')"></div>
                    <div class="split-icon-item" data-icon="" onclick="selectGroupIcon(this, '')"></div>
                    <div class="split-icon-item" data-icon="" onclick="selectGroupIcon(this, '')"></div>
                </div>
            </div>
            
            <div class="input-group">
                <label class="input-label">Add Members</label>
                <div class="split-members-select" id="groupMembersSelect">
                    <p style="color: var(--text-muted); font-size: 13px;">Add friends first to include them in groups</p>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="modal-cancel-btn" onclick="window.closeModal && window.closeModal('createGroupModal')">Cancel</button>
                <button type="button" class="modal-save-btn income" id="groupSubmitBtn" onclick="createGroup()">Create Group</button>
            </div>
            <button type="button" class="submit-btn secondary" id="groupDeleteBtn" onclick="deleteCurrentGroup()" style="display: none; margin-top: 10px; background: var(--accent-red-light); color: var(--accent-red);"> Delete Group</button>
        </div>
    </div>

    <!-- Add Split Expense Modal -->
    <div class="modal-overlay" id="addSplitExpenseModal">
        <div class="modal" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <button type="button" class="modal-close-btn" onclick="window.closeModal && window.closeModal('addSplitExpenseModal')"></button>
                <h2 class="modal-title">Add Expense</h2>
                <div style="width: 32px;"></div>
            </div>
            
            <div class="input-group">
                <label class="input-label">Description</label>
                <input type="text" class="input-field" id="splitExpenseDescInput" placeholder="e.g., Dinner at restaurant">
            </div>
            
            <div class="input-group">
                <label class="input-label">Total Amount</label>
                <div class="amount-input-wrapper">
                    <span class="currency-symbol">$</span>
                    <input type="number" class="input-field amount-input" id="splitExpenseAmountInput" placeholder="0.00" step="0.01" min="0">
                </div>
            </div>
            
            <div class="input-group">
                <label class="input-label">Group</label>
                <select class="input-field" id="splitExpenseGroupSelect">
                    <option value="">Select a group...</option>
                </select>
            </div>
            
            <div class="input-group">
                <label class="input-label">Paid By</label>
                <select class="input-field" id="splitExpensePaidBySelect">
                    <option value="me">You</option>
                </select>
            </div>
            
            <div class="input-group">
                <label class="input-label">Split Method</label>
                <div class="split-method-options">
                    <div class="split-method-option active" data-method="equal" onclick="selectSplitMethod(this, 'equal')">
                        <span></span> Equal
                    </div>
                    <div class="split-method-option" data-method="exact" onclick="selectSplitMethod(this, 'exact')">
                        <span></span> Exact
                    </div>
                    <div class="split-method-option" data-method="percent" onclick="selectSplitMethod(this, 'percent')">
                        <span>%</span> Percent
                    </div>
                </div>
            </div>
            
            <div class="input-group" id="splitAmountsGroup" style="display: none;">
                <label class="input-label">Split Amounts</label>
                <div id="splitAmountsContainer"></div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="modal-cancel-btn" onclick="window.closeModal && window.closeModal('addSplitExpenseModal')">Cancel</button>
                <button type="button" class="modal-save-btn income" onclick="addSplitExpense()">Add Expense</button>
            </div>
        </div>
    </div>

    <!-- Settle Up Modal -->
    <div class="modal-overlay" id="settleUpModal">
        <div class="modal">
            <div class="modal-header">
                <button type="button" class="modal-close-btn" onclick="window.closeModal && window.closeModal('settleUpModal')"></button>
                <h2 class="modal-title">Settle Up</h2>
                <div style="width: 32px;"></div>
            </div>
            
            <div class="settle-up-info" id="settleUpInfo">
                <!-- Filled dynamically -->
            </div>
            
            <div class="input-group">
                <label class="input-label">Amount to Settle</label>
                <div class="amount-input-wrapper">
                    <span class="currency-symbol">$</span>
                    <input type="number" class="input-field amount-input" id="settleAmountInput" placeholder="0.00" step="0.01" min="0">
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="modal-cancel-btn" onclick="window.closeModal && window.closeModal('settleUpModal')">Cancel</button>
                <button type="button" class="modal-save-btn income" onclick="recordSettlement()">Record Payment</button>
            </div>
        </div>
    </div>

    <!-- Group Detail Modal -->
    <div class="modal-overlay" id="groupDetailModal">
        <div class="modal" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <button type="button" class="modal-close-btn" onclick="window.closeModal && window.closeModal('groupDetailModal')"></button>
                <h2 class="modal-title" id="groupDetailTitle">Group Details</h2>
                <div style="width: 32px;"></div>
            </div>
            
            <div class="group-detail-content" id="groupDetailContent">
                <!-- Filled dynamically -->
            </div>
            
            <div class="modal-actions">
                <button type="button" class="modal-cancel-btn" onclick="window.closeModal && window.closeModal('groupDetailModal')">Close</button>
                <button type="button" class="modal-save-btn income" onclick="openAddExpenseForGroup()">Add Expense</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ==========================================
        // TRANSLATION SYSTEM - FUNNY ARABIC 
        // ==========================================
        
        const translations = {
            'en': {
                // App name
                appName: 'CashFlow Pro',
                
                // Navigation
                cashflow: 'Cash Flow',
                debtCrusher: 'Debt Crusher',
                wealthBuilder: 'Wealth Builder',
                empire: 'Empire',
                subscriptions: 'Subscriptions',
                health: 'Health',
                split: 'Split',
                settings: 'Settings',
                
                // Greetings
                goodMorning: 'Good morning,',
                goodAfternoon: 'Good afternoon,',
                goodEvening: 'Good evening,',
                
                // Balance
                thisMonthBalance: "This Month's Balance",
                totalIncome: 'Total Income',
                totalExpense: 'Total Spent',
                incomeMinusExpenses: 'Income minus Expenses',
                
                // Actions
                addIncome: 'Add Income',
                addExpense: 'Add Expense',
                save: 'Save',
                cancel: 'Cancel',
                delete: 'Delete',
                edit: 'Edit',
                
                // Categories
                food: 'Food',
                transport: 'Transport',
                shopping: 'Shopping',
                bills: 'Bills',
                entertainment: 'Fun',
                healthCat: 'Health',
                income: 'Income',
                other: 'Other',
                
                // Spending
                spendingByCategory: 'Spending by Category',
                recentTransactions: 'Recent Transactions',
                
                // Debt Crusher
                crushYourDebt: 'Crush Your Debt!',
                totalDebt: 'Total Debt',
                paidOff: 'Paid Off',
                monthlyPayment: 'Monthly Payment',
                addDebt: 'Add Debt',
                crushIt: 'Crush It!',
                makePayment: 'Make Payment',
                debtName: 'Debt Name',
                currentBalance: 'Current Balance',
                interestRate: 'Interest Rate',
                minimumPayment: 'Minimum Payment',
                
                // Wealth Builder (Goals)
                buildYourWealth: 'Build Your Wealth!',
                totalSaved: 'Total Saved',
                goalsReached: 'Goals Reached',
                activeGoals: 'Active Goals',
                addGoal: 'Add Goal',
                deposit: 'Deposit',
                goalName: 'Goal Name',
                targetAmount: 'Target Amount',
                alreadySaved: 'Already Saved',
                targetDate: 'Target Date',
                
                // Goal Types
                emergency: 'Emergency Fund',
                vacation: 'Vacation',
                tech: 'Tech/Gadgets',
                gift: 'Gift',
                house: 'House',
                car: 'Car',
                education: 'Education',
                wedding: 'Wedding',
                
                // Empire (Net Worth)
                yourEmpire: 'Your Empire',
                netWorth: 'Net Worth',
                assets: 'Assets',
                liabilities: 'Liabilities',
                addAsset: 'Add Asset',
                addLiability: 'Add Liability',
                
                // Subscriptions
                recurringCosts: 'Recurring Costs',
                monthlyTotal: 'Monthly Total',
                yearlyTotal: 'Yearly Total',
                activeSubscriptions: 'Active',
                addSubscription: 'Add Subscription',
                
                // Financial Health
                financialHealth: 'Financial Health',
                healthScore: 'Health Score',
                savingsRate: 'Savings Rate',
                budgetAdherence: 'Budget Adherence',
                debtToIncome: 'Debt-to-Income',
                emergencyFund: 'Emergency Fund',
                
                // Split Cost
                splitCosts: 'Split Costs',
                shareExpenses: 'Share expenses with friends',
                youAreOwed: 'You are owed',
                youOwe: 'You owe',
                addFriend: 'Add Friend',
                newGroup: 'New Group',
                friends: 'Friends',
                groups: 'Groups',
                recentActivity: 'Recent Activity',
                settleUp: 'Settle Up',
                allSettled: 'All settled up!',
                
                // Settings
                profile: 'Profile',
                yourName: 'Your Name',
                budget: 'Budget',
                monthlyBudget: 'Monthly Budget',
                currency: 'Currency',
                appearance: 'Appearance',
                colorTheme: 'Color Theme',
                language: 'Language',
                customCategories: 'Custom Categories',
                dataManagement: 'Data Management',
                clearExamples: 'Clear Example Data',
                resetAll: 'Reset All Data',
                
                // Messages
                saved: 'Saved!',
                deleted: 'Deleted!',
                added: 'Added!',
                updated: 'Updated!',
                error: 'Error!',
                
                // Time
                today: 'Today',
                yesterday: 'Yesterday',
                weekly: 'Weekly',
                biweekly: 'Bi-weekly',
                monthly: 'Monthly',
                yearly: 'Yearly',
            },
            
            'ar-funny': {
                // App name
                appName: '  ',
                
                // Navigation
                cashflow: '  ',
                debtCrusher: '  ',
                wealthBuilder: '  ',
                empire: ' ',
                subscriptions: '  ',
                health: ' ',
                split: ' ',
                settings: '',
                
                // Greetings
                goodMorning: ' ',
                goodAfternoon: '  ',
                goodEvening: ' ',
                
                // Balance
                thisMonthBalance: '  ',
                totalIncome: '',
                totalExpense: '',
                incomeMinusExpenses: '  ',
                
                // Actions
                addIncome: '+  ',
                addExpense: '-  ',
                save: '',
                cancel: ' ',
                delete: '',
                edit: '',
                
                // Categories
                food: ' ',
                transport: ' ',
                shopping: ' ',
                bills: ' ',
                entertainment: ' ',
                healthCat: ' ',
                income: ' ',
                other: '  ',
                
                // Spending
                spendingByCategory: '   ',
                recentTransactions: '  ',
                
                // Debt Crusher
                crushYourDebt: '  !',
                totalDebt: ' ',
                paidOff: ' ',
                monthlyPayment: ' ',
                addDebt: '+  ',
                crushIt: '! ',
                makePayment: ' ',
                debtName: ' ',
                currentBalance: ' ',
                interestRate: '  ',
                minimumPayment: ' ',
                
                // Wealth Builder (Goals)
                buildYourWealth: '   !',
                totalSaved: '',
                goalsReached: ' ',
                activeGoals: ' ',
                addGoal: '+  ',
                deposit: ' ',
                goalName: ' ',
                targetAmount: ' ',
                alreadySaved: '',
                targetDate: ' ',
                
                // Goal Types
                emergency: ' ',
                vacation: ' ',
                tech: ' ',
                gift: ' ',
                house: '  ',
                car: ' ',
                education: ' ',
                wedding: ' ',
                
                // Empire (Net Worth)
                yourEmpire: ' ',
                netWorth: ' ',
                assets: '',
                liabilities: ' ',
                addAsset: '+  ',
                addLiability: '+  ',
                
                // Subscriptions
                recurringCosts: '   ',
                monthlyTotal: '',
                yearlyTotal: '',
                activeSubscriptions: '',
                addSubscription: '+  ',
                
                // Financial Health
                financialHealth: '  ',
                healthScore: '',
                savingsRate: ' ',
                budgetAdherence: ' ',
                debtToIncome: '  ',
                emergencyFund: ' ',
                
                // Split Cost
                splitCosts: '  ',
                shareExpenses: '   ',
                youAreOwed: '  ',
                youOwe: ' ',
                addFriend: '+  ',
                newGroup: '+  ',
                friends: '',
                groups: '',
                recentActivity: ' ',
                settleUp: ' ',
                allSettled: '  ! ',
                
                // Settings
                profile: '',
                yourName: ' ',
                budget: '',
                monthlyBudget: ' ',
                currency: '',
                appearance: '',
                colorTheme: '',
                language: '',
                customCategories: ' ',
                dataManagement: ' ',
                clearExamples: ' ',
                resetAll: '   ',
                
                // Messages
                saved: ' ! ',
                deleted: '! ',
                added: '! ',
                updated: '! ',
                error: ' ! ',
                
                // Time
                today: '',
                yesterday: '',
                weekly: '',
                biweekly: ' ',
                monthly: '',
                yearly: '',
                
                // Extra funny phrases for toasts
                debtPaid: ' ! ',
                moneySaved: '  ! ',
                goalReached: ' ! ',
                brokeAlert: ' ! ',
                richAlert: '    ! ',
                
                // Debt types
                creditCard: ' ',
                autoLoan: '  ',
                studentLoan: '  ',
                mortgage: '  ',
                personalLoan: '   ',
                otherDebt: '  ',
                
                // Subscription types
                streaming: '  ',
                music: ' ',
                fitness: ' ',
                shoppingApp: ' ',
                cloud: ' ',
                gaming: ' ',
                phone: ' ',
                vpn: '   ',
            }
        };
        
        // Current language
        let currentLanguage = localStorage.getItem('pocketflow_language') || 'ar-funny';
        
        // Translation function
        function t(key) {
            return translations[currentLanguage]?.[key] || translations['en'][key] || key;
        }
        
        // Set language function
        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('pocketflow_language', lang);
            
            // Update language selector UI
            document.querySelectorAll('.language-option').forEach(el => {
                el.classList.remove('active');
                if (el.dataset.lang === lang) {
                    el.classList.add('active');
                }
            });
            
            // Set RTL for Arabic
            if (lang === 'ar-funny') {
                document.documentElement.setAttribute('dir', 'rtl');
                document.body.style.fontFamily = "'Noto Sans Arabic', 'DM Sans', sans-serif";
            } else {
                document.documentElement.setAttribute('dir', 'ltr');
                document.body.style.fontFamily = "'DM Sans', sans-serif";
            }
            
            // Apply translations to the page
            applyTranslations();
            
            showToast(lang === 'ar-funny' ? '  ! ' : 'Language changed!');
        }
        
        // Apply translations to all elements
        function applyTranslations() {
            const isArabic = currentLanguage === 'ar-funny';
            
            // Floating menu items
            const menuKeys = ['cashflow', 'debtCrusher', 'wealthBuilder', 'empire', 'subscriptions', 'health', 'split', 'settings'];
            document.querySelectorAll('.floating-menu-item').forEach((item, index) => {
                const label = item.querySelector('.floating-menu-label');
                if (label && menuKeys[index]) {
                    label.textContent = t(menuKeys[index]);
                }
            });
            
            // Floating menu title
            const menuTitle = document.querySelector('.floating-menu-title');
            if (menuTitle) {
                menuTitle.textContent = isArabic ? '' : 'Menu';
            }
            
            // ===== CASHFLOW PAGE =====
            updateElement('#balanceMainLabel', ' ' + t('thisMonthBalance'));
            updateElement('#totalIncomeLabel', ' ' + t('totalIncome'));
            updateElement('#totalExpenseLabel', ' ' + t('totalExpense'));
            updateElement('#balanceSubLabel', t('incomeMinusExpenses'));
            
            // Quick add buttons
            const incomeBtn = document.querySelector('.quick-add-btn.income');
            const expenseBtn = document.querySelector('.quick-add-btn.expense');
            if (incomeBtn) incomeBtn.innerHTML = '<span>+</span> ' + t('addIncome');
            if (expenseBtn) expenseBtn.innerHTML = '<span></span> ' + t('addExpense');
            
            // Section titles
            document.querySelectorAll('.section-title').forEach(el => {
                const text = el.textContent.trim();
                if (text.includes('Spending') || text.includes(' ')) el.innerHTML = t('spendingByCategory');
                if (text.includes('Recent') || text.includes(' ')) el.innerHTML = t('recentTransactions');
            });
            
            // ===== DEBT PAGE =====
            updateElement('#debtPageTitle', isArabic ? '  ' : 'Debt Crusher');
            updateElement('#debtPageSubtitle', isArabic ? '  ' : 'Track and eliminate your debts');
            updateElement('#debtTotalLabel', isArabic ? ' ' : 'Total Remaining');
            updateElement('#debtPaidLabel', isArabic ? ' ' : 'Total Paid Off');
            
            // Debt add button
            const debtAddBtn = document.querySelector('.debt-add-btn');
            if (debtAddBtn) debtAddBtn.innerHTML = '<span>+</span> ' + (isArabic ? ' ' : 'Add Debt');
            
            // ===== WEALTH/GOALS PAGE =====
            updateElement('#wealthPageTitle', isArabic ? '  ' : ' Savings Goals');
            updateElement('#wealthPageSubtitle', isArabic ? ' ' : 'Save for what matters most');
            updateElement('#wealthSavedLabel', isArabic ? ' ' : ' Total Saved');
            updateElement('#wealthTargetLabel', isArabic ? ' ' : ' Goal Amount');
            
            // Goals add button
            const goalAddBtn = document.querySelector('.goals-add-btn');
            if (goalAddBtn) goalAddBtn.innerHTML = '<span>+</span> ' + (isArabic ? ' ' : 'Add Goal');
            
            // ===== EMPIRE PAGE =====
            updateElement('#empirePageTitle', isArabic ? ' ' : 'Empire');
            updateElement('#empirePageSubtitle', isArabic ? ' ' : 'Track your net worth');
            updateElement('#netWorthLabel', isArabic ? ' ' : 'Net Worth');
            updateElement('#assetCountLabel', isArabic ? '' : 'Assets');
            
            // Empire section titles
            document.querySelectorAll('.empire-section-title').forEach(el => {
                if (el.textContent.includes('Assets') || el.textContent.includes('')) {
                    el.innerHTML = ' ' + (isArabic ? '' : 'Your Assets');
                }
                if (el.textContent.includes('Liabilities') || el.textContent.includes('')) {
                    el.innerHTML = ' ' + (isArabic ? ' ' : 'Your Liabilities');
                }
            });
            
            // ===== SUBSCRIPTIONS PAGE =====
            updateElement('#subsPageTitle', isArabic ? ' ' : 'Subscriptions');
            updateElement('#subsPageSubtitle', isArabic ? '    ' : 'Track your recurring payments');
            updateElement('#subsMonthlyLabel', isArabic ? '' : 'Monthly Total');
            updateElement('#subsYearlyLabel', isArabic ? '' : 'Yearly Cost');
            updateElement('#subsActiveLabel', isArabic ? '' : 'Active');
            updateElement('#subsAvgLabel', isArabic ? '' : 'Avg/Month');
            updateElement('#subsNextLabel', isArabic ? '' : 'Next Bill');
            
            // Subscription add button
            const subAddBtn = document.querySelector('.recurring-add-btn');
            if (subAddBtn) subAddBtn.innerHTML = '<span>+</span> ' + (isArabic ? ' ' : 'Add Subscription');
            
            // ===== HEALTH PAGE =====
            updateElement('#healthPageTitle', isArabic ? '  ' : ' Financial Health');
            updateElement('#healthScoreLabel', isArabic ? '  ' : 'Your Financial Health Score');
            updateElement('#healthBreakdownTitle', '<span></span> ' + (isArabic ? ' ' : 'Score Breakdown'));
            updateElement('#healthTipsTitle', '<span></span> ' + (isArabic ? ' ' : 'Tips to Improve'));
            
            // ===== SPLIT PAGE =====
            updateElement('#splitPageTitle', isArabic ? '  ' : ' Split Costs');
            updateElement('#splitPageSubtitle', isArabic ? '   ' : 'Share expenses with friends');
            updateElement('#splitOwedLabel', isArabic ? '  ' : 'You are owed');
            updateElement('#splitOweLabel', isArabic ? ' ' : 'You owe');
            
            // Split action buttons
            const splitExpBtn = document.querySelector('#splitAddExpenseBtn span[data-i18n]');
            const splitFriendBtn = document.querySelector('#splitAddFriendBtn span[data-i18n]');
            const splitGroupBtn = document.querySelector('#splitNewGroupBtn span[data-i18n]');
            if (splitExpBtn) splitExpBtn.textContent = isArabic ? ' ' : 'Add Expense';
            if (splitFriendBtn) splitFriendBtn.textContent = isArabic ? ' ' : 'Add Friend';
            if (splitGroupBtn) splitGroupBtn.textContent = isArabic ? ' ' : 'New Group';
            
            // Split section headers
            document.querySelectorAll('.split-section-title').forEach(el => {
                if (el.textContent.includes('Friends') || el.textContent.includes('')) {
                    el.textContent = isArabic ? ' ' : ' Friends';
                }
                if (el.textContent.includes('Groups') || el.textContent.includes('')) {
                    el.textContent = isArabic ? ' ' : ' Groups';
                }
                if (el.textContent.includes('Activity') || el.textContent.includes('')) {
                    el.textContent = isArabic ? '  ' : ' Recent Activity';
                }
                if (el.textContent.includes('Settle') || el.textContent.includes('')) {
                    el.textContent = isArabic ? '  ' : ' Settle Up';
                }
            });
            
            // ===== MODALS =====
            // Modal titles
            document.querySelectorAll('.modal-title').forEach(el => {
                const text = el.textContent.trim();
                if (text === 'Add Expense' || text === ' ') el.textContent = isArabic ? ' ' : 'Add Expense';
                if (text === 'Add Income' || text === ' ') el.textContent = isArabic ? ' ' : 'Add Income';
                if (text === 'Add Debt' || text === ' ') el.textContent = isArabic ? ' ' : 'Add Debt';
                if (text === 'Add Goal' || text === ' ') el.textContent = isArabic ? ' ' : 'Add Goal';
                if (text === 'Add Asset' || text === ' ') el.textContent = isArabic ? ' ' : 'Add Asset';
                if (text === 'Add Liability' || text === ' ') el.textContent = isArabic ? ' ' : 'Add Liability';
                if (text === 'Add Subscription' || text === ' ') el.textContent = isArabic ? ' ' : 'Add Subscription';
                if (text === 'Add Friend' || text === ' ') el.textContent = isArabic ? ' ' : 'Add Friend';
                if (text === 'Create Group' || text === ' ') el.textContent = isArabic ? ' ' : 'Create Group';
                if (text === 'Make Payment' || text === '') el.textContent = isArabic ? '' : 'Make Payment';
                if (text === 'Deposit' || text === ' ') el.textContent = isArabic ? ' ' : 'Deposit';
            });
            
            // Modal buttons
            document.querySelectorAll('.modal-save-btn').forEach(btn => {
                const text = btn.textContent.trim();
                if (text === 'Save' || text === '') btn.textContent = isArabic ? '' : 'Save';
                if (text.includes('Add') || text.includes('')) btn.textContent = isArabic ? '' : 'Add';
            });
            document.querySelectorAll('.modal-cancel-btn').forEach(btn => {
                btn.textContent = isArabic ? '' : 'Cancel';
            });
            
            // Input labels
            document.querySelectorAll('.input-label').forEach(el => {
                const text = el.textContent.trim();
                if (text === 'Amount') el.textContent = isArabic ? '' : 'Amount';
                if (text === 'Note' || text === '') el.textContent = isArabic ? '' : 'Note';
                if (text === 'Category') el.textContent = isArabic ? '' : 'Category';
                if (text === 'Date') el.textContent = isArabic ? '' : 'Date';
                if (text === 'Name') el.textContent = isArabic ? '' : 'Name';
                if (text === 'Description') el.textContent = isArabic ? '' : 'Description';
                if (text === 'Total Amount') el.textContent = isArabic ? ' ' : 'Total Amount';
                if (text === 'Group') el.textContent = isArabic ? '' : 'Group';
                if (text === 'Paid By') el.textContent = isArabic ? ' ' : 'Paid By';
                if (text === 'Target Amount') el.textContent = isArabic ? ' ' : 'Target Amount';
                if (text === 'Target Date') el.textContent = isArabic ? ' ' : 'Target Date';
                if (text === 'Interest Rate') el.textContent = isArabic ? ' ' : 'Interest Rate';
                if (text === 'Minimum Payment') el.textContent = isArabic ? ' ' : 'Minimum Payment';
                if (text === "Friend's Name" || text === ' ') el.textContent = isArabic ? ' ' : "Friend's Name";
                if (text === 'Email (optional)' || text === ' ()') el.textContent = isArabic ? ' ()' : 'Email (optional)';
                if (text === 'Group Name' || text === ' ') el.textContent = isArabic ? ' ' : 'Group Name';
                if (text === 'Group Icon' || text === ' ') el.textContent = isArabic ? ' ' : 'Group Icon';
                if (text === 'Add Members' || text === ' ') el.textContent = isArabic ? ' ' : 'Add Members';
                if (text === 'Split Method' || text === ' ') el.textContent = isArabic ? ' ' : 'Split Method';
                if (text === 'Your Name' || text === '') el.textContent = isArabic ? '' : 'Your Name';
                if (text === 'Monthly Budget' || text === ' ') el.textContent = isArabic ? ' ' : 'Monthly Budget';
                if (text === 'Currency' || text === '') el.textContent = isArabic ? '' : 'Currency';
                if (text === 'Color Theme' || text === ' ') el.textContent = isArabic ? ' ' : 'Color Theme';
                if (text === 'Select Language') el.textContent = isArabic ? ' ' : 'Select Language';
            });
            
            // Update greeting
            updateGreeting();
            
            // Update ALL language toggle buttons with flags
            document.querySelectorAll('.lang-toggle-btn-small').forEach(btn => {
                btn.innerHTML = isArabic 
                    ? '<span class="lang-flag"></span><span class="lang-text">EN</span>'
                    : '<span class="lang-flag"></span><span class="lang-text"></span>';
            });
            
            // Update language toggle button in settings
            const langBtn = document.getElementById('langToggleBtn');
            if (langBtn) {
                langBtn.textContent = isArabic ? 'English' : '';
            }
            
            // ===== SETTINGS PAGE =====
            updateElement('#settingsPageTitle', isArabic ? '' : 'Settings');
            
            document.querySelectorAll('.settings-section-title').forEach(el => {
                const text = el.textContent.trim();
                if (text.includes('Profile') || text.includes('')) el.textContent = isArabic ? ' ' : ' Profile';
                if (text.includes('Budget') || text.includes('')) el.textContent = isArabic ? ' ' : ' Budget';
                if (text.includes('Appearance') || text.includes('')) el.textContent = isArabic ? ' ' : ' Appearance';
                if (text.includes('Language') || text.includes('')) el.textContent = isArabic ? ' ' : ' Language';
                if (text.includes('Categories') || text.includes('')) el.textContent = isArabic ? ' ' : ' Custom Categories';
                if (text.includes('Data') || text.includes('')) el.textContent = isArabic ? ' ' : ' Data';
            });
            
            const budgetInput = document.getElementById('settingsBudgetInput');
            if (budgetInput) budgetInput.placeholder = isArabic ? '0.00' : '0.00';
            
            // Custom currency hint
            document.querySelectorAll('#page-settings p').forEach(p => {
                if (p.textContent.includes('Enter any currency')) {
                    p.textContent = isArabic ? '    ' : 'Enter any currency symbol and code';
                }
                if (p.textContent.includes('Add friends first')) {
                    p.textContent = isArabic ? '     ' : 'Add friends first to include them in groups';
                }
            });
            
            // Data management buttons
            document.querySelectorAll('.submit-btn.secondary').forEach(btn => {
                if (btn.textContent.includes('Clear Example') || btn.textContent.includes(' ')) {
                    btn.innerHTML = isArabic ? '  ' : ' Clear Example Data';
                }
                if (btn.textContent.includes('Reset All') || btn.textContent.includes('  ')) {
                    btn.innerHTML = isArabic ? '      ' : ' Reset All Data';
                }
                if (btn.textContent.includes('Delete') || btn.textContent.includes('')) {
                    // Keep delete buttons
                }
            });
            
            // ===== MODALS - Cancel buttons =====
            document.querySelectorAll('.modal-cancel-btn').forEach(btn => {
                btn.textContent = isArabic ? '' : 'Cancel';
            });
            
            // ===== TRANSACTION MODAL =====
            const transModalTitle = document.querySelector('#transactionModal .modal-title');
            if (transModalTitle) {
                const text = transModalTitle.textContent;
                if (text.includes('Edit Income') || text.includes(' ')) {
                    transModalTitle.textContent = isArabic ? ' ' : 'Edit Income';
                } else if (text.includes('Edit Expense') || text.includes(' ')) {
                    transModalTitle.textContent = isArabic ? ' ' : 'Edit Expense';
                } else if (text.includes('Income') || text.includes('')) {
                    transModalTitle.textContent = isArabic ? '  ' : 'Add Income';
                } else if (text.includes('Expense') || text.includes('')) {
                    transModalTitle.textContent = isArabic ? '  ' : 'Add Expense';
                }
            }
            
            // Recurring Transaction label
            document.querySelectorAll('.recurring-toggle-label, .recurring-label').forEach(el => {
                if (el.textContent.includes('Recurring') || el.textContent.includes('')) {
                    el.textContent = isArabic ? ' ' : 'Recurring Transaction';
                }
            });
            
            // Description placeholder
            const descInput = document.getElementById('descriptionInput');
            if (descInput) descInput.placeholder = isArabic ? '  ' : 'What was it for?';
            
            // Search placeholder
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.placeholder = isArabic ? '   ...' : ' Search transactions...';
            
            // ===== DEBT PAGE =====
            const debtEmptyTitle = document.querySelector('.debt-empty-title');
            if (debtEmptyTitle) debtEmptyTitle.textContent = isArabic ? '  ' : 'Start Crushing Your Debt';
            
            const debtEmptyText = document.querySelector('.debt-empty-text');
            if (debtEmptyText) debtEmptyText.innerHTML = isArabic ? '    .<br>     !' : 'Track credit cards, loans, and mortgages.<br>See your payoff progress and become debt-free!';
            
            const debtEmptyBtn = document.querySelector('.debt-empty-btn');
            if (debtEmptyBtn) debtEmptyBtn.innerHTML = isArabic ? '<span></span>   ' : '<span></span> Add Your First Debt';
            
            const addDebtBtn = document.querySelector('.debt-add-btn');
            if (addDebtBtn) addDebtBtn.innerHTML = isArabic ? '<span>+</span>  ' : '<span>+</span> Add Debt';
            
            // Debt modal
            const debtModalTitle = document.querySelector('#debtModal .modal-title');
            if (debtModalTitle) {
                const text = debtModalTitle.textContent;
                if (text.includes('Edit') || text.includes('')) {
                    debtModalTitle.textContent = isArabic ? ' ' : 'Edit Debt';
                } else {
                    debtModalTitle.textContent = isArabic ? ' ' : 'Add Debt';
                }
            }
            
            // Debt type labels
            document.querySelectorAll('.debt-type-label').forEach(el => {
                const text = el.textContent.trim();
                if (text === 'Credit Card') el.textContent = isArabic ? ' ' : 'Credit Card';
                if (text === 'Auto Loan') el.textContent = isArabic ? ' ' : 'Auto Loan';
                if (text === 'Student') el.textContent = isArabic ? ' ' : 'Student';
                if (text === 'Mortgage') el.textContent = isArabic ? ' ' : 'Mortgage';
                if (text === 'Personal') el.textContent = isArabic ? ' ' : 'Personal';
                if (text === 'Other') el.textContent = isArabic ? '' : 'Other';
            });
            
            // Debt form labels
            document.querySelectorAll('#debtModal .input-label').forEach(el => {
                const text = el.textContent.trim();
                if (text.includes('Debt Type') || text.includes(' ')) el.textContent = isArabic ? ' ' : 'Debt Type';
                if (text.includes('Account Name') || text.includes(' ')) el.textContent = isArabic ? ' ' : 'Account Name';
                if (text.includes('Original Amount') || text.includes(' ')) el.textContent = isArabic ? ' ' : 'Original Amount';
                if (text.includes('Current Balance') || text.includes(' ')) el.textContent = isArabic ? ' ' : 'Current Balance';
                if (text.includes('Interest Rate') || text.includes(' ')) el.textContent = isArabic ? '  (%)' : 'Interest Rate (APR %)';
                if (text.includes('Minimum Payment') || text.includes(' ')) el.textContent = isArabic ? ' ' : 'Minimum Payment';
                if (text.includes('Auto-Deduct') || text.includes(' ')) el.textContent = isArabic ? '  ' : 'Auto-Deduct Schedule';
                if (text.includes('Start Date') || text.includes(' ')) el.textContent = isArabic ? ' ' : 'Start Date';
            });
            
            // Auto-deduct options
            document.querySelectorAll('.deduct-option-title').forEach(el => {
                const text = el.textContent.trim();
                if (text.includes('Weekly')) el.innerHTML = isArabic ? ' ' : 'Weekly ';
                if (text.includes('Bi-weekly')) el.innerHTML = isArabic ? '  ' : 'Bi-weekly ';
                if (text.includes('Monthly')) el.innerHTML = isArabic ? ' ' : 'Monthly ';
                if (text.includes('Off')) el.innerHTML = isArabic ? ' ' : 'Off ';
            });
            document.querySelectorAll('.deduct-option-desc').forEach(el => {
                const text = el.textContent.trim();
                if (text.includes('Every week')) el.textContent = isArabic ? ' ' : 'Every week';
                if (text.includes('Every 2 weeks')) el.textContent = isArabic ? ' ' : 'Every 2 weeks';
                if (text.includes('Once a month')) el.textContent = isArabic ? ' ' : 'Once a month';
                if (text.includes('Manual only')) el.textContent = isArabic ? ' ' : 'Manual only';
            });
            
            // ===== GOALS PAGE =====
            const goalsTitle = document.querySelector('.debt-section-title');
            if (goalsTitle && goalsTitle.textContent.includes('Your Goals')) {
                goalsTitle.textContent = isArabic ? '' : 'Your Goals';
            }
            
            const addGoalBtn = document.querySelector('.debt-add-btn-goals, .goals-add-btn');
            if (addGoalBtn) addGoalBtn.innerHTML = isArabic ? '<span>+</span>  ' : '<span>+</span> Add Goal';
            
            // Goals stats
            document.querySelectorAll('.goals-quick-stat-text').forEach(el => {
                if (el.textContent.includes('completed')) {
                    const val = el.querySelector('.goals-quick-stat-value');
                    if (val) el.innerHTML = isArabic ? `<span class="goals-quick-stat-value">${val.textContent}</span>  ` : `<span class="goals-quick-stat-value">${val.textContent}</span> completed `;
                }
                if (el.textContent.includes('overall')) {
                    const val = el.querySelector('.goals-quick-stat-value');
                    if (val) el.innerHTML = isArabic ? `<span class="goals-quick-stat-value">${val.textContent}</span>  ` : `<span class="goals-quick-stat-value">${val.textContent}</span> overall `;
                }
                if (el.textContent.includes('to go')) {
                    const val = el.querySelector('.goals-quick-stat-value');
                    if (val) el.innerHTML = isArabic ? `<span class="goals-quick-stat-value">${val.textContent}</span>  ` : `<span class="goals-quick-stat-value">${val.textContent}</span> to go `;
                }
            });
            
            // ===== EMPIRE PAGE =====
            document.querySelectorAll('.empire-section-title').forEach(el => {
                if (el.classList.contains('assets') || el.textContent.includes('Assets')) {
                    el.textContent = isArabic ? ' ' : 'Assets ';
                }
                if (el.classList.contains('liabilities') || el.textContent.includes('Liabilities')) {
                    el.textContent = isArabic ? '  ' : 'Liabilities ';
                }
            });
            
            document.querySelectorAll('.empire-add-btn').forEach(btn => {
                btn.textContent = isArabic ? '+ ' : '+ Add';
            });
            
            document.querySelectorAll('.empire-stat-label').forEach(el => {
                if (el.textContent.includes('Assets') || el.textContent.includes('')) {
                    el.textContent = isArabic ? '' : 'Assets';
                }
                if (el.textContent.includes('Liabilities') || el.textContent.includes('')) {
                    el.textContent = isArabic ? '' : 'Liabilities';
                }
                if (el.textContent.includes('WEALTH RATIO') || el.textContent.includes(' ')) {
                    el.textContent = isArabic ? ' ' : 'WEALTH RATIO';
                }
            });
            
            const assetsBarLabel = document.getElementById('assetsBarLabel');
            if (assetsBarLabel) {
                const match = assetsBarLabel.textContent.match(/[\$\d\.\,]+/);
                const amount = match ? match[0] : '$0';
                assetsBarLabel.textContent = isArabic ? `${amount} ` : `${amount} Assets`;
            }
            
            const liabilitiesBarLabel = document.getElementById('liabilitiesBarLabel');
            if (liabilitiesBarLabel) {
                const match = liabilitiesBarLabel.textContent.match(/[\$\d\.\,]+/);
                const amount = match ? match[0] : '$0';
                liabilitiesBarLabel.textContent = isArabic ? `${amount} ` : `${amount} Liabilities`;
            }
            
            // Total Assets label
            document.querySelectorAll('.empire-total-label').forEach(el => {
                if (el.textContent.includes('TOTAL ASSETS')) el.textContent = isArabic ? ' ' : 'TOTAL ASSETS';
                if (el.textContent.includes('TOTAL LIABILITIES')) el.textContent = isArabic ? ' ' : 'TOTAL LIABILITIES';
            });
            
            // Empty states
            document.querySelectorAll('.empire-empty-text').forEach(el => {
                if (el.textContent.includes('No assets')) el.textContent = isArabic ? '  .   !' : 'No assets yet. Add your first!';
                if (el.textContent.includes('No liabilities')) el.textContent = isArabic ? '  . ! ' : 'No liabilities yet. Great! ';
            });
            
            // ===== SUBSCRIPTIONS PAGE =====
            const addSubBtn = document.querySelector('.recurring-add-btn');
            if (addSubBtn) addSubBtn.innerHTML = isArabic ? '<span></span>  ' : '<span></span> Add Subscription';
            
            document.querySelectorAll('.recurring-section-title').forEach(el => {
                if (el.textContent.includes('YOUR SUBSCRIPTIONS')) el.textContent = isArabic ? ' ' : ' YOUR SUBSCRIPTIONS';
            });
            
            // ===== HEALTH PAGE =====
            const healthTitle = document.querySelector('#healthPageTitle, #page-health h1');
            if (healthTitle) healthTitle.textContent = isArabic ? '  ' : ' Financial Health';
            
            const healthSubtitle = document.querySelector('#page-health .page-header p');
            if (healthSubtitle) healthSubtitle.textContent = isArabic ? '  ' : 'Your overall financial wellness';
            
            const healthScoreLabel = document.getElementById('healthScoreLabel');
            if (healthScoreLabel) healthScoreLabel.textContent = isArabic ? '  ' : 'Your Financial Health Score';
            
            const healthStatusText = document.getElementById('healthStatusText');
            if (healthStatusText && healthStatusText.textContent.includes('Calculating')) {
                healthStatusText.textContent = isArabic ? ' ...' : 'Calculating...';
            }
            
            const healthStatusDesc = document.getElementById('healthStatusDesc');
            if (healthStatusDesc && healthStatusDesc.textContent.includes('Add some data')) {
                healthStatusDesc.textContent = isArabic ? '    ' : 'Add some data to see your score';
            }
            
            document.querySelectorAll('.health-metric-name').forEach(el => {
                const text = el.textContent.trim();
                if (text === 'Savings Rate') el.textContent = isArabic ? ' ' : 'Savings Rate';
                if (text === 'Budget Adherence') el.textContent = isArabic ? ' ' : 'Budget Adherence';
                if (text === 'Emergency Fund') el.textContent = isArabic ? ' ' : 'Emergency Fund';
            });
            
            document.querySelectorAll('.health-metric-hint').forEach(el => {
                if (el.textContent.includes('Aim for 20%')) el.textContent = isArabic ? '  20%    ' : 'Aim for 20% or more of your income';
                if (el.textContent.includes('Stay within')) el.textContent = isArabic ? '  ' : 'Stay within your monthly budget';
                if (el.textContent.includes('3-6 months')) el.textContent = isArabic ? '  3-6   ' : 'Aim for 3-6 months of expenses saved';
            });
            
            document.querySelectorAll('.health-section-title').forEach(el => {
                if (el.textContent.includes('KEY METRICS')) el.textContent = isArabic ? '  ' : ' KEY METRICS';
            });
            
            // ===== SETTINGS PAGE EXTRAS =====
            document.querySelectorAll('.export-btn').forEach(btn => {
                if (btn.textContent.includes('Export Data (JSON)')) btn.innerHTML = isArabic ? '   (JSON)' : ' Export Data (JSON)';
                if (btn.textContent.includes('Export as CSV')) btn.innerHTML = isArabic ? '   CSV' : ' Export as CSV';
                if (btn.textContent.includes('Import Data')) btn.innerHTML = isArabic ? '  ' : ' Import Data';
            });
            
            document.querySelectorAll('.settings-section h3').forEach(el => {
                if (el.textContent.includes('Welcome Tour')) el.textContent = isArabic ? '  ' : ' Welcome Tour';
                if (el.textContent.includes('Danger Zone')) el.textContent = isArabic ? '  ' : ' Danger Zone';
            });
            
            document.querySelectorAll('#page-settings p').forEach(p => {
                if (p.textContent.includes('Sample entries are marked')) {
                    p.textContent = isArabic ? '    "" .      .' : 'Sample entries are marked with a purple "EXAMPLE" badge. Clear them when you\'re ready to add your own data.';
                }
            });
            
            // Quick add buttons
            document.querySelectorAll('.quick-add-btn.income').forEach(btn => {
                btn.innerHTML = isArabic ? '<span>+</span> +  ' : '<span>+</span> Add Income';
            });
            document.querySelectorAll('.quick-add-btn.expense').forEach(btn => {
                btn.innerHTML = isArabic ? '<span></span>   ' : '<span></span> Add Expense';
            });
            
            // ===== DEBT MODAL - Type Labels =====
            const debtTypeLabels = {
                'credit': isArabic ? ' ' : 'Credit Card',
                'auto': isArabic ? ' ' : 'Auto Loan',
                'student': isArabic ? ' ' : 'Student',
                'mortgage': isArabic ? ' ' : 'Mortgage',
                'personal': isArabic ? ' ' : 'Personal',
                'other': isArabic ? '' : 'Other'
            };
            document.querySelectorAll('.debt-type-item').forEach(item => {
                const type = item.dataset.type;
                const label = item.querySelector('.debt-type-item-label');
                if (label && debtTypeLabels[type]) {
                    label.textContent = debtTypeLabels[type];
                }
            });
            
            // ===== DEBT MODAL - Schedule Options =====
            document.querySelectorAll('.schedule-option').forEach(opt => {
                const schedule = opt.dataset.schedule;
                const title = opt.querySelector('.schedule-option-title');
                const desc = opt.querySelector('.schedule-option-desc');
                if (schedule === 'none') {
                    if (title) title.innerHTML = isArabic ? ' ' : ' Off';
                    if (desc) desc.textContent = isArabic ? ' ' : 'Manual only';
                } else if (schedule === 'weekly') {
                    if (title) title.innerHTML = isArabic ? ' ' : ' Weekly';
                    if (desc) desc.textContent = isArabic ? ' ' : 'Every week';
                } else if (schedule === 'biweekly') {
                    if (title) title.innerHTML = isArabic ? '  ' : ' Bi-weekly';
                    if (desc) desc.textContent = isArabic ? ' ' : 'Every 2 weeks';
                } else if (schedule === 'monthly') {
                    if (title) title.innerHTML = isArabic ? ' ' : ' Monthly';
                    if (desc) desc.textContent = isArabic ? ' ' : 'Once a month';
                }
            });
            
            // ===== GOAL MODAL - Type Labels =====
            const goalTypeLabels = {
                'emergency': isArabic ? '' : 'Emergency',
                'vacation': isArabic ? '' : 'Vacation',
                'car': isArabic ? '' : 'Car',
                'home': isArabic ? '' : 'Home',
                'education': isArabic ? '' : 'Education',
                'wedding': isArabic ? '' : 'Wedding',
                'retirement': isArabic ? '' : 'Retirement',
                'other': isArabic ? '' : 'Other'
            };
            document.querySelectorAll('.goal-type-item').forEach(item => {
                const type = item.dataset.type;
                const label = item.querySelector('.goal-type-item-label');
                if (label && goalTypeLabels[type]) {
                    label.textContent = goalTypeLabels[type];
                }
            });
            
            // ===== SUBSCRIPTION MODAL - Type Labels =====
            const subTypeLabels = {
                'streaming': isArabic ? '' : 'Streaming',
                'music': isArabic ? '' : 'Music',
                'gaming': isArabic ? '' : 'Gaming',
                'software': isArabic ? '' : 'Software',
                'fitness': isArabic ? '' : 'Fitness',
                'news': isArabic ? '' : 'News',
                'cloud': isArabic ? '' : 'Cloud',
                'other': isArabic ? '' : 'Other'
            };
            document.querySelectorAll('.subscription-type-item').forEach(item => {
                const type = item.dataset.type;
                const label = item.querySelector('.subscription-type-item-label');
                if (label && subTypeLabels[type]) {
                    label.textContent = subTypeLabels[type];
                }
            });
            
            // ===== BILLING CYCLE OPTIONS =====
            document.querySelectorAll('.billing-option').forEach(opt => {
                const cycle = opt.dataset.cycle;
                const title = opt.querySelector('.billing-option-title');
                if (cycle === 'monthly' && title) {
                    title.textContent = isArabic ? '' : 'Monthly';
                } else if (cycle === 'yearly' && title) {
                    title.textContent = isArabic ? '' : 'Yearly';
                }
            });
            
            // ===== EMPIRE MODAL - Type Labels =====
            const assetTypeLabels = {
                'savings': isArabic ? '' : 'Savings',
                'investment': isArabic ? '' : 'Investment',
                'property': isArabic ? '' : 'Property',
                'vehicle': isArabic ? '' : 'Vehicle',
                'crypto': isArabic ? ' ' : 'Crypto',
                'other': isArabic ? '' : 'Other'
            };
            document.querySelectorAll('.empire-type-item[data-category="asset"]').forEach(item => {
                const type = item.dataset.type;
                const label = item.querySelector('.empire-type-item-label');
                if (label && assetTypeLabels[type]) {
                    label.textContent = assetTypeLabels[type];
                }
            });
            
            const liabilityTypeLabels = {
                'credit': isArabic ? ' ' : 'Credit Card',
                'loan': isArabic ? '' : 'Loan',
                'mortgage': isArabic ? '' : 'Mortgage',
                'other': isArabic ? '' : 'Other'
            };
            document.querySelectorAll('.empire-type-item[data-category="liability"]').forEach(item => {
                const type = item.dataset.type;
                const label = item.querySelector('.empire-type-item-label');
                if (label && liabilityTypeLabels[type]) {
                    label.textContent = liabilityTypeLabels[type];
                }
            });
            
            // ===== ALL MODAL TITLES =====
            document.querySelectorAll('.modal-title').forEach(title => {
                const text = title.textContent.trim();
                if (text === 'Add Debt' || text === ' ') title.textContent = isArabic ? ' ' : 'Add Debt';
                if (text === 'Edit Debt' || text === ' ') title.textContent = isArabic ? ' ' : 'Edit Debt';
                if (text === 'Make Payment' || text === ' ') title.textContent = isArabic ? ' ' : 'Make Payment';
                if (text === 'Add Goal' || text === ' ') title.textContent = isArabic ? ' ' : 'Add Goal';
                if (text === 'Edit Goal' || text === ' ') title.textContent = isArabic ? ' ' : 'Edit Goal';
                if (text === 'Add Money' || text === ' ') title.textContent = isArabic ? ' ' : 'Add Money';
                if (text === 'Add Asset' || text === ' ') title.textContent = isArabic ? ' ' : 'Add Asset';
                if (text === 'Edit Asset' || text === ' ') title.textContent = isArabic ? ' ' : 'Edit Asset';
                if (text === 'Add Liability' || text === ' ') title.textContent = isArabic ? ' ' : 'Add Liability';
                if (text === 'Edit Liability' || text === ' ') title.textContent = isArabic ? ' ' : 'Edit Liability';
                if (text === 'Add Subscription' || text === ' ') title.textContent = isArabic ? ' ' : 'Add Subscription';
                if (text === 'Edit Subscription' || text === ' ') title.textContent = isArabic ? ' ' : 'Edit Subscription';
                if (text === 'Add Friend' || text === ' ') title.textContent = isArabic ? ' ' : 'Add Friend';
                if (text === 'Create Group' || text === ' ') title.textContent = isArabic ? ' ' : 'Create Group';
                if (text === 'Add Expense' || text === ' ') title.textContent = isArabic ? ' ' : 'Add Expense';
            });
            
            // ===== ALL SAVE/SUBMIT BUTTONS =====
            document.querySelectorAll('.modal-save-btn').forEach(btn => {
                const text = btn.textContent.trim();
                if (text === 'Save' || text === '') btn.textContent = isArabic ? '' : 'Save';
                if (text === 'Add Debt' || text === ' ') btn.textContent = isArabic ? ' ' : 'Add Debt';
                if (text === 'Save Debt' || text === ' ') btn.textContent = isArabic ? ' ' : 'Save Debt';
                if (text === 'Pay' || text === '') btn.textContent = isArabic ? '' : 'Pay';
                if (text === 'Add Goal' || text === ' ') btn.textContent = isArabic ? ' ' : 'Add Goal';
                if (text === 'Save Goal' || text === ' ') btn.textContent = isArabic ? ' ' : 'Save Goal';
                if (text === 'Deposit' || text === '') btn.textContent = isArabic ? '' : 'Deposit';
                if (text === 'Add' || text === '') btn.textContent = isArabic ? '' : 'Add';
                if (text === 'Create' || text === '') btn.textContent = isArabic ? '' : 'Create';
            });
            
            // ===== ALL CANCEL BUTTONS =====
            document.querySelectorAll('.modal-cancel-btn').forEach(btn => {
                btn.textContent = isArabic ? '' : 'Cancel';
            });
            
            // ===== ALL DELETE BUTTONS =====
            document.querySelectorAll('.submit-btn.secondary').forEach(btn => {
                const text = btn.textContent.trim();
                if (text.includes('Delete Debt') || text.includes(' ')) btn.innerHTML = isArabic ? '  ' : ' Delete Debt';
                if (text.includes('Delete Goal') || text.includes(' ')) btn.innerHTML = isArabic ? '  ' : ' Delete Goal';
                if (text.includes('Delete Subscription') || text.includes(' ')) btn.innerHTML = isArabic ? '  ' : ' Delete Subscription';
                if (text.includes('Delete') && !text.includes('Debt') && !text.includes('Goal') && !text.includes('Subscription')) {
                    btn.innerHTML = isArabic ? ' ' : ' Delete';
                }
            });
            
            // ===== ALL INPUT LABELS =====
            document.querySelectorAll('.input-label').forEach(label => {
                const text = label.textContent.trim();
                // Debt Modal
                if (text === 'Debt Type') label.textContent = isArabic ? ' ' : 'Debt Type';
                if (text === 'Account Name') label.textContent = isArabic ? ' ' : 'Account Name';
                if (text === 'Original Amount') label.textContent = isArabic ? ' ' : 'Original Amount';
                if (text === 'Current Balance') label.textContent = isArabic ? ' ' : 'Current Balance';
                if (text === 'Interest Rate (APR %)') label.textContent = isArabic ? '  (%)' : 'Interest Rate (APR %)';
                if (text === 'Payment Amount') label.textContent = isArabic ? ' ' : 'Payment Amount';
                if (text === 'Minimum Payment') label.textContent = isArabic ? ' ' : 'Minimum Payment';
                if (text === 'Auto-Deduct Schedule') label.textContent = isArabic ? '  ' : 'Auto-Deduct Schedule';
                if (text === 'Start Date') label.textContent = isArabic ? ' ' : 'Start Date';
                // Goal Modal
                if (text === 'Goal Type') label.textContent = isArabic ? ' ' : 'Goal Type';
                if (text === 'Goal Name') label.textContent = isArabic ? ' ' : 'Goal Name';
                if (text === 'Target Amount') label.textContent = isArabic ? ' ' : 'Target Amount';
                if (text === 'Already Saved') label.textContent = isArabic ? ' ' : 'Already Saved';
                if (text === 'Target Date') label.textContent = isArabic ? ' ' : 'Target Date';
                if (text === 'Auto-Save Schedule') label.textContent = isArabic ? '  ' : 'Auto-Save Schedule';
                if (text === 'Auto-Save Amount') label.textContent = isArabic ? '  ' : 'Auto-Save Amount';
                // Subscription Modal
                if (text === 'Subscription Type') label.textContent = isArabic ? ' ' : 'Subscription Type';
                if (text === 'Subscription Name') label.textContent = isArabic ? ' ' : 'Subscription Name';
                if (text === 'Amount') label.textContent = isArabic ? '' : 'Amount';
                if (text === 'Billing Cycle') label.textContent = isArabic ? ' ' : 'Billing Cycle';
                if (text === 'Next Bill Date') label.textContent = isArabic ? '  ' : 'Next Bill Date';
                // Empire Modal
                if (text === 'Asset Type') label.textContent = isArabic ? ' ' : 'Asset Type';
                if (text === 'Liability Type') label.textContent = isArabic ? ' ' : 'Liability Type';
                if (text === 'Name') label.textContent = isArabic ? '' : 'Name';
                if (text === 'Value') label.textContent = isArabic ? '' : 'Value';
                // Split Modal
                if (text === "Friend's Name") label.textContent = isArabic ? ' ' : "Friend's Name";
                if (text === 'Email (optional)') label.textContent = isArabic ? ' ()' : 'Email (optional)';
                if (text === 'Group Name') label.textContent = isArabic ? ' ' : 'Group Name';
                if (text === 'Group Icon') label.textContent = isArabic ? ' ' : 'Group Icon';
                if (text === 'Add Members') label.textContent = isArabic ? ' ' : 'Add Members';
                if (text === 'Description') label.textContent = isArabic ? '' : 'Description';
                if (text === 'Total Amount') label.textContent = isArabic ? ' ' : 'Total Amount';
                if (text === 'Paid By') label.textContent = isArabic ? ' ' : 'Paid By';
                if (text === 'Split With') label.textContent = isArabic ? ' ' : 'Split With';
                if (text === 'Split Method') label.textContent = isArabic ? ' ' : 'Split Method';
                // Transaction Modal
                if (text === 'Category') label.textContent = isArabic ? '' : 'Category';
                if (text === 'Note') label.textContent = isArabic ? '' : 'Note';
                if (text === 'Date') label.textContent = isArabic ? '' : 'Date';
                // Settings
                if (text === 'Your Name') label.textContent = isArabic ? '' : 'Your Name';
                if (text === 'Monthly Budget') label.textContent = isArabic ? ' ' : 'Monthly Budget';
                if (text === 'Currency') label.textContent = isArabic ? '' : 'Currency';
                if (text === 'Color Theme') label.textContent = isArabic ? ' ' : 'Color Theme';
            });
            
            // ===== INPUT PLACEHOLDERS =====
            const debtNameInput = document.getElementById('debtNameInput');
            if (debtNameInput) debtNameInput.placeholder = isArabic ? ':  ' : 'e.g., Chase Visa';
            
            const goalNameInput = document.getElementById('goalNameInput');
            if (goalNameInput) goalNameInput.placeholder = isArabic ? ':  ' : 'e.g., Emergency Fund';
            
            const subNameInput = document.getElementById('subscriptionNameInput');
            if (subNameInput) subNameInput.placeholder = isArabic ? ': ' : 'e.g., Netflix';
            
            const empireNameInput = document.getElementById('empireNameInput');
            if (empireNameInput) empireNameInput.placeholder = isArabic ? ':  ' : 'e.g., Savings Account';
            
            const friendNameInput = document.getElementById('friendNameInput');
            if (friendNameInput) friendNameInput.placeholder = isArabic ? ': ' : 'e.g., John';
            
            const friendEmailInput = document.getElementById('friendEmailInput');
            if (friendEmailInput) friendEmailInput.placeholder = isArabic ? ': ahmed@email.com' : 'e.g., john@email.com';
            
            const groupNameInput = document.getElementById('groupNameInput');
            if (groupNameInput) groupNameInput.placeholder = isArabic ? ':  ' : 'e.g., Trip to Paris';
            
            const expenseDescInput = document.getElementById('expenseDescInput');
            if (expenseDescInput) expenseDescInput.placeholder = isArabic ? ':  ' : 'e.g., Dinner at restaurant';
            
            // ===== SPLIT COST EMPTY STATES =====
            document.querySelectorAll('.split-empty-text').forEach(el => {
                if (el.textContent.includes('No friends')) el.textContent = isArabic ? '   ' : 'No friends added yet';
                if (el.textContent.includes('No groups')) el.textContent = isArabic ? '   ' : 'No groups created yet';
                if (el.textContent.includes('No expenses')) el.textContent = isArabic ? '  ' : 'No expenses to split yet';
                if (el.textContent.includes('All settled')) el.textContent = isArabic ? '  ! ' : 'All settled up!';
            });
            
            document.querySelectorAll('.split-empty-btn').forEach(btn => {
                if (btn.textContent.includes('Add Your First Friend')) btn.textContent = isArabic ? '  ' : 'Add Your First Friend';
                if (btn.textContent.includes('Create Your First Group')) btn.textContent = isArabic ? '  ' : 'Create Your First Group';
            });
            
            // ===== HEALTH PAGE =====
            const outOf100 = document.querySelector('.health-score-max');
            if (outOf100) outOf100.textContent = isArabic ? ' 100' : 'out of 100';
            
            // ===== RECURRING TOGGLE =====
            const recurringLabel = document.querySelector('.recurring-toggle-label');
            if (recurringLabel) recurringLabel.textContent = isArabic ? ' ' : 'Recurring Transaction';
            
            // ===== FREQUENCY OPTIONS =====
            document.querySelectorAll('.frequency-option').forEach(opt => {
                const freq = opt.dataset.frequency;
                if (freq === 'daily') opt.textContent = isArabic ? '' : 'Daily';
                if (freq === 'weekly') opt.textContent = isArabic ? '' : 'Weekly';
                if (freq === 'biweekly') opt.textContent = isArabic ? ' ' : 'Bi-weekly';
                if (freq === 'monthly') opt.textContent = isArabic ? '' : 'Monthly';
                if (freq === 'yearly') opt.textContent = isArabic ? '' : 'Yearly';
            });
            
            // ===== HEALTH PAGE - Additional metrics =====
            document.querySelectorAll('.health-metric-name').forEach(el => {
                const text = el.textContent.trim();
                if (text === 'Debt-to-Income' || text === '  ') el.textContent = isArabic ? '  ' : 'Debt-to-Income';
                if (text === 'Net Worth Trend' || text === '  ') el.textContent = isArabic ? '  ' : 'Net Worth Trend';
            });
            
            document.querySelectorAll('.health-metric-hint').forEach(el => {
                if (el.textContent.includes('Keep debt payments') || el.textContent.includes(' ')) {
                    el.textContent = isArabic ? '     36%  ' : 'Keep debt payments under 36% of income';
                }
                if (el.textContent.includes('Growing net worth') || el.textContent.includes(' ')) {
                    el.textContent = isArabic ? '     ' : 'Growing net worth is key to financial freedom';
                }
            });
            
            document.querySelectorAll('.health-section-title').forEach(el => {
                if (el.textContent.includes('KEY METRICS') || el.textContent.includes('')) {
                    el.innerHTML = isArabic ? '  ' : ' KEY METRICS';
                }
            });
            
            // ===== DEBT PAGE - Strategy pills =====
            document.querySelectorAll('.strategy-pill').forEach(pill => {
                const strategy = pill.dataset.strategy;
                if (strategy === 'avalanche') {
                    pill.innerHTML = isArabic ? ' ( ) ' : 'Avalanche (High Interest) ';
                }
                if (strategy === 'snowball') {
                    pill.innerHTML = isArabic ? '  ( ) ' : 'Snowball (Low Balance) ';
                }
            });
            
            // ===== DEBT PAGE - Section title and add button =====
            document.querySelectorAll('.debt-section-title').forEach(el => {
                if (el.textContent.includes('Your Debts') || el.textContent.includes('')) {
                    el.innerHTML = isArabic ? ' ' : ' Your Debts';
                }
            });
            
            document.querySelectorAll('.add-debt-text-btn').forEach(btn => {
                btn.innerHTML = isArabic ? '<span>+</span>  ' : '<span>+</span> Add Debt';
            });
            
            // ===== ADD SUBSCRIPTION BUTTON =====
            document.querySelectorAll('.add-subscription-btn').forEach(btn => {
                btn.innerHTML = isArabic ? '<span></span>  ' : '<span></span> Add Subscription';
            });
            
            // ===== DEPOSIT MODAL =====
            document.querySelectorAll('.modal-title').forEach(title => {
                if (title.textContent === 'Add Savings' || title.textContent === ' ') {
                    title.textContent = isArabic ? ' ' : 'Add Savings';
                }
            });
            
            document.querySelectorAll('.input-label').forEach(label => {
                if (label.textContent === 'Amount to Save' || label.textContent === ' ') {
                    label.textContent = isArabic ? ' ' : 'Amount to Save';
                }
            });
            
            document.querySelectorAll('.modal-save-btn').forEach(btn => {
                if (btn.textContent.includes('Save It') || btn.textContent.includes('')) {
                    btn.innerHTML = isArabic ? ' !' : ' Save It!';
                }
            });
            
            // ===== SETTINGS PAGE - All Sections =====
            // Profile Section
            const profileTitle = document.getElementById('profileSectionTitle');
            if (profileTitle) profileTitle.textContent = isArabic ? '  ' : ' Profile';
            
            const yourNameLabel = document.getElementById('yourNameLabel');
            if (yourNameLabel) yourNameLabel.textContent = isArabic ? '' : 'Your Name';
            
            const userNameInput = document.getElementById('userNameInput');
            if (userNameInput) userNameInput.placeholder = isArabic ? ' ' : 'Enter your name';
            
            // Budget Section
            const budgetTitle = document.getElementById('budgetSectionTitle');
            if (budgetTitle) budgetTitle.textContent = isArabic ? ' ' : ' Budget';
            
            const monthlyBudgetLabel = document.getElementById('monthlyBudgetLabel');
            if (monthlyBudgetLabel) monthlyBudgetLabel.textContent = isArabic ? ' ' : 'Monthly Budget';
            
            const currencyLabel = document.getElementById('currencyLabel');
            if (currencyLabel) currencyLabel.textContent = isArabic ? '' : 'Currency';
            
            // Appearance
            const appearanceTitle = document.getElementById('appearanceSectionTitle');
            if (appearanceTitle) appearanceTitle.textContent = isArabic ? ' ' : ' Appearance';
            
            const colorThemeLabel = document.getElementById('colorThemeLabel');
            if (colorThemeLabel) colorThemeLabel.textContent = isArabic ? ' ' : 'Color Theme';
            
            const themeDisabledHint = document.getElementById('themeDisabledHint');
            if (themeDisabledHint) themeDisabledHint.textContent = isArabic ? '    ' : 'Themes disabled when dark mode is on';
            
            // Categories
            const categoriesTitle = document.getElementById('categoriesSectionTitle');
            if (categoriesTitle) categoriesTitle.textContent = isArabic ? '  ' : ' Custom Categories';
            
            const newCategoryInput = document.getElementById('newCategoryName');
            if (newCategoryInput) newCategoryInput.placeholder = isArabic ? ' ' : 'Category name';
            
            // Data
            const dataTitle = document.getElementById('dataSectionTitle');
            if (dataTitle) dataTitle.textContent = isArabic ? ' ' : ' Data';
            
            const exportJsonBtn = document.getElementById('exportJsonBtn');
            if (exportJsonBtn) exportJsonBtn.textContent = isArabic ? '   (JSON)' : ' Export Data (JSON)';
            
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            if (exportCsvBtn) exportCsvBtn.textContent = isArabic ? '   CSV' : ' Export as CSV';
            
            const importDataBtn = document.getElementById('importDataBtn');
            if (importDataBtn) {
                const input = importDataBtn.querySelector('input');
                importDataBtn.innerHTML = isArabic ? '  ' : ' Import Data';
                if (input) importDataBtn.appendChild(input);
            }
            
            // Welcome Tour
            const welcomeTourTitle = document.getElementById('welcomeTourSectionTitle');
            if (welcomeTourTitle) welcomeTourTitle.textContent = isArabic ? '  ' : ' Welcome Tour';
            
            const replayTourBtn = document.getElementById('replayTourBtn');
            if (replayTourBtn) replayTourBtn.textContent = isArabic ? '   ' : ' Replay Welcome Tour';
            
            // Example Data
            const exampleDataTitle = document.getElementById('exampleDataSectionTitle');
            if (exampleDataTitle) exampleDataTitle.textContent = isArabic ? '  ' : ' Example Data';
            
            const exampleDataDesc = document.getElementById('exampleDataDesc');
            if (exampleDataDesc) exampleDataDesc.textContent = isArabic ? '    "" .      .' : 'Sample entries are marked with a purple "EXAMPLE" badge. Clear them when you\'re ready to add your own data.';
            
            const clearExamplesBtn = document.getElementById('clearExamplesBtn');
            if (clearExamplesBtn) clearExamplesBtn.textContent = isArabic ? '   ' : ' Clear All Examples';
            
            // Danger Zone
            const dangerZoneTitle = document.getElementById('dangerZoneSectionTitle');
            if (dangerZoneTitle) dangerZoneTitle.textContent = isArabic ? '  ' : ' Danger Zone';
            
            const dangerZoneDesc = document.getElementById('dangerZoneDesc');
            if (dangerZoneDesc) dangerZoneDesc.textContent = isArabic ? '           .' : 'This will permanently delete all your data including transactions, debts, goals, and more.';
            
            const resetAllBtn = document.getElementById('resetAllBtn');
            if (resetAllBtn) resetAllBtn.textContent = isArabic ? '   ' : ' Reset All Data';
            
            // About
            const aboutTitle = document.getElementById('aboutSectionTitle');
            if (aboutTitle) aboutTitle.textContent = isArabic ? '  ' : ' About';
            
            const appTagline = document.getElementById('appTagline');
            if (appTagline) appTagline.textContent = isArabic ? '  ' : 'Your personal finance companion';
            
            const dataStorageNote = document.getElementById('dataStorageNote');
            if (dataStorageNote) dataStorageNote.textContent = isArabic ? '     ' : 'All data stored locally on your device';
            
            // Custom Currency section
            const customCurrencyLabel = document.getElementById('customCurrencyLabel');
            if (customCurrencyLabel) customCurrencyLabel.textContent = isArabic ? ' ' : 'Custom Currency';
            
            const customCurrencySymbol = document.getElementById('customCurrencySymbol');
            if (customCurrencySymbol) customCurrencySymbol.placeholder = isArabic ? ' ( )' : 'Symbol (e.g. )';
            
            const customCurrencyCode = document.getElementById('customCurrencyCode');
            if (customCurrencyCode) customCurrencyCode.placeholder = isArabic ? ' ( BTC)' : 'Code (e.g. BTC)';
            
            const customCurrencySetBtn = document.getElementById('customCurrencySetBtn');
            if (customCurrencySetBtn) customCurrencySetBtn.textContent = isArabic ? '' : 'Set';
            
            const customCurrencyHint = document.getElementById('customCurrencyHint');
            if (customCurrencyHint) customCurrencyHint.textContent = isArabic ? '    ' : 'Enter any currency symbol and code';
            
            // Re-render dynamic content
            renderCategoriesOverview();
            renderTransactions();
            if (typeof renderChart === 'function') renderChart();
            
            // Re-render other pages if they have render functions
            if (typeof renderDebtList === 'function') renderDebtList();
            if (typeof updateDebtStats === 'function') updateDebtStats();
            if (typeof renderGoalsList === 'function') renderGoalsList();
            if (typeof updateGoalsStats === 'function') updateGoalsStats();
            if (typeof renderEmpireLists === 'function') renderEmpireLists();
            if (typeof updateEmpireStats === 'function') updateEmpireStats();
            if (typeof renderSubscriptionsList === 'function') renderSubscriptionsList();
            if (typeof updateSubscriptionTotals === 'function') updateSubscriptionTotals();
            if (typeof calculateHealthScore === 'function') calculateHealthScore();
            if (typeof renderSplitFriends === 'function') renderSplitFriends();
            if (typeof renderSplitGroups === 'function') renderSplitGroups();
            if (typeof renderSplitActivity === 'function') renderSplitActivity();
            if (typeof renderSplitSettlements === 'function') renderSplitSettlements();
        }
        
        function updateElement(selector, text) {
            const el = document.querySelector(selector);
            if (el) el.innerHTML = text;
        }
        
        // Initialize language on load
        function initLanguage() {
            const savedLang = localStorage.getItem('pocketflow_language') || 'ar-funny';
            setLanguage(savedLang);
        }
        
        // Get translated category name
        function getCategoryName(cat) {
            const isArabic = currentLanguage === 'ar-funny';
            const arabicNames = {
                'food': '',
                'transport': '',
                'shopping': '',
                'bills': '',
                'entertainment': '',
                'health': '',
                'income': '',
                'other': '',
                'Food': '',
                'Transport': '',
                'Shopping': '',
                'Bills': '',
                'Fun': '',
                'Health': '',
                'Income': '',
                'Other': ''
            };
            if (isArabic && arabicNames[cat.name]) {
                return arabicNames[cat.name];
            }
            if (isArabic && arabicNames[cat.id]) {
                return arabicNames[cat.id];
            }
            return cat.name;
        }

        // Default Categories
        const defaultCategories = [
            { id: 'food', name: 'Food', nameAr: '', icon: '', isDefault: true },
            { id: 'transport', name: 'Transport', nameAr: '', icon: '', isDefault: true },
            { id: 'shopping', name: 'Shopping', nameAr: '', icon: '', isDefault: true },
            { id: 'bills', name: 'Bills', nameAr: '', icon: '', isDefault: true },
            { id: 'entertainment', name: 'Fun', nameAr: '', icon: '', isDefault: true },
            { id: 'health', name: 'Health', nameAr: '', icon: '', isDefault: true },
            { id: 'income', name: 'Income', nameAr: '', icon: '', isDefault: true },
            { id: 'other', name: 'Other', nameAr: '', icon: '', isDefault: true }
        ];

        // Default sample transactions (1 income, 1 expense)
        const defaultTransactions = [
            {
                id: 'sample-income-1',
                type: 'income',
                amount: 3500,
                category: 'income',
                note: 'Monthly Salary',
                date: new Date().toISOString().split('T')[0],
                isExample: true
            },
            {
                id: 'sample-expense-1',
                type: 'expense',
                amount: 45.99,
                category: 'food',
                note: 'Grocery Shopping',
                date: new Date().toISOString().split('T')[0],
                isExample: true
            }
        ];

        // Default sample debts (2 different types)
        const defaultDebts = [
            {
                id: 1,
                name: 'Credit Card',
                type: 'credit',
                icon: '',
                balance: 2500,
                original: 5000,
                interest: 18.99,
                minPayment: 75,
                schedule: 'none',
                isExample: true
            },
            {
                id: 2,
                name: 'Car Loan',
                type: 'auto',
                icon: '',
                balance: 12000,
                original: 20000,
                interest: 6.5,
                minPayment: 350,
                schedule: 'none',
                isExample: true
            }
        ];

        // Default sample goals (2 different types)
        const defaultGoals = [
            {
                id: 1,
                name: 'Emergency Fund',
                type: 'emergency',
                icon: '',
                target: 10000,
                saved: 2500,
                dueDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                schedule: 'none',
                autoAmount: 0,
                isExample: true
            },
            {
                id: 2,
                name: 'Vacation to Japan',
                type: 'vacation',
                icon: '',
                target: 5000,
                saved: 1200,
                dueDate: new Date(Date.now() + 180 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                schedule: 'none',
                autoAmount: 0,
                isExample: true
            }
        ];

        // Default sample assets & liabilities for Empire
        const defaultAssets = [
            {
                id: 1,
                name: 'Savings Account',
                type: 'savings',
                icon: '',
                value: 8500,
                isExample: true
            },
            {
                id: 2,
                name: 'Investment Portfolio',
                type: 'investment',
                icon: '',
                value: 15000,
                isExample: true
            }
        ];

        const defaultLiabilities = [
            {
                id: 1,
                name: 'Student Loan',
                type: 'loan',
                icon: '',
                value: 25000,
                isExample: true
            }
        ];

        // Default sample subscriptions (2 different types)
        const defaultSubscriptions = [
            {
                id: 1,
                name: 'Netflix',
                type: 'streaming',
                icon: '',
                amount: 15.99,
                billingCycle: 'monthly',
                nextBillDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                isExample: true
            },
            {
                id: 2,
                name: 'Spotify',
                type: 'music',
                icon: '',
                amount: 9.99,
                billingCycle: 'monthly',
                nextBillDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                isExample: true
            }
        ];

        // Emoji options for custom categories
        const emojiOptions = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];

        // State - load from localStorage or use defaults
        let categories = JSON.parse(localStorage.getItem('pocketflow_categories')) || [...defaultCategories];
        let transactions = JSON.parse(localStorage.getItem('pocketflow_transactions')) || [...defaultTransactions];
        let budget = parseFloat(localStorage.getItem('pocketflow_budget')) || 0;
        let currency = localStorage.getItem('pocketflow_currency') || '$';
        let currencyCode = localStorage.getItem('pocketflow_currency_code') || 'USD';
        let currentTheme = localStorage.getItem('pocketflow_theme') || '';
        let isDarkMode = localStorage.getItem('pocketflow_darkmode') === 'true';
        let isFirstTime = localStorage.getItem('pocketflow_welcomed') !== 'true';
        let userName = localStorage.getItem('pocketflow_username') || 'Friend';
        let currentType = 'expense';
        let editingTransactionIndex = null;
        let selectedCategory = 'food';
        let isRecurring = false;
        let recurringFrequency = 'monthly';
        let selectedEmoji = '';
        let searchQuery = '';

        // Debt Crusher State
        let debts = JSON.parse(localStorage.getItem('pocketflow_debts')) || [...defaultDebts];
        let debtStrategy = localStorage.getItem('pocketflow_debt_strategy') || 'avalanche';
        let selectedDebtType = 'credit';
        let selectedDebtIcon = '';
        let selectedSchedule = 'weekly';
        let editingDebtId = null;
        let payingDebtId = null;

        // Wealth Builder State
        let goals = JSON.parse(localStorage.getItem('pocketflow_goals')) || [...defaultGoals];
        let selectedGoalType = 'emergency';
        let selectedGoalIcon = '';
        let selectedGoalSchedule = 'weekly';
        let editingGoalId = null;
        let depositingGoalId = null;

        // Empire (Net Worth) State
        let assets = JSON.parse(localStorage.getItem('pocketflow_assets')) || [...defaultAssets];
        let liabilities = JSON.parse(localStorage.getItem('pocketflow_liabilities')) || [...defaultLiabilities];
        let subscriptions = JSON.parse(localStorage.getItem('pocketflow_subscriptions')) || [...defaultSubscriptions];

        let selectedSubscriptionType = 'streaming';
        let selectedSubscriptionIcon = '';
        let selectedBillingCycle = 'monthly';
        let editingSubscriptionId = null;
        let empireMode = 'asset'; // 'asset' or 'liability'
        let selectedEmpireType = 'cash';
        let selectedEmpireIcon = '';
        let editingEmpireId = null;

        // ==================== 
        // SPLIT COST STATE
        // ====================
        let splitFriends = JSON.parse(localStorage.getItem('pocketflow_split_friends')) || [];
        let splitGroups = JSON.parse(localStorage.getItem('pocketflow_split_groups')) || [];
        let splitExpenses = JSON.parse(localStorage.getItem('pocketflow_split_expenses')) || [];
        let splitSettlements = JSON.parse(localStorage.getItem('pocketflow_split_settlements')) || [];
        
        let selectedGroupIcon = '';
        let selectedGroupMembers = [];
        let editingGroupId = null;
        let currentSettlementData = null;
        let currentGroupForExpense = null;
        let currentGroupId = null;
        let selectedSplitMembers = [];
        let selectedSplitMethod = 'equal';
        let selectedPayer = 'me';

        // Asset types
        const assetTypes = [
            { id: 'cash', name: 'Cash & Checking', icon: '' },
            { id: 'savings', name: 'Savings', icon: '' },
            { id: 'investments', name: 'Investments', icon: '' },
            { id: 'realestate', name: 'Real Estate', icon: '' },
            { id: 'vehicles', name: 'Vehicles', icon: '' },
            { id: 'equipment', name: 'Equipment', icon: '' },
            { id: 'valuables', name: 'Valuables', icon: '' },
            { id: 'crypto', name: 'Crypto', icon: '' },
            { id: 'other', name: 'Other', icon: '' }
        ];

        // Liability types
        const liabilityTypes = [
            { id: 'creditcard', name: 'Credit Cards', icon: '' },
            { id: 'autoloan', name: 'Auto Loans', icon: '' },
            { id: 'studentloan', name: 'Student Loans', icon: '' },
            { id: 'mortgage', name: 'Mortgage', icon: '' },
            { id: 'personal', name: 'Personal Loans', icon: '' },
            { id: 'medical', name: 'Medical Debt', icon: '' },
            { id: 'taxes', name: 'Tax Owed', icon: '' },
            { id: 'business', name: 'Business Debt', icon: '' },
            { id: 'other', name: 'Other', icon: '' }
        ];

        // Initialize
        function init() {
            // Validate and fix data
            validateData();
            
            // Initialize onboarding event listeners
            initOnboarding();

            // Apply saved theme - default to dark mode
            if (isDarkMode) {
                document.body.classList.add('theme-dark');
                localStorage.setItem('pocketflow_darkmode', 'true');
            } else if (currentTheme) {
                document.body.classList.add(currentTheme);
            }
            
            // Update dark mode buttons
            updateDarkModeButtons();
            
            // Set greeting based on time
            updateGreeting();
            
            renderCategories();
            renderCategoriesOverview();
            updateDisplay();
            renderTransactions();
            renderChart();
            renderInsights();
            updateBudgetProgress();
            setCurrentDate();
            setupEventListeners();
            initEmojiPicker();
            renderCategoryList();
            updateCurrencyDisplay();
            
            // Debt Crusher init
            renderDebtList();
            updateDebtStats();
            initDebtTypeSelector();
            processAutoPayments(); // Process any pending auto payments

            // Wealth Builder init
            renderGoalsList();
            updateGoalsStats();
            initGoalTypeSelector();
            processAutoSavings(); // Process any pending auto savings

            // Empire init
            renderEmpireLists();
            updateEmpireStats();

            // Recurring subscriptions init
            renderSubscriptionsList();
            updateSubscriptionTotals();

            // Financial Health Score init
            calculateHealthScore();
            
            // Split Cost init
            initSplitCost();
            
            // Language init
            initLanguage();
            
            // Initialize mobile-friendly click handlers for type selectors
            initMobileClickHandlers();
        }
        
        function initMobileClickHandlers() {
            // Debt type items
            document.querySelectorAll('.debt-type-item').forEach(el => {
                el.onclick = function() {
                    selectDebtType(this, this.dataset.type, this.dataset.icon);
                };
            });
            
            // Goal type items
            document.querySelectorAll('.goal-type-item').forEach(el => {
                el.onclick = function() {
                    selectGoalType(this, this.dataset.type, this.dataset.icon);
                };
            });
            
            // Empire type items
            document.querySelectorAll('.empire-type-item').forEach(el => {
                el.onclick = function() {
                    selectEmpireType(this, this.dataset.type, this.dataset.icon);
                };
            });
            
            // Subscription type items
            document.querySelectorAll('.subscription-type-item').forEach(el => {
                el.onclick = function() {
                    selectSubscriptionType(this, this.dataset.type, this.dataset.icon);
                };
            });
            
            // Schedule options
            document.querySelectorAll('.schedule-option').forEach(el => {
                el.onclick = function() {
                    selectSchedule(this, this.dataset.schedule);
                };
            });
            
            // Billing cycle options
            document.querySelectorAll('.billing-option').forEach(el => {
                el.onclick = function() {
                    selectBillingCycle(this, this.dataset.cycle);
                };
            });
            
            // Theme options
            document.querySelectorAll('.theme-option').forEach(el => {
                el.onclick = function() {
                    selectTheme(this.dataset.theme);
                };
            });
            
            // Currency options
            document.querySelectorAll('.currency-option').forEach(el => {
                el.onclick = function() {
                    selectCurrency(this.dataset.currency, this.dataset.code);
                };
            });
            
            // Frequency options (for recurring transactions)
            document.querySelectorAll('.frequency-option').forEach(el => {
                el.onclick = function() {
                    selectFrequency(this, this.dataset.freq);
                };
            });
            
            // Toggle switch
            document.querySelectorAll('.toggle-switch').forEach(el => {
                if (el.id === 'recurringToggle') {
                    el.onclick = toggleRecurring;
                }
            });
            
            // Split icon items
            document.querySelectorAll('.split-icon-item').forEach(el => {
                el.onclick = function() {
                    selectGroupIcon(this, this.dataset.icon);
                };
            });
            
            // Split member chips
            document.querySelectorAll('.split-member-chip').forEach(el => {
                const id = el.dataset.id;
                if (id) {
                    el.onclick = function() {
                        toggleGroupMember(parseInt(id), this);
                    };
                }
            });
        }

        // Validate and fix corrupt data
        function validateData() {
            // Fix goals
            goals = goals.map(g => ({
                ...g,
                target: parseFloat(g.target) || 0,
                saved: parseFloat(g.saved) || 0,
                autoAmount: parseFloat(g.autoAmount) || 0
            })).filter(g => g.name && g.target > 0);

            // Fix debts
            debts = debts.map(d => ({
                ...d,
                balance: parseFloat(d.balance) || 0,
                original: parseFloat(d.original) || parseFloat(d.balance) || 0,
                interest: parseFloat(d.interest) || 0,
                minPayment: parseFloat(d.minPayment) || 0
            })).filter(d => d.name);

            // Fix assets
            assets = assets.map(a => ({
                ...a,
                value: parseFloat(a.value) || 0
            })).filter(a => a.name);

            // Fix liabilities
            liabilities = liabilities.map(l => ({
                ...l,
                value: parseFloat(l.value) || 0
            })).filter(l => l.name);

            // Fix subscriptions
            subscriptions = subscriptions.map(s => ({
                ...s,
                amount: parseFloat(s.amount) || 0
            })).filter(s => s.name);

            // Fix transactions
            transactions = transactions.map(t => ({
                ...t,
                amount: parseFloat(t.amount) || 0
            })).filter(t => t.amount > 0);
        }

        // ==================
        // ONBOARDING SLIDESHOW
        // ==================
        let currentSlide = 'lang'; // Start with language selection
        const slideOrder = ['lang', 0, 1, 2, 3, 4];
        const totalSlides = 6;
        let onboardingLang = 'en';
        
        // Onboarding translations
        const onboardingText = {
            en: {
                welcomeTitle: 'Welcome to<br><span>CashFlow Pro</span>',
                welcomeText: 'Your all-in-one personal finance companion. Take control of your money today.',
                trackTitle: 'Track Everything',
                trackText: 'Log income and expenses in seconds with beautiful insights.',
                trackFeature1: ' Quick transaction entry',
                trackFeature2: ' Smart categories',
                trackFeature3: ' Monthly reports',
                debtTitle: 'Crush Your Debts',
                debtText: 'Use proven strategies to become debt-free faster.',
                debtFeature1: ' Avalanche & Snowball methods',
                debtFeature2: ' Auto-payment tracking',
                debtFeature3: ' Progress celebrations',
                empireTitle: 'Build Your Empire',
                empireText: 'Set goals, track net worth, and watch your wealth grow.',
                empireFeature1: ' Savings goals',
                empireFeature2: ' Net worth tracking',
                empireFeature3: ' Financial health score',
                letsGoTitle: "Let's Go!",
                letsGoText: 'What should we call you?',
                namePlaceholder: 'Enter your name',
                skip: 'Skip',
                next: 'Next ',
                finish: "Let's Go! ",
                welcomeToast: "Welcome, {name}! Let's build your wealth! "
            },
            'ar-funny': {
                welcomeTitle: '  <br><span>  </span>',
                welcomeText: '  !      .',
                trackTitle: '   ',
                trackText: '      .',
                trackFeature1: '   ',
                trackFeature2: '  ',
                trackFeature3: '  ',
                debtTitle: '  ',
                debtText: '       .',
                debtFeature1: '     ',
                debtFeature2: '   ',
                debtFeature3: '    ',
                empireTitle: '  ',
                empireText: '      .',
                empireFeature1: '  ',
                empireFeature2: '   ',
                empireFeature3: '   ',
                letsGoTitle: '  !',
                letsGoText: ' ',
                namePlaceholder: '   ',
                skip: '',
                next: ' ',
                finish: '! ',
                welcomeToast: ' {name}!   ! '
            }
        };
        
        function selectOnboardingLanguage(lang) {
            onboardingLang = lang;
            currentLanguage = lang;
            localStorage.setItem('pocketflow_language', lang);
            
            // Apply language to onboarding
            applyOnboardingLanguage();
            
            // Set RTL for Arabic
            if (lang === 'ar-funny') {
                document.documentElement.setAttribute('dir', 'rtl');
                document.body.style.fontFamily = "'Noto Sans Arabic', 'DM Sans', sans-serif";
            } else {
                document.documentElement.setAttribute('dir', 'ltr');
                document.body.style.fontFamily = "'DM Sans', sans-serif";
            }
            
            // Move to next slide - with retry if not ready
            function tryNextSlide() {
                if (window.nextOnboardingSlide) {
                    window.nextOnboardingSlide();
                } else {
                    setTimeout(tryNextSlide, 50);
                }
            }
            tryNextSlide();
        }
        
        // Register globally immediately
        window.selectOnboardingLanguage = selectOnboardingLanguage;
        
        function applyOnboardingLanguage() {
            const t = onboardingText[onboardingLang];
            if (!t) return;
            
            // Update all onboarding text with null checks
            const welcomeTitle = document.getElementById('welcomeTitle');
            const welcomeText = document.getElementById('welcomeText');
            const trackTitle = document.getElementById('trackTitle');
            const trackText = document.getElementById('trackText');
            const trackFeature1 = document.getElementById('trackFeature1');
            const trackFeature2 = document.getElementById('trackFeature2');
            const trackFeature3 = document.getElementById('trackFeature3');
            const debtTitle = document.getElementById('debtTitle');
            const debtText = document.getElementById('debtText');
            const debtFeature1 = document.getElementById('debtFeature1');
            const debtFeature2 = document.getElementById('debtFeature2');
            const debtFeature3 = document.getElementById('debtFeature3');
            const empireTitle = document.getElementById('empireTitle');
            const empireText = document.getElementById('empireText');
            const empireFeature1 = document.getElementById('empireFeature1');
            const empireFeature2 = document.getElementById('empireFeature2');
            const empireFeature3 = document.getElementById('empireFeature3');
            const letsGoTitle = document.getElementById('letsGoTitle');
            const letsGoText = document.getElementById('letsGoText');
            const nameInput = document.getElementById('nameInput');
            const btnSkip = document.getElementById('btnSkip');
            const btnNext = document.getElementById('btnNext');
            
            if (welcomeTitle) welcomeTitle.innerHTML = t.welcomeTitle;
            if (welcomeText) welcomeText.textContent = t.welcomeText;
            if (trackTitle) trackTitle.textContent = t.trackTitle;
            if (trackText) trackText.textContent = t.trackText;
            if (trackFeature1) trackFeature1.textContent = t.trackFeature1;
            if (trackFeature2) trackFeature2.textContent = t.trackFeature2;
            if (trackFeature3) trackFeature3.textContent = t.trackFeature3;
            if (debtTitle) debtTitle.textContent = t.debtTitle;
            if (debtText) debtText.textContent = t.debtText;
            if (debtFeature1) debtFeature1.textContent = t.debtFeature1;
            if (debtFeature2) debtFeature2.textContent = t.debtFeature2;
            if (debtFeature3) debtFeature3.textContent = t.debtFeature3;
            if (empireTitle) empireTitle.textContent = t.empireTitle;
            if (empireText) empireText.textContent = t.empireText;
            if (empireFeature1) empireFeature1.textContent = t.empireFeature1;
            if (empireFeature2) empireFeature2.textContent = t.empireFeature2;
            if (empireFeature3) empireFeature3.textContent = t.empireFeature3;
            if (letsGoTitle) letsGoTitle.textContent = t.letsGoTitle;
            if (letsGoText) letsGoText.textContent = t.letsGoText;
            if (nameInput) nameInput.placeholder = t.namePlaceholder;
            if (btnSkip) btnSkip.textContent = t.skip;
            if (btnNext) btnNext.textContent = t.next;
        }
        
        function initOnboarding() {
            const onboarding = document.getElementById('onboarding');
            const btnNext = document.getElementById('btnNext');
            const btnSkip = document.getElementById('btnSkip');
            const dots = document.querySelectorAll('.dot');
            const nameInput = document.getElementById('nameInput');

            function showSlide(slideId) {
                const index = slideOrder.indexOf(slideId);
                if (index === -1) return;
                
                // Update slides
                document.querySelectorAll('.slide').forEach((slide) => {
                    const slideIdAttr = slide.id.replace('slide-', '');
                    const slideIdNum = slideIdAttr === 'lang' ? 'lang' : parseInt(slideIdAttr);
                    const slideIndex = slideOrder.indexOf(slideIdNum);
                    
                    slide.classList.remove('active', 'exit');
                    if (slideIdNum === slideId || (typeof slideId === 'number' && slideIdNum === slideId)) {
                        slide.classList.add('active');
                    } else if (slideIndex < index && slideIndex !== -1) {
                        slide.classList.add('exit');
                    }
                });

                // Update dots
                dots.forEach((dot, i) => {
                    dot.classList.toggle('active', i === index);
                });

                // Update button text based on language
                const t = onboardingText[onboardingLang];
                if (slideId === 'lang') {
                    btnNext.style.display = 'none';
                    btnSkip.style.display = 'none';
                } else if (index === totalSlides - 1) {
                    btnNext.textContent = t.finish;
                    btnNext.classList.add('finish');
                    btnNext.style.display = 'block';
                    btnSkip.style.display = 'none';
                } else {
                    btnNext.textContent = t.next;
                    btnNext.classList.remove('finish');
                    btnNext.style.display = 'block';
                    btnSkip.style.display = 'block';
                }

                currentSlide = slideId;
            }

            function nextSlide(e) {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                const currentIndex = slideOrder.indexOf(currentSlide);
                if (currentIndex < totalSlides - 1) {
                    showSlide(slideOrder[currentIndex + 1]);
                } else {
                    completeOnboarding();
                }
            }

            function completeOnboarding(e) {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                const name = nameInput ? nameInput.value.trim() : '';
                const defaultName = onboardingLang === 'ar-funny' ? ' ' : 'Friend';
                userName = name || defaultName;
                localStorage.setItem('pocketflow_welcomed', 'true');
                localStorage.setItem('pocketflow_username', userName);
                
                onboarding.style.opacity = '0';
                onboarding.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    onboarding.classList.add('hidden');
                    onboarding.style.opacity = '';
                }, 300);

                // Apply language to main app
                setLanguage(onboardingLang);
                updateGreeting();
                
                const toastMsg = onboardingText[onboardingLang].welcomeToast.replace('{name}', userName);
                showToast(toastMsg);
            }

            // Event listeners - use both click and touchend for iOS
            if (btnNext) {
                btnNext.onclick = nextSlide;
                btnNext.ontouchend = function(e) {
                    e.preventDefault();
                    nextSlide(e);
                };
            }
            if (btnSkip) {
                btnSkip.onclick = completeOnboarding;
                btnSkip.ontouchend = function(e) {
                    e.preventDefault();
                    completeOnboarding(e);
                };
            }
            dots.forEach((dot, i) => {
                const slideId = slideOrder[i];
                dot.onclick = function() { showSlide(slideId); };
                dot.ontouchend = function(e) {
                    e.preventDefault();
                    showSlide(slideId);
                };
            });

            // Store functions globally for inline onclick handlers (iOS fix)
            window.showOnboardingSlide = showSlide;
            window.nextOnboardingSlide = nextSlide;
            window.skipOnboarding = completeOnboarding;
            window.selectOnboardingLanguage = selectOnboardingLanguage;
            
            // Show language slide initially
            showSlide('lang');
        }

        function replayOnboarding() {
            currentSlide = 'lang';
            onboardingLang = 'en';
            if (window.showOnboardingSlide) {
                window.showOnboardingSlide('lang');
            }
            const nameInput = document.getElementById('nameInput');
            if (nameInput) nameInput.value = '';
            
            const onboarding = document.getElementById('onboarding');
            onboarding.classList.remove('hidden');
            onboarding.style.opacity = '1';
            
            switchPage('cashflow');
        }

        // Financial Health Score functions
        function calculateHealthScore() {
            let score = 0;
            let metrics = [];
            let tips = [];
            const isArabic = currentLanguage === 'ar-funny';

            // Get financial data
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const totalDebt = debts.reduce((sum, d) => sum + d.balance, 0);
            const totalSavings = goals.reduce((sum, g) => sum + g.saved, 0);
            const totalAssets = assets.reduce((sum, a) => sum + a.value, 0);
            const totalLiabilities = liabilities.reduce((sum, l) => sum + l.value, 0);
            const netWorth = totalAssets - totalLiabilities;
            const monthlySubscriptions = subscriptions.reduce((sum, s) => {
                return sum + (s.billingCycle === 'yearly' ? s.amount / 12 : s.amount);
            }, 0);

            // 1. Savings Rate (25 points max)
            let savingsRate = 0;
            if (income > 0) {
                savingsRate = ((income - expenses) / income) * 100;
            }
            let savingsScore = Math.min(25, Math.max(0, savingsRate * 1.25));
            let savingsStatus = savingsRate >= 20 ? 'good' : savingsRate >= 10 ? 'warning' : 'bad';
            metrics.push({
                name: isArabic ? ' ' : 'Savings Rate',
                icon: '',
                iconClass: 'green',
                value: `${savingsRate.toFixed(0)}%`,
                status: savingsStatus,
                bar: Math.min(100, savingsRate * 5),
                description: isArabic ? '  ' : 'Percentage of income saved'
            });
            score += savingsScore;

            if (savingsRate < 20) {
                tips.push({ icon: '', text: isArabic ? '<strong> :</strong>     20%  .    .' : '<strong>Boost your savings:</strong> Try to save at least 20% of your income. Start small and increase gradually.' });
            }

            // 2. Debt-to-Income Ratio (25 points max)
            let debtRatio = 0;
            if (income > 0) {
                debtRatio = (totalDebt / (income * 12)) * 100; // Annual comparison
            }
            let debtScore = Math.max(0, 25 - (debtRatio * 0.5));
            let debtStatus = debtRatio <= 20 ? 'good' : debtRatio <= 40 ? 'warning' : 'bad';
            metrics.push({
                name: isArabic ? '  ' : 'Debt-to-Income',
                icon: '',
                iconClass: 'red',
                value: `${debtRatio.toFixed(0)}%`,
                status: debtStatus,
                bar: Math.min(100, 100 - debtRatio),
                description: isArabic ? '    ' : 'Total debt vs annual income'
            });
            score += debtScore;

            if (debtRatio > 20) {
                tips.push({ icon: '', text: isArabic ? '<strong> :</strong>        .' : '<strong>Reduce debt:</strong> Focus on paying off high-interest debt first using the avalanche method.' });
            }

            // 3. Emergency Fund (20 points max)
            const emergencyGoal = goals.find(g => g.type === 'emergency');
            let emergencyMonths = 0;
            if (expenses > 0 && emergencyGoal) {
                emergencyMonths = emergencyGoal.saved / (expenses || 1);
            } else if (expenses > 0 && totalSavings > 0) {
                emergencyMonths = totalSavings / expenses;
            }
            let emergencyScore = Math.min(20, emergencyMonths * 3.33);
            let emergencyStatus = emergencyMonths >= 6 ? 'good' : emergencyMonths >= 3 ? 'warning' : 'bad';
            metrics.push({
                name: isArabic ? ' ' : 'Emergency Fund',
                icon: '',
                iconClass: 'blue',
                value: isArabic ? `${emergencyMonths.toFixed(1)} ` : `${emergencyMonths.toFixed(1)} mo`,
                status: emergencyStatus,
                bar: Math.min(100, (emergencyMonths / 6) * 100),
                description: isArabic ? '  ' : 'Months of expenses covered'
            });
            score += emergencyScore;

            if (emergencyMonths < 6) {
                tips.push({ icon: '', text: isArabic ? '<strong>  :</strong>    3-6   .' : '<strong>Build emergency fund:</strong> Aim for 3-6 months of expenses saved for unexpected situations.' });
            }

            // 4. Budget Adherence (15 points max)
            let budgetAdherence = 100;
            if (budget > 0) {
                budgetAdherence = Math.max(0, 100 - ((expenses / budget) * 100 - 100));
            }
            let budgetScore = Math.min(15, budgetAdherence * 0.15);
            let budgetStatus = budgetAdherence >= 90 ? 'good' : budgetAdherence >= 70 ? 'warning' : 'bad';
            metrics.push({
                name: isArabic ? ' ' : 'Budget Control',
                icon: '',
                iconClass: 'purple',
                value: `${Math.min(100, budgetAdherence).toFixed(0)}%`,
                status: budgetStatus,
                bar: Math.min(100, budgetAdherence),
                description: isArabic ? ' ' : 'Staying within budget'
            });
            score += budgetScore;

            if (budgetAdherence < 90) {
                tips.push({ icon: '', text: isArabic ? '<strong> :</strong>       .' : '<strong>Stick to budget:</strong> Review your spending categories and identify areas to cut back.' });
            }

            // 5. Net Worth Trend (15 points max)
            let netWorthScore = 15;
            let netWorthStatus = 'good';
            if (netWorth < 0) {
                netWorthScore = 5;
                netWorthStatus = 'bad';
            } else if (netWorth < totalAssets * 0.5) {
                netWorthScore = 10;
                netWorthStatus = 'warning';
            }
            metrics.push({
                name: isArabic ? ' ' : 'Net Worth',
                icon: '',
                iconClass: 'orange',
                value: formatCurrency(netWorth),
                status: netWorthStatus,
                bar: netWorth > 0 ? Math.min(100, (netWorth / (totalAssets || 1)) * 100) : 0,
                description: isArabic ? '  ' : 'Assets minus liabilities'
            });
            score += netWorthScore;

            if (netWorth < 0) {
                tips.push({ icon: '', text: isArabic ? '<strong> :</strong>        .' : '<strong>Grow net worth:</strong> Focus on reducing liabilities and building assets over time.' });
            }

            // Round final score
            score = Math.round(Math.min(100, Math.max(0, score)));

            // Determine status text and color
            let statusText = '';
            let scoreColor = '';
            if (score >= 80) {
                statusText = isArabic ? '! ' : 'Excellent! ';
                scoreColor = '#10b981';
            } else if (score >= 60) {
                statusText = isArabic ? '! ' : 'Good Progress ';
                scoreColor = '#10b981';
            } else if (score >= 40) {
                statusText = isArabic ? '  ' : 'Needs Work ';
                scoreColor = '#f59e0b';
            } else {
                statusText = isArabic ? '  ' : 'Getting Started ';
                scoreColor = '#ef4444';
            }

            // Add general tips if score is low
            if (tips.length === 0) {
                tips.push({ icon: '', text: isArabic ? '<strong> !</strong>     .    .' : '<strong>Great job!</strong> Keep up the excellent financial habits. Consider setting new goals to continue growing.' });
            }

            // Update UI
            renderHealthScore(score, scoreColor, statusText, metrics, tips);
        }

        function renderHealthScore(score, scoreColor, statusText, metrics, tips) {
            // Update score circle
            const ring = document.getElementById('healthScoreRing');
            const value = document.getElementById('healthScoreValue');
            const status = document.getElementById('healthScoreStatus');

            ring.style.setProperty('--score', score);
            ring.style.setProperty('--score-color', scoreColor);
            value.textContent = score;
            value.style.color = scoreColor;
            status.textContent = statusText;
            status.style.color = scoreColor;

            // Render metrics
            const metricsContainer = document.getElementById('healthMetrics');
            metricsContainer.innerHTML = metrics.map(m => `
                <div class="health-metric">
                    <div class="health-metric-header">
                        <div class="health-metric-info">
                            <div class="health-metric-icon ${m.iconClass}">${m.icon}</div>
                            <div class="health-metric-name">${m.name}</div>
                        </div>
                        <div class="health-metric-value ${m.status}">${m.value}</div>
                    </div>
                    <div class="health-metric-bar">
                        <div class="health-metric-bar-fill ${m.status}" style="width: ${m.bar}%"></div>
                    </div>
                </div>
            `).join('');

            // Render tips
            const tipsContainer = document.getElementById('healthTips');
            tipsContainer.innerHTML = tips.map(t => `
                <div class="health-tip">
                    <div class="health-tip-icon">${t.icon}</div>
                    <div class="health-tip-text">${t.text}</div>
                </div>
            `).join('');
        }

        function initEmojiPicker() {
            const grid = document.getElementById('emojiGrid');
            grid.innerHTML = emojiOptions.map(emoji => 
                `<div class="emoji-option" onclick="selectEmoji('${emoji}')">${emoji}</div>`
            ).join('');
        }

        function toggleEmojiPicker() {
            const grid = document.getElementById('emojiGrid');
            grid.style.display = grid.style.display === 'none' ? 'grid' : 'none';
        }

        function selectEmoji(emoji) {
            selectedEmoji = emoji;
            document.getElementById('selectedEmoji').textContent = emoji;
            document.getElementById('emojiGrid').style.display = 'none';
        }

        function updateCurrencyDisplay() {
            document.querySelectorAll('.currency-symbol').forEach(el => {
                el.textContent = currency;
            });
            document.querySelectorAll('.currency-option').forEach(el => {
                el.classList.toggle('active', el.dataset.currency === currency);
            });
        }

        function setCurrentDate() {
            const now = new Date();
            const options = { month: 'short', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
        }

        function updateGreeting() {
            const hour = new Date().getHours();
            const isArabic = currentLanguage === 'ar-funny';
            let greeting;
            
            if (hour < 12) {
                greeting = isArabic ? ' ' : 'Good morning,';
            } else if (hour < 18) {
                greeting = isArabic ? '  ' : 'Good afternoon,';
            } else {
                greeting = isArabic ? ' ' : 'Good evening,';
            }
            
            document.getElementById('greetingText').textContent = greeting;
            document.getElementById('userName').textContent = userName || (isArabic ? ' ' : 'Friend');
        }

        function updateDarkModeButtons() {
            const icon = isDarkMode ? '' : '';
            document.querySelectorAll('.dark-mode-btn').forEach(btn => {
                btn.textContent = icon;
            });
        }

        function renderCategoriesOverview() {
            const container = document.getElementById('categoriesScroll');
            const expenseCategories = categories.filter(c => c.id !== 'income');
            const isArabic = currentLanguage === 'ar-funny';
            
            // Calculate spending per category for current month
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthExpenses = transactions.filter(t => 
                t.type === 'expense' && new Date(t.date) >= monthStart
            );
            
            const categoryTotals = {};
            let totalExpenses = 0;
            monthExpenses.forEach(t => {
                categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
                totalExpenses += t.amount;
            });
            
            // Start with "All" category
            let html = `
                <div class="category-chip ${!searchQuery ? 'selected' : ''}" onclick="filterByCategory('all')">
                    <span class="category-chip-icon"></span>
                    <span class="category-chip-name">${isArabic ? '' : 'All'}</span>
                    <span class="category-chip-amount">${formatCurrency(totalExpenses)}</span>
                </div>
            `;
            
            html += expenseCategories.map(cat => `
                <div class="category-chip ${searchQuery === cat.name ? 'selected' : ''}" onclick="filterByCategory('${cat.id}')">
                    <span class="category-chip-icon">${cat.icon}</span>
                    <span class="category-chip-name">${getCategoryName(cat)}</span>
                    <span class="category-chip-amount">${categoryTotals[cat.id] ? formatCurrency(categoryTotals[cat.id]) : formatCurrency(0)}</span>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function filterByCategory(categoryId) {
            if (categoryId === 'all') {
                document.getElementById('searchInput').value = '';
                searchQuery = '';
            } else {
                const catName = categories.find(c => c.id === categoryId)?.name || '';
                document.getElementById('searchInput').value = catName;
                searchQuery = catName;
            }
            renderTransactions();
            renderCategoriesOverview();
        }

        function renderCategories() {
            const container = document.getElementById('modalCategories');
            const expenseCategories = categories.filter(c => c.id !== 'income');
            
            container.innerHTML = expenseCategories.map(cat => `
                <div class="category-item ${cat.id === selectedCategory ? 'selected' : ''}" data-cat-id="${cat.id}">
                    <span class="category-icon">${cat.icon}</span>
                    <span class="category-name">${getCategoryName(cat)}</span>
                </div>
            `).join('');
            
            // Add click handlers
            container.querySelectorAll('.category-item').forEach(el => {
                el.onclick = function() {
                    selectCategory(this.dataset.catId, this);
                };
            });
        }

        function selectCategory(id, element) {
            selectedCategory = id;
            document.querySelectorAll('.modal-categories .category-item').forEach(el => {
                el.classList.remove('selected');
            });
            if (element) {
                element.classList.add('selected');
            }
        }

        function updateDisplay() {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = income - expense;

            document.getElementById('balance').textContent = formatCurrency(balance);
            document.getElementById('totalIncome').textContent = formatCurrency(income);
            document.getElementById('totalExpense').textContent = formatCurrency(expense);
        }

        function formatCurrency(amount) {
            return currency + Math.abs(amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function renderInsights() {
            const expenses = transactions.filter(t => t.type === 'expense');
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = expenses.reduce((sum, t) => sum + t.amount, 0);
            
            // Average daily spending (last 30 days)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const recentExpenses = expenses.filter(t => new Date(t.date) >= thirtyDaysAgo);
            const avgDaily = recentExpenses.length > 0 ? recentExpenses.reduce((sum, t) => sum + t.amount, 0) / 30 : 0;
            
            // Top spending category
            const categoryTotals = {};
            expenses.forEach(t => {
                categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
            });
            const topCat = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1])[0];
            const topCatInfo = topCat ? categories.find(c => c.id === topCat[0]) : null;
            
            // Savings rate
            const savingsRate = income > 0 ? Math.round(((income - totalExpense) / income) * 100) : 0;
            
            document.getElementById('avgDaily')?.textContent && (document.getElementById('avgDaily').textContent = formatCurrency(avgDaily));
            document.getElementById('topCategory')?.textContent !== undefined && (document.getElementById('topCategory').textContent = topCatInfo ? topCatInfo.icon : '-');
            document.getElementById('transactionCount')?.textContent !== undefined && (document.getElementById('transactionCount').textContent = transactions.length);
            document.getElementById('savingsRate')?.textContent !== undefined && (document.getElementById('savingsRate').textContent = Math.max(0, savingsRate) + '%');
        }

        function updateBudgetProgress() {
            const progressSection = document.getElementById('budgetProgress');
            if (!progressSection) return;
            
            if (budget <= 0) {
                progressSection.style.display = 'none';
                return;
            }
            
            progressSection.style.display = 'block';
            
            // Get current month expenses
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthExpenses = transactions
                .filter(t => t.type === 'expense' && new Date(t.date) >= monthStart)
                .reduce((sum, t) => sum + t.amount, 0);
            
            const percentage = Math.min((monthExpenses / budget) * 100, 100);
            const remaining = budget - monthExpenses;
            
            const budgetAmountEl = document.getElementById('budgetProgressAmount');
            if (budgetAmountEl) {
                budgetAmountEl.textContent = `${formatCurrency(monthExpenses)} / ${formatCurrency(budget)}`;
            }
            
            const fill = document.getElementById('progressFill');
            if (fill) {
                fill.style.width = percentage + '%';
                fill.classList.remove('warning', 'danger');
                if (percentage >= 90) {
                    fill.classList.add('danger');
                } else if (percentage >= 70) {
                    fill.classList.add('warning');
                }
            }
        }

        function renderTransactions() {
            const container = document.getElementById('transactionList');
            const deleteHint = document.getElementById('deleteHint');
            const isArabic = currentLanguage === 'ar-funny';
            
            // Filter by search query
            let filtered = [...transactions];
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filtered = filtered.filter(t => {
                    const cat = categories.find(c => c.id === t.category);
                    return (t.description && t.description.toLowerCase().includes(query)) ||
                           (cat && cat.name.toLowerCase().includes(query));
                });
            }
            
            if (filtered.length === 0) {
                const emptyMsg = searchQuery 
                    ? (isArabic ? '   ' : 'No matching transactions found.')
                    : (isArabic ? '  <br>  !' : 'No transactions yet.<br>Add your first one!');
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">${searchQuery ? '' : ''}</div>
                        <p class="empty-state-text">${emptyMsg}</p>
                    </div>
                `;
                deleteHint.style.display = 'none';
                return;
            }

            deleteHint.style.display = 'none';

            // Sort by date, newest first
            const sorted = [...filtered].sort((a, b) => new Date(b.date) - new Date(a.date));

            container.innerHTML = sorted.map((t, i) => {
                const cat = categories.find(c => c.id === t.category) || categories.find(c => c.id === 'other');
                const catName = getCategoryName(cat);
                const locale = isArabic ? 'ar-SA' : 'en-US';
                const time = new Date(t.date).toLocaleTimeString(locale, { hour: 'numeric', minute: '2-digit' });
                const dateStr = new Date(t.date).toLocaleDateString(locale, { month: 'short', day: 'numeric' });
                const originalIndex = transactions.indexOf(t);
                const freqText = isArabic ? {weekly: '', biweekly: ' ', monthly: '', yearly: ''} : {weekly: 'weekly', biweekly: 'biweekly', monthly: 'monthly', yearly: 'yearly'};
                const recurringBadge = t.recurring ? `<span class="recurring-badge">${freqText[t.recurringFrequency] || t.recurringFrequency}</span>` : '';
                const exampleBadge = t.isExample ? `<span class="example-badge">${isArabic ? '' : 'EXAMPLE'}</span>` : '';
                const exampleClass = t.isExample ? 'example-item' : '';
                
                return `
                    <div class="transaction-item ${exampleClass}">
                        <div class="transaction-icon ${t.category}">${cat.icon}</div>
                        <div class="transaction-details">
                            <div class="transaction-name">${t.description || catName}${recurringBadge}${exampleBadge}</div>
                            <div class="transaction-category">${catName}  ${dateStr}</div>
                        </div>
                        <div class="transaction-right">
                            <div>
                                <div class="transaction-amount ${t.type}">${t.type === 'expense' ? '' : '+'}${formatCurrency(t.amount)}</div>
                                <div class="transaction-time">${time}</div>
                            </div>
                            <div class="transaction-actions">
                                <button class="transaction-action-btn edit" onclick="editTransaction(${originalIndex})" title="${isArabic ? '' : 'Edit'}"></button>
                                <button class="transaction-action-btn delete" onclick="deleteTransaction(${originalIndex})" title="${isArabic ? '' : 'Delete'}"></button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderChart() {
            const container = document.getElementById('chart');
            if (!container) return;
            
            const isArabic = currentLanguage === 'ar-funny';
            const days = isArabic ? ['', '', '', '', '', '', ''] : ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const today = new Date();
            const todayDay = today.getDay();

            // Get last 7 days of expenses
            const dailyExpenses = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dayStart = new Date(date.setHours(0, 0, 0, 0));
                const dayEnd = new Date(date.setHours(23, 59, 59, 999));
                
                const dayExpense = transactions
                    .filter(t => t.type === 'expense' && new Date(t.date) >= dayStart && new Date(t.date) <= dayEnd)
                    .reduce((sum, t) => sum + t.amount, 0);
                
                dailyExpenses.push({
                    day: days[dayStart.getDay()],
                    amount: dayExpense,
                    isToday: i === 0
                });
            }

            const maxExpense = Math.max(...dailyExpenses.map(d => d.amount), 1);

            container.innerHTML = dailyExpenses.map(d => {
                const height = Math.max((d.amount / maxExpense) * 120, 8);
                return `
                    <div class="chart-bar-wrapper">
                        <div class="chart-bar ${d.isToday ? 'active' : ''}" style="height: ${height}px"></div>
                        <span class="chart-label">${d.day}</span>
                    </div>
                `;
            }).join('');
        }

        function openModal(type) {
            currentType = type;
            editingTransactionIndex = null;
            const modal = document.getElementById('transactionModal');
            const title = document.getElementById('modalTitle');
            const btn = document.getElementById('submitBtn');
            const categoryGroup = document.getElementById('categoryGroup');
            const isArabic = currentLanguage === 'ar-funny';

            title.textContent = type === 'income' 
                ? (isArabic ? '  ' : 'Add Income')
                : (isArabic ? '  ' : 'Add Expense');
            btn.textContent = isArabic ? '' : 'Save';
            btn.className = `modal-save-btn ${type}`;
            categoryGroup.style.display = type === 'income' ? 'none' : 'block';

            // Reset form
            document.getElementById('amountInput').value = '';
            document.getElementById('descriptionInput').value = '';

            if (type === 'income') {
                selectedCategory = 'income';
            } else {
                selectedCategory = 'food';
                renderCategories();
            }

            modal.classList.add('active');
            document.body.classList.add('modal-open');
            document.getElementById('amountInput').focus();
        }

        function editTransaction(index) {
            const t = transactions[index];
            if (!t) return;
            
            editingTransactionIndex = index;
            currentType = t.type;
            const isArabic = currentLanguage === 'ar-funny';
            
            const modal = document.getElementById('transactionModal');
            const title = document.getElementById('modalTitle');
            const btn = document.getElementById('submitBtn');
            const categoryGroup = document.getElementById('categoryGroup');

            title.textContent = t.type === 'income' 
                ? (isArabic ? ' ' : 'Edit Income')
                : (isArabic ? ' ' : 'Edit Expense');
            btn.textContent = isArabic ? '' : 'Save';
            btn.className = `modal-save-btn ${t.type}`;
            categoryGroup.style.display = t.type === 'income' ? 'none' : 'block';

            // Fill form with transaction data
            document.getElementById('amountInput').value = t.amount;
            document.getElementById('descriptionInput').value = t.description || '';
            
            if (t.type === 'income') {
                selectedCategory = 'income';
            } else {
                selectedCategory = t.category || 'food';
                renderCategories();
            }

            modal.classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (!modal) return;
            
            modal.classList.remove('active');
            document.body.classList.remove('modal-open');
            
            // Reset form fields based on modal type
            if (id === 'transactionModal') {
                document.getElementById('amountInput').value = '';
                document.getElementById('descriptionInput').value = '';
                editingTransactionIndex = null;
            } else if (id === 'debtModal') {
                document.getElementById('debtNameInput').value = '';
                document.getElementById('debtOriginalInput').value = '';
                document.getElementById('debtBalanceInput').value = '';
                document.getElementById('debtInterestInput').value = '';
                document.getElementById('debtMinPaymentInput').value = '';
                document.getElementById('debtStartDateInput').value = '';
                editingDebtId = null;
            } else if (id === 'paymentModal') {
                document.getElementById('paymentAmountInput').value = '';
                payingDebtId = null;
            } else if (id === 'goalModal') {
                document.getElementById('goalNameInput').value = '';
                document.getElementById('goalTargetInput').value = '';
                document.getElementById('goalSavedInput').value = '';
                document.getElementById('goalDueDateInput').value = '';
                document.getElementById('goalAutoAmountInput').value = '';
                editingGoalId = null;
            } else if (id === 'depositModal') {
                document.getElementById('depositAmountInput').value = '';
                depositingGoalId = null;
            } else if (id === 'empireModal') {
                document.getElementById('empireNameInput').value = '';
                document.getElementById('empireValueInput').value = '';
                document.getElementById('empireNotesInput').value = '';
                editingEmpireId = null;
            } else if (id === 'subscriptionModal') {
                document.getElementById('subscriptionNameInput').value = '';
                document.getElementById('subscriptionAmountInput').value = '';
                document.getElementById('subscriptionBillDateInput').value = '';
                editingSubscriptionId = null;
            }
        }
        
        // Make closeModal available globally for iOS
        window.closeModal = closeModal;

        function addTransaction() {
            const amount = parseFloat(document.getElementById('amountInput').value);
            const description = document.getElementById('descriptionInput').value.trim();

            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount');
                return;
            }

            if (editingTransactionIndex !== null) {
                // Update existing transaction
                transactions[editingTransactionIndex] = {
                    ...transactions[editingTransactionIndex],
                    type: currentType,
                    amount: amount,
                    description: description,
                    category: selectedCategory,
                    recurring: isRecurring,
                    recurringFrequency: isRecurring ? recurringFrequency : null
                };
                showToast('Transaction updated!');
            } else {
                // Add new transaction
                const transaction = {
                    id: Date.now(),
                    type: currentType,
                    amount: amount,
                    description: description,
                    category: selectedCategory,
                    date: new Date().toISOString(),
                    recurring: isRecurring,
                    recurringFrequency: isRecurring ? recurringFrequency : null
                };
                transactions.push(transaction);
                showToast(currentType === 'income' ? 'Income added!' : 'Expense added!');
            }

            saveData();
            updateDisplay();
            renderTransactions();
            renderCategoriesOverview();
            calculateHealthScore();
            closeModal('transactionModal');
            
            // Reset recurring toggle
            isRecurring = false;
            document.getElementById('recurringToggle').classList.remove('active');
            document.getElementById('frequencySelector').classList.remove('show');
        }

        function toggleRecurring() {
            isRecurring = !isRecurring;
            document.getElementById('recurringToggle').classList.toggle('active', isRecurring);
            document.getElementById('frequencySelector').classList.toggle('show', isRecurring);
        }
        
        function selectFrequency(element, freq) {
            recurringFrequency = freq;
            document.querySelectorAll('.frequency-option').forEach(el => {
                el.classList.remove('active');
            });
            element.classList.add('active');
        }

        function deleteTransaction(index) {
            if (confirm('Delete this transaction?')) {
                transactions.splice(index, 1);
                saveData();
                updateDisplay();
                renderTransactions();
                renderChart();
                renderInsights();
                updateBudgetProgress();
                renderCategoriesOverview();
                showToast('Transaction deleted');
            }
        }

        function openSettings() {
            document.getElementById('budgetInput').value = budget || '';
            updateCurrencyDisplay();
            renderCategoryList();
            
            // Update dark mode toggle
            document.getElementById('darkModeToggle').classList.toggle('active', isDarkMode);
            
            // Update theme picker
            document.querySelectorAll('.theme-option').forEach(el => {
                el.classList.toggle('active', el.dataset.theme === currentTheme);
            });
            
            document.getElementById('settingsModal').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function switchSettingsTab(tab) {
            document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
            
            document.querySelector(`.settings-tab[onclick*="${tab}"]`).classList.add('active');
            document.getElementById(`panel-${tab}`).classList.add('active');
        }

        function saveSettings() {
            budget = parseFloat(document.getElementById('budgetInput').value) || 0;
            localStorage.setItem('pocketflow_budget', budget);
            localStorage.setItem('pocketflow_currency', currency);
            localStorage.setItem('pocketflow_currency_code', currencyCode);
            
            updateDisplay();
            updateBudgetProgress();
            updateCurrencyDisplay();
            closeModal('settingsModal');
            showToast('Settings saved!');
        }

        function saveTheme() {
            localStorage.setItem('pocketflow_theme', currentTheme);
            localStorage.setItem('pocketflow_darkmode', isDarkMode);
            closeModal('settingsModal');
            showToast(isDarkMode ? 'Dark mode enabled!' : 'Theme applied!');
        }

        function saveAllSettings() {
            // Save user name
            userName = document.getElementById('userNameInput').value.trim() || 'Friend';
            localStorage.setItem('pocketflow_username', userName);
            
            // Save budget
            budget = parseFloat(document.getElementById('settingsBudgetInput').value) || 0;
            localStorage.setItem('pocketflow_budget', budget);
            
            // Save currency
            localStorage.setItem('pocketflow_currency', currency);
            localStorage.setItem('pocketflow_currency_code', currencyCode);
            
            // Save theme
            localStorage.setItem('pocketflow_theme', currentTheme);
            localStorage.setItem('pocketflow_darkmode', isDarkMode);
            
            // Update UI
            updateGreeting();
            updateDisplay();
            updateCurrencyDisplay();
            
            showToast('Settings saved!');
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            
            // Remove all theme classes
            document.body.classList.remove('theme-ocean', 'theme-sunset', 'theme-lavender', 'theme-rose', 'theme-forest', 'theme-dark');
            
            if (isDarkMode) {
                document.body.classList.add('theme-dark');
                // Deselect color themes in settings
                document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('active'));
            } else {
                // Re-apply saved theme when turning off dark mode
                if (currentTheme) {
                    document.body.classList.add(currentTheme);
                }
                // Update theme picker to show selected theme
                document.querySelectorAll('#page-settings .theme-option').forEach(el => {
                    el.classList.toggle('active', el.dataset.theme === currentTheme);
                });
            }
            
            // Update all dark mode buttons
            updateDarkModeButtons();
            
            localStorage.setItem('pocketflow_darkmode', isDarkMode);
            showToast(isDarkMode ? 'Dark mode on' : 'Dark mode off');
        }

        function addCustomCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            if (!name) {
                showToast('Please enter a category name');
                return;
            }
            
            const id = 'custom_' + Date.now();
            categories.push({
                id: id,
                name: name,
                icon: selectedEmoji,
                isDefault: false
            });
            
            localStorage.setItem('pocketflow_categories', JSON.stringify(categories));
            document.getElementById('newCategoryName').value = '';
            selectedEmoji = '';
            document.getElementById('selectedEmoji').textContent = '';
            renderCategoryList();
            showToast('Category added!');
        }

        function deleteCategory(id) {
            if (confirm('Delete this category?')) {
                categories = categories.filter(c => c.id !== id);
                localStorage.setItem('pocketflow_categories', JSON.stringify(categories));
                renderCategoryList();
                showToast('Category deleted');
            }
        }

        function renderCategoryList() {
            const container = document.getElementById('categoryList');
            container.innerHTML = categories.map(cat => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-primary); border-radius: var(--radius-sm); margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 20px;">${cat.icon}</span>
                        <span style="font-weight: 500;">${cat.name}</span>
                    </div>
                    ${!cat.isDefault ? `<button onclick="deleteCategory('${cat.id}')" style="background: none; border: none; color: var(--accent-red); cursor: pointer; font-size: 18px;"></button>` : '<span style="font-size: 11px; color: var(--text-muted);">Default</span>'}
                </div>
            `).join('');
        }

        function exportData() {
            const data = {
                transactions: transactions,
                categories: categories,
                budget: budget,
                currency: currency,
                currencyCode: currencyCode,
                theme: currentTheme,
                darkMode: isDarkMode,
                debts: debts,
                debtStrategy: debtStrategy,
                goals: goals,
                assets: assets,
                liabilities: liabilities,
                subscriptions: subscriptions,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cashflow-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported!');
        }

        function exportCSV() {
            const headers = ['Date', 'Type', 'Category', 'Description', 'Amount'];
            const rows = transactions.map(t => {
                const cat = categories.find(c => c.id === t.category);
                return [
                    new Date(t.date).toLocaleDateString(),
                    t.type,
                    cat ? cat.name : t.category,
                    t.description || '',
                    t.amount.toFixed(2)
                ].join(',');
            });
            
            const csv = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cashflow-transactions-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('CSV exported!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.transactions) transactions = data.transactions;
                    if (data.categories) categories = data.categories;
                    if (data.budget) budget = data.budget;
                    if (data.currency) currency = data.currency;
                    if (data.currencyCode) currencyCode = data.currencyCode;
                    if (data.debts) debts = data.debts;
                    if (data.debtStrategy) debtStrategy = data.debtStrategy;
                    if (data.goals) goals = data.goals;
                    if (data.assets) assets = data.assets;
                    if (data.liabilities) liabilities = data.liabilities;
                    if (data.subscriptions) subscriptions = data.subscriptions;
                    if (data.darkMode !== undefined) {
                        isDarkMode = data.darkMode;
                        localStorage.setItem('pocketflow_darkmode', isDarkMode);
                    }
                    if (data.theme !== undefined) {
                        currentTheme = data.theme;
                    }
                    
                    // Apply theme
                    document.body.classList.remove('theme-ocean', 'theme-sunset', 'theme-lavender', 'theme-rose', 'theme-forest', 'theme-dark');
                    if (isDarkMode) {
                        document.body.classList.add('theme-dark');
                    } else if (currentTheme) {
                        document.body.classList.add(currentTheme);
                    }
                    
                    saveData();
                    saveDebts();
                    saveGoals();
                    saveAssets();
                    saveLiabilities();
                    saveSubscriptions();
                    localStorage.setItem('pocketflow_categories', JSON.stringify(categories));
                    localStorage.setItem('pocketflow_budget', budget);
                    localStorage.setItem('pocketflow_currency', currency);
                    localStorage.setItem('pocketflow_currency_code', currencyCode);
                    localStorage.setItem('pocketflow_theme', currentTheme);
                    localStorage.setItem('pocketflow_debt_strategy', debtStrategy);
                    
                    updateDisplay();
                    renderTransactions();
                    renderChart();
                    renderInsights();
                    updateBudgetProgress();
                    updateCurrencyDisplay();
                    renderDebtList();
                    updateDebtStats();
                    renderGoalsList();
                    updateGoalsStats();
                    renderEmpireLists();
                    updateEmpireStats();
                    renderSubscriptionsList();
                    updateSubscriptionTotals();
                    
                    closeModal('settingsModal');
                    showToast('Data imported successfully!');
                } catch (err) {
                    showToast('Error importing data');
                }
            };
            reader.readAsText(file);
        }

        function saveBudget() {
            budget = parseFloat(document.getElementById('budgetInput').value) || 0;
            localStorage.setItem('pocketflow_budget', budget);
            updateBudgetProgress();
            closeModal('settingsModal');
            showToast('Budget saved!');
        }

        function resetData() {
            // Use setTimeout to ensure confirm works on iOS
            setTimeout(function() {
                if (confirm(' DELETE ALL DATA?\n\nThis will permanently erase all your financial data.\n\nThis cannot be undone!')) {
                    transactions = [];
                    budget = 0;
                    categories = [...defaultCategories];
                    currency = '$';
                    currencyCode = 'USD';
                    currentTheme = '';
                    isDarkMode = false;
                    userName = 'Friend';
                    debts = [];
                    debtStrategy = 'avalanche';
                    goals = [];
                    assets = [];
                    liabilities = [];
                    subscriptions = [];
                    
                    // Clear all pocketflow localStorage keys
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith('pocketflow_')) {
                            localStorage.removeItem(key);
                        }
                    });
                    
                    document.body.className = '';
                    updateDarkModeButtons();
                    updateGreeting();
                    updateDisplay();
                    renderTransactions();
                    renderCategoriesOverview();
                    updateCurrencyDisplay();
                    renderDebtList();
                    updateDebtStats();
                    renderGoalsList();
                    updateGoalsStats();
                    renderEmpireLists();
                    updateEmpireStats();
                    renderSubscriptionsList();
                    updateSubscriptionTotals();
                    calculateHealthScore();
                    showToast(' All data has been reset');
                    switchPage('cashflow');
                }
            }, 100);
        }

        function clearExamples() {
            // Remove all example items from each data array
            transactions = transactions.filter(t => !t.isExample);
            debts = debts.filter(d => !d.isExample);
            goals = goals.filter(g => !g.isExample);
            assets = assets.filter(a => !a.isExample);
            liabilities = liabilities.filter(l => !l.isExample);
            subscriptions = subscriptions.filter(s => !s.isExample);

            // Save to localStorage
            localStorage.setItem('pocketflow_transactions', JSON.stringify(transactions));
            localStorage.setItem('pocketflow_debts', JSON.stringify(debts));
            localStorage.setItem('pocketflow_goals', JSON.stringify(goals));
            localStorage.setItem('pocketflow_assets', JSON.stringify(assets));
            localStorage.setItem('pocketflow_liabilities', JSON.stringify(liabilities));
            localStorage.setItem('pocketflow_subscriptions', JSON.stringify(subscriptions));

            // Re-render everything
            updateDisplay();
            renderTransactions();
            renderDebtList();
            updateDebtStats();
            renderGoalsList();
            updateGoalsStats();
            renderEmpireLists();
            updateEmpireStats();
            renderSubscriptionsList();
            updateSubscriptionTotals();
            calculateHealthScore();

            showToast('All example data cleared! ');
        }

        function saveData() {
            localStorage.setItem('pocketflow_transactions', JSON.stringify(transactions));
        }

        function toggleFilter() {
            // Simple filter toggle - could expand to category filter
            showToast('Filter coming soon!');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            const isArabic = currentLanguage === 'ar-funny';
            
            // Translate common messages
            const translations = {
                'Saved!': ' ! ',
                'Settings saved!': '  ! ',
                'Deleted!': ' ! ',
                'Added!': ' ! ',
                'Transaction deleted': '  ! ',
                'Transaction saved': '  ! ',
                'Goal added!': '  ! ',
                'Goal deleted': '  ! ',
                'Debt added!': '  ! ',
                'Debt deleted': '  ! ',
                'Payment recorded!': '  ! ',
                'Deposit recorded!': '  ! ',
                'Asset added!': '  ! ',
                'Liability added!': '  ! ',
                'Subscription added!': '  ! ',
                'Subscription deleted': '  ! ',
                'Friend added!': '  ! ',
                'Group created!': '  ! ',
                'Expense added!': '  ! ',
                'Settled!': ' ! ',
                'Category added!': '  ! ',
                'Example data cleared!': '   ! ',
                'All data reset!': '   ! ',
                'Language changed!': '  ! ',
                'Dark mode enabled!': '   ! ',
                'Theme applied!': '  ! ',
                'Name saved!': '  ! ',
                'Budget saved!': '  ! ',
                'Crushed it!': '! ',
                'Goal reached!': ' ! '
            };
            
            const displayMessage = isArabic && translations[message] ? translations[message] : message;
            toast.textContent = displayMessage;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        function setupEventListeners() {
            // Close modals on overlay click
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.classList.remove('active');
                    }
                });
            });

            // Period selector
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // Enter key to submit
            document.getElementById('amountInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('descriptionInput').focus();
                }
            });

            document.getElementById('descriptionInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addTransaction();
                }
            });

            // Search input
            document.getElementById('searchInput').addEventListener('input', (e) => {
                searchQuery = e.target.value;
                renderTransactions();
            });

            // Currency selector
            document.querySelectorAll('.currency-option').forEach(opt => {
                opt.addEventListener('click', (e) => {
                    e.stopPropagation();
                    currency = opt.dataset.currency;
                    currencyCode = opt.dataset.code;
                    document.querySelectorAll('.currency-option').forEach(o => o.classList.remove('active'));
                    opt.classList.add('active');
                    updateCurrencyDisplay();
                });
            });

            // Theme selector
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Only allow theme selection if dark mode is off
                    if (isDarkMode) {
                        showToast('Turn off dark mode to use color themes');
                        return;
                    }
                    
                    document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('active'));
                    opt.classList.add('active');
                    currentTheme = opt.dataset.theme;
                    document.body.classList.remove('theme-ocean', 'theme-sunset', 'theme-lavender', 'theme-rose', 'theme-forest');
                    if (currentTheme) {
                        document.body.classList.add(currentTheme);
                    }
                });
            });

            // Frequency selector
            document.querySelectorAll('.frequency-option').forEach(opt => {
                opt.addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.frequency-option').forEach(o => o.classList.remove('active'));
                    opt.classList.add('active');
                    recurringFrequency = opt.dataset.freq;
                });
            });

            // Click outside modal to close
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.classList.remove('active');
                    }
                });
            });
        }

        // =====================
        // DEBT CRUSHER FUNCTIONS
        // =====================

        function switchPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.floating-menu-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(`page-${page}`).classList.add('active');
            const navItem = document.querySelector(`.nav-item[onclick*="${page}"]`);
            if (navItem) navItem.classList.add('active');
            
            // Update floating menu active state
            const menuItem = document.querySelector(`.floating-menu-item[onclick*="${page}"]`);
            if (menuItem) menuItem.classList.add('active');
            
            if (page === 'cashflow') {
                renderCategoriesOverview();
            } else if (page === 'debt') {
                renderDebtList();
                updateDebtStats();
            } else if (page === 'wealth') {
                renderGoalsList();
                updateGoalsStats();
            } else if (page === 'empire') {
                renderEmpireLists();
                updateEmpireStats();
            } else if (page === 'recurring') {
                renderSubscriptionsList();
                updateSubscriptionTotals();
            } else if (page === 'health') {
                updateHealthScore();
            } else if (page === 'split') {
                renderSplitFriends();
                renderSplitGroups();
                renderSplitActivity();
                renderSplitSettlements();
                updateSplitBalances();
            } else if (page === 'settings') {
                // Populate settings fields
                document.getElementById('userNameInput').value = userName;
                document.getElementById('settingsBudgetInput').value = budget || '';
                updateCurrencyDisplay();
                renderCategoryList();
                initEmojiPicker();
                initSettingsThemePicker();
                updateLangToggleButton();
            }
        }
        
        // Floating Menu Functions
        function toggleFloatingMenu() {
            const menu = document.getElementById('floatingMenu');
            const overlay = document.getElementById('floatingMenuOverlay');
            const btn = document.getElementById('floatingMenuBtn');
            
            menu.classList.toggle('active');
            overlay.classList.toggle('active');
            btn.classList.toggle('active');
            
            // Update icon
            const icon = btn.querySelector('.menu-icon');
            icon.textContent = menu.classList.contains('active') ? '' : '';
        }
        
        function switchPageFromMenu(page) {
            toggleFloatingMenu();
            switchPage(page);
        }
        
        // ================================================
        // 3D CAROUSEL NAVIGATION SYSTEM
        // ================================================
        
        const carouselPages = [
            { id: 'cashflow', icon: '', title: 'Cash Flow', titleAr: '' },
            { id: 'debt', icon: '', title: 'Debt Crusher', titleAr: ' ' },
            { id: 'wealth', icon: '', title: 'Wealth Builder', titleAr: ' ' },
            { id: 'empire', icon: '', title: 'Empire', titleAr: '' },
            { id: 'recurring', icon: '', title: 'Subscriptions', titleAr: '' },
            { id: 'health', icon: '', title: 'Financial Health', titleAr: ' ' },
            { id: 'split', icon: '', title: 'Split Costs', titleAr: ' ' },
            { id: 'settings', icon: '', title: 'Settings', titleAr: '' }
        ];
        
        let carouselActive = false;
        let currentCarouselIndex = 0;
        let carouselRotation = 0;
        let isDragging = false;
        let startX = 0;
        let currentX = 0;
        let dragStartRotation = 0;
        
        // Spring physics parameters
        const springConfig = {
            tension: 0.3,
            friction: 0.8,
            velocity: 0
        };
        
        function initCarousel() {
            const track = document.getElementById('carouselTrack');
            const dots = document.getElementById('carouselDots');
            if (!track || !dots) return;
            
            track.innerHTML = '';
            dots.innerHTML = '';
            
            carouselPages.forEach((page, index) => {
                // Create carousel page
                const pageEl = document.createElement('div');
                pageEl.className = 'carousel-page';
                pageEl.dataset.index = index;
                pageEl.dataset.pageId = page.id;
                
                const isArabic = currentLanguage === 'ar-funny';
                const title = isArabic ? page.titleAr : page.title;
                const tapText = isArabic ? ' ' : 'TAP TO OPEN';
                
                // Get preview content based on page
                const previewContent = getCarouselPreviewContent(page.id, isArabic);
                
                pageEl.innerHTML = `
                    <div class="carousel-page-preview">
                        <div class="carousel-page-preview-header">
                            <span class="carousel-page-preview-icon">${page.icon}</span>
                            <div>
                                <div class="carousel-page-preview-title">${title}</div>
                                <div class="carousel-page-preview-subtitle">${tapText}</div>
                            </div>
                        </div>
                        <div class="carousel-page-content">
                            ${previewContent}
                        </div>
                    </div>
                `;
                
                track.appendChild(pageEl);
                
                // Click to select
                pageEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!isDragging) {
                        if (index === currentCarouselIndex) {
                            selectCarouselPage(index);
                        } else {
                            rotateToPage(index);
                        }
                    }
                });
                
                // Create dot
                const dot = document.createElement('button');
                dot.className = 'carousel-dot';
                dot.dataset.index = index;
                dot.addEventListener('click', (e) => {
                    e.stopPropagation();
                    rotateToPage(index);
                });
                dots.appendChild(dot);
            });
            
            positionCarouselPages();
            updateCarouselState();
            setupCarouselGestures();
        }
        
        function positionCarouselPages() {
            const pages = document.querySelectorAll('.carousel-page');
            const totalPages = pages.length;
            
            pages.forEach((page, index) => {
                // Calculate position relative to current index
                let offset = index - currentCarouselIndex;
                
                // Handle wrapping
                if (offset > totalPages / 2) offset -= totalPages;
                if (offset < -totalPages / 2) offset += totalPages;
                
                // Position calculations
                const translateX = offset * 200; // Horizontal spacing
                const translateZ = -Math.abs(offset) * 120; // Depth
                const rotateY = offset * -25; // Rotation angle
                const scale = 1 - Math.abs(offset) * 0.15; // Scale reduction
                
                // Apply transform
                page.style.transform = `
                    translateX(${translateX}px) 
                    translateZ(${translateZ}px) 
                    rotateY(${rotateY}deg)
                    scale(${Math.max(0.6, scale)})
                `;
                
                // Z-index based on depth
                page.style.zIndex = 10 - Math.abs(offset);
                
                // Adjacent class for slightly different styling
                page.classList.remove('adjacent');
                if (Math.abs(offset) === 1) {
                    page.classList.add('adjacent');
                }
            });
        }
        
        function getCarouselPreviewContent(pageId, isArabic) {
            switch(pageId) {
                case 'cashflow':
                    const income = transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
                    const expense = transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                    const balance = income - expense;
                    return `
                        <div class="carousel-preview-stats">
                            <div class="carousel-preview-stat">
                                <div class="carousel-preview-stat-value" style="color: var(--accent-green);">${formatCurrency(income)}</div>
                                <div class="carousel-preview-stat-label">${isArabic ? '' : 'Income'}</div>
                            </div>
                            <div class="carousel-preview-stat">
                                <div class="carousel-preview-stat-value" style="color: var(--accent-red);">${formatCurrency(expense)}</div>
                                <div class="carousel-preview-stat-label">${isArabic ? '' : 'Expenses'}</div>
                            </div>
                        </div>
                        <div class="carousel-preview-stat" style="margin-top: 12px;">
                            <div class="carousel-preview-stat-value">${formatCurrency(balance)}</div>
                            <div class="carousel-preview-stat-label">${isArabic ? '' : 'Balance'}</div>
                        </div>
                    `;
                case 'debt':
                    const totalDebt = debts.reduce((s, d) => s + d.balance, 0);
                    return `
                        <div class="carousel-preview-stat">
                            <div class="carousel-preview-stat-value" style="color: var(--accent-red);">${formatCurrency(totalDebt)}</div>
                            <div class="carousel-preview-stat-label">${isArabic ? ' ' : 'Total Debt'}</div>
                        </div>
                        <div class="carousel-preview-list">
                            ${debts.slice(0, 3).map(d => `
                                <div class="carousel-preview-item">
                                    <span class="carousel-preview-item-icon">${d.icon || ''}</span>
                                    <span>${d.name}</span>
                                </div>
                            `).join('') || `<div style="color: var(--text-muted); text-align: center; padding: 20px;">${isArabic ? ' ! ' : 'No debts! '}</div>`}
                        </div>
                    `;
                case 'wealth':
                    const totalSaved = goals.reduce((s, g) => s + g.saved, 0);
                    return `
                        <div class="carousel-preview-stat">
                            <div class="carousel-preview-stat-value">${formatCurrency(totalSaved)}</div>
                            <div class="carousel-preview-stat-label">${isArabic ? ' ' : 'Total Saved'}</div>
                        </div>
                        <div class="carousel-preview-list">
                            ${goals.slice(0, 3).map(g => `
                                <div class="carousel-preview-item">
                                    <span class="carousel-preview-item-icon">${g.icon || ''}</span>
                                    <span>${g.name}</span>
                                </div>
                            `).join('') || `<div style="color: var(--text-muted); text-align: center; padding: 20px;">${isArabic ? '  ' : 'No goals yet'}</div>`}
                        </div>
                    `;
                case 'empire':
                    const totalAssets = assets.reduce((s, a) => s + a.value, 0);
                    const totalLiabilities = liabilities.reduce((s, l) => s + l.value, 0);
                    const netWorth = totalAssets - totalLiabilities;
                    return `
                        <div class="carousel-preview-stat">
                            <div class="carousel-preview-stat-value" style="color: ${netWorth >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">${formatCurrency(netWorth)}</div>
                            <div class="carousel-preview-stat-label">${isArabic ? ' ' : 'Net Worth'}</div>
                        </div>
                        <div class="carousel-preview-stats">
                            <div class="carousel-preview-stat">
                                <div class="carousel-preview-stat-value" style="font-size: 16px;">${formatCurrency(totalAssets)}</div>
                                <div class="carousel-preview-stat-label">${isArabic ? '' : 'Assets'}</div>
                            </div>
                            <div class="carousel-preview-stat">
                                <div class="carousel-preview-stat-value" style="font-size: 16px;">${formatCurrency(totalLiabilities)}</div>
                                <div class="carousel-preview-stat-label">${isArabic ? '' : 'Liabilities'}</div>
                            </div>
                        </div>
                    `;
                case 'recurring':
                    const monthlyTotal = subscriptions.filter(s => s.active !== false).reduce((sum, s) => {
                        if (s.frequency === 'weekly') return sum + (s.amount * 4);
                        if (s.frequency === 'yearly') return sum + (s.amount / 12);
                        return sum + s.amount;
                    }, 0);
                    return `
                        <div class="carousel-preview-stat">
                            <div class="carousel-preview-stat-value">${formatCurrency(monthlyTotal)}</div>
                            <div class="carousel-preview-stat-label">${isArabic ? '' : 'Monthly'}</div>
                        </div>
                        <div class="carousel-preview-list">
                            ${subscriptions.slice(0, 3).map(s => `
                                <div class="carousel-preview-item">
                                    <span class="carousel-preview-item-icon">${s.icon || ''}</span>
                                    <span>${s.name}</span>
                                </div>
                            `).join('') || `<div style="color: var(--text-muted); text-align: center; padding: 20px;">${isArabic ? ' ' : 'No subscriptions'}</div>`}
                        </div>
                    `;
                case 'health':
                    const score = calculateHealthScoreValue();
                    return `
                        <div class="carousel-preview-stat">
                            <div class="carousel-preview-stat-value" style="font-size: 48px; color: ${score >= 70 ? 'var(--accent-green)' : score >= 40 ? 'var(--accent-yellow)' : 'var(--accent-red)'};">${score}</div>
                            <div class="carousel-preview-stat-label">${isArabic ? '  ' : 'Financial Health Score'}</div>
                        </div>
                    `;
                case 'split':
                    return `
                        <div class="carousel-preview-stat">
                            <div class="carousel-preview-stat-value">${splitFriends.length}</div>
                            <div class="carousel-preview-stat-label">${isArabic ? '' : 'Friends'}</div>
                        </div>
                        <div class="carousel-preview-stat" style="margin-top: 12px;">
                            <div class="carousel-preview-stat-value">${splitGroups.length}</div>
                            <div class="carousel-preview-stat-label">${isArabic ? '' : 'Groups'}</div>
                        </div>
                    `;
                case 'settings':
                    return `
                        <div class="carousel-preview-list">
                            <div class="carousel-preview-item">
                                <span class="carousel-preview-item-icon"></span>
                                <span>${userName || 'Friend'}</span>
                            </div>
                            <div class="carousel-preview-item">
                                <span class="carousel-preview-item-icon"></span>
                                <span>${currency} ${currencyCode}</span>
                            </div>
                            <div class="carousel-preview-item">
                                <span class="carousel-preview-item-icon"></span>
                                <span>${isDarkMode ? (isArabic ? ' ' : 'Dark Mode') : (isArabic ? ' ' : 'Light Mode')}</span>
                            </div>
                            <div class="carousel-preview-item">
                                <span class="carousel-preview-item-icon"></span>
                                <span>${isArabic ? '' : 'English'}</span>
                            </div>
                        </div>
                    `;
                default:
                    return '';
            }
        }
        
        function calculateHealthScoreValue() {
            let score = 50;
            const income = transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const totalDebt = debts.reduce((s, d) => s + d.balance, 0);
            const totalSaved = goals.reduce((s, g) => s + g.saved, 0);
            
            if (income > expense) score += 15;
            if (expense < income * 0.7) score += 10;
            if (totalDebt === 0) score += 15;
            if (totalSaved > 0) score += 10;
            
            return Math.min(100, Math.max(0, score));
        }
        
        function updateCarouselState() {
            const pages = document.querySelectorAll('.carousel-page');
            const dots = document.querySelectorAll('.carousel-dot');
            
            pages.forEach((page, index) => {
                const isActive = index === currentCarouselIndex;
                page.classList.toggle('active', isActive);
            });
            
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentCarouselIndex);
            });
            
            // Update active title
            const titleText = document.getElementById('carouselActiveTitleText');
            if (titleText && carouselPages[currentCarouselIndex]) {
                const isArabic = currentLanguage === 'ar-funny';
                const page = carouselPages[currentCarouselIndex];
                titleText.textContent = isArabic ? page.titleAr : page.title;
            }
            
            // Reposition all pages
            positionCarouselPages();
        }
        
        function rotateToPage(index) {
            currentCarouselIndex = index;
            carouselRotation = 0;
            
            const track = document.getElementById('carouselTrack');
            if (track) {
                track.classList.remove('dragging');
            }
            
            updateCarouselState();
        }
        
        function animateSpring(targetOffset) {
            const track = document.getElementById('carouselTrack');
            if (!track) return;
            track.classList.remove('dragging');
        }
        
        function selectCarouselPage(index) {
            const page = carouselPages[index];
            if (!page) return;
            
            // Close carousel and switch to page
            toggleCarouselMode();
            switchPage(page.id);
        }
        
        function setupCarouselGestures() {
            const container = document.getElementById('carouselContainer');
            if (!container) return;
            
            let touchStartTime = 0;
            let startY = 0;
            let currentY = 0;
            
            // Touch events
            container.addEventListener('touchstart', (e) => {
                isDragging = false;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                currentX = startX;
                touchStartTime = Date.now();
            }, { passive: true });
            
            container.addEventListener('touchmove', (e) => {
                currentX = e.touches[0].clientX;
                currentY = e.touches[0].clientY;
                
                const diffX = Math.abs(currentX - startX);
                const diffY = Math.abs(currentY - startY);
                
                // Only start dragging if horizontal movement is greater
                if (diffX > 10 && diffX > diffY) {
                    isDragging = true;
                }
            }, { passive: true });
            
            container.addEventListener('touchend', (e) => {
                const diff = currentX - startX;
                const timeDiff = Date.now() - touchStartTime;
                const velocity = Math.abs(diff) / timeDiff;
                
                // Determine if it's a swipe
                if (Math.abs(diff) > 50 || velocity > 0.3) {
                    if (diff > 0) {
                        // Swipe right - go to previous
                        currentCarouselIndex = (currentCarouselIndex - 1 + carouselPages.length) % carouselPages.length;
                    } else {
                        // Swipe left - go to next
                        currentCarouselIndex = (currentCarouselIndex + 1) % carouselPages.length;
                    }
                    updateCarouselState();
                }
                
                setTimeout(() => {
                    isDragging = false;
                }, 100);
            });
            
            // Mouse events for desktop
            let mouseDown = false;
            
            container.addEventListener('mousedown', (e) => {
                mouseDown = true;
                isDragging = false;
                startX = e.clientX;
                currentX = startX;
            });
            
            container.addEventListener('mousemove', (e) => {
                if (!mouseDown) return;
                currentX = e.clientX;
                
                if (Math.abs(currentX - startX) > 10) {
                    isDragging = true;
                }
            });
            
            container.addEventListener('mouseup', () => {
                if (!mouseDown) return;
                mouseDown = false;
                
                const diff = currentX - startX;
                
                if (Math.abs(diff) > 80) {
                    if (diff > 0) {
                        currentCarouselIndex = (currentCarouselIndex - 1 + carouselPages.length) % carouselPages.length;
                    } else {
                        currentCarouselIndex = (currentCarouselIndex + 1) % carouselPages.length;
                    }
                    updateCarouselState();
                }
                
                setTimeout(() => {
                    isDragging = false;
                }, 100);
            });
            
            container.addEventListener('mouseleave', () => {
                mouseDown = false;
            });
            
            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (!carouselActive) return;
                
                if (e.key === 'ArrowLeft') {
                    currentCarouselIndex = (currentCarouselIndex - 1 + carouselPages.length) % carouselPages.length;
                    updateCarouselState();
                } else if (e.key === 'ArrowRight') {
                    currentCarouselIndex = (currentCarouselIndex + 1) % carouselPages.length;
                    updateCarouselState();
                } else if (e.key === 'Enter') {
                    selectCarouselPage(currentCarouselIndex);
                } else if (e.key === 'Escape') {
                    toggleCarouselMode();
                }
            });
        }
        
        function toggleCarouselMode() {
            carouselActive = !carouselActive;
            
            const container = document.getElementById('carouselContainer');
            const toggleIcon = document.getElementById('carouselToggleIcon');
            const appEl = document.querySelector('.app');
            
            if (appEl) {
                appEl.classList.toggle('carousel-mode', carouselActive);
            }
            
            if (container) {
                container.classList.toggle('active', carouselActive);
            }
            
            if (toggleIcon) {
                toggleIcon.textContent = carouselActive ? '' : '';
            }
            
            if (carouselActive) {
                initCarousel();
                
                // Find current page index
                const activePage = document.querySelector('.page.active');
                if (activePage) {
                    const pageId = activePage.id.replace('page-', '');
                    const index = carouselPages.findIndex(p => p.id === pageId);
                    if (index !== -1) {
                        currentCarouselIndex = index;
                        updateCarouselState();
                    }
                }
                
                // Hide hint after 3 seconds
                setTimeout(() => {
                    const hint = document.getElementById('carouselHint');
                    if (hint) hint.style.opacity = '0';
                }, 3000);
            } else {
                // When exiting carousel mode, make sure the page is visible
                document.querySelectorAll('.page').forEach(p => p.style.display = '');
            }
        }
        
        // ================================================
        // END 3D CAROUSEL NAVIGATION
        // ================================================
        
        // Quick Language Toggle (button in header)
        function toggleLanguageQuick() {
            const newLang = currentLanguage === 'en' ? 'ar-funny' : 'en';
            setLanguage(newLang);
            updateLangToggleButton();
        }
        
        function updateLangToggleButton() {
            const btn = document.getElementById('langToggleBtn');
            if (btn) {
                btn.textContent = currentLanguage === 'en' ? '' : 'English';
            }
        }

        function initSettingsThemePicker() {
            const themeOptions = document.querySelectorAll('#page-settings .theme-option');
            
            // Update active state
            themeOptions.forEach(el => {
                el.classList.toggle('active', el.dataset.theme === currentTheme && !isDarkMode);
            });
            
            // Add click handlers
            themeOptions.forEach(opt => {
                // Remove old listeners by cloning
                const newOpt = opt.cloneNode(true);
                opt.parentNode.replaceChild(newOpt, opt);
                
                newOpt.addEventListener('click', () => {
                    if (isDarkMode) {
                        showToast('Turn off dark mode first');
                        return;
                    }
                    
                    // Update UI
                    document.querySelectorAll('#page-settings .theme-option').forEach(o => o.classList.remove('active'));
                    newOpt.classList.add('active');
                    
                    // Apply theme
                    currentTheme = newOpt.dataset.theme;
                    document.body.classList.remove('theme-ocean', 'theme-sunset', 'theme-lavender', 'theme-rose', 'theme-forest', 'theme-dark');
                    if (currentTheme) {
                        document.body.classList.add(currentTheme);
                    }
                    
                    // Save
                    localStorage.setItem('pocketflow_theme', currentTheme);
                    showToast('Theme applied!');
                });
            });
        }

        function initDebtTypeSelector() {
            // Set default start date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('debtStartDateInput').value = today;
        }

        function selectDebtType(element, type, icon) {
            document.querySelectorAll('.debt-type-item').forEach(o => o.classList.remove('active'));
            element.classList.add('active');
            selectedDebtType = type;
            selectedDebtIcon = icon;
        }

        function selectDebtSchedule(element, schedule) {
            document.querySelectorAll('#debtModal .schedule-option').forEach(o => o.classList.remove('active'));
            element.classList.add('active');
            selectedSchedule = schedule;
        }

        function selectGoalType(element, type, icon) {
            document.querySelectorAll('.goal-type-item').forEach(o => o.classList.remove('active'));
            element.classList.add('active');
            selectedGoalType = type;
            selectedGoalIcon = icon;
        }

        function selectGoalSchedule(element, schedule) {
            document.querySelectorAll('#goalModal .schedule-option').forEach(o => o.classList.remove('active'));
            element.classList.add('active');
            selectedGoalSchedule = schedule;
            
            // Show/hide auto amount input
            const autoAmountGroup = document.getElementById('goalAutoAmountGroup');
            if (autoAmountGroup) {
                autoAmountGroup.style.display = schedule === 'none' ? 'none' : 'block';
            }
        }

        function selectCurrency(element, curr, code) {
            currency = curr;
            currencyCode = code;
            document.querySelectorAll('.currency-option').forEach(o => o.classList.remove('active'));
            element.classList.add('active');
            // Clear custom currency inputs
            document.getElementById('customCurrencySymbol').value = '';
            document.getElementById('customCurrencyCode').value = '';
            updateCurrencyDisplay();
        }

        function applyCustomCurrency() {
            const symbolInput = document.getElementById('customCurrencySymbol');
            const codeInput = document.getElementById('customCurrencyCode');
            const symbol = symbolInput.value.trim();
            const code = codeInput.value.trim().toUpperCase();
            
            if (!symbol) {
                showToast('Please enter a currency symbol');
                return;
            }
            if (!code) {
                showToast('Please enter a currency code');
                return;
            }
            
            currency = symbol;
            currencyCode = code;
            
            // Remove active from preset options
            document.querySelectorAll('.currency-option').forEach(o => o.classList.remove('active'));
            
            updateCurrencyDisplay();
            showToast(`Currency set to ${symbol} ${code}`);
        }

        function selectTheme(element, theme) {
            if (isDarkMode) {
                showToast('Turn off dark mode first');
                return;
            }
            
            document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('active'));
            element.classList.add('active');
            currentTheme = theme;
            document.body.classList.remove('theme-ocean', 'theme-sunset', 'theme-lavender', 'theme-rose', 'theme-forest');
            if (currentTheme) {
                document.body.classList.add(currentTheme);
            }
            localStorage.setItem('pocketflow_theme', currentTheme);
            showToast('Theme applied!');
        }

        function openDebtModal(debtId = null) {
            editingDebtId = debtId;
            const modal = document.getElementById('debtModal');
            const title = document.getElementById('debtModalTitle');
            const btn = document.getElementById('debtSubmitBtn');
            const deleteBtn = document.getElementById('debtDeleteBtn');
            const today = new Date().toISOString().split('T')[0];
            const isArabic = currentLanguage === 'ar-funny';
            
            if (debtId) {
                const debt = debts.find(d => d.id === debtId);
                if (debt) {
                    title.textContent = isArabic ? ' ' : 'Edit Debt';
                    btn.textContent = isArabic ? ' ' : 'Save Changes';
                    deleteBtn.style.display = 'block';
                    deleteBtn.innerHTML = isArabic ? '  ' : ' Delete Debt';
                    document.getElementById('debtNameInput').value = debt.name;
                    document.getElementById('debtOriginalInput').value = debt.original;
                    document.getElementById('debtBalanceInput').value = debt.balance;
                    document.getElementById('debtInterestInput').value = debt.interest || '';
                    document.getElementById('debtMinPaymentInput').value = debt.minPayment || '';
                    document.getElementById('debtStartDateInput').value = debt.startDate || today;
                    
                    // Select the right type
                    selectedDebtType = debt.type;
                    selectedDebtIcon = debt.icon;
                    document.querySelectorAll('.debt-type-item').forEach(o => {
                        o.classList.toggle('active', o.dataset.type === debt.type);
                    });

                    // Select schedule
                    selectedSchedule = debt.schedule || 'weekly';
                    document.querySelectorAll('#debtModal .schedule-option').forEach(o => {
                        o.classList.toggle('active', o.dataset.schedule === selectedSchedule);
                    });
                }
            } else {
                title.textContent = isArabic ? ' ' : 'Add Debt';
                btn.textContent = isArabic ? ' ' : 'Add Debt';
                deleteBtn.style.display = 'none';
                document.getElementById('debtNameInput').value = '';
                document.getElementById('debtOriginalInput').value = '';
                document.getElementById('debtBalanceInput').value = '';
                document.getElementById('debtInterestInput').value = '';
                document.getElementById('debtMinPaymentInput').value = '';
                document.getElementById('debtStartDateInput').value = today;
                
                // Reset to defaults
                selectedDebtType = 'credit';
                selectedDebtIcon = '';
                selectedSchedule = 'weekly';
                document.querySelectorAll('.debt-type-item').forEach(o => {
                    o.classList.toggle('active', o.dataset.type === 'credit');
                });
                document.querySelectorAll('#debtModal .schedule-option').forEach(o => {
                    o.classList.toggle('active', o.dataset.schedule === 'weekly');
                });
            }
            
            modal.classList.add('active');
            document.body.classList.add('modal-open');
        }

        function deleteCurrentDebt() {
            if (editingDebtId && confirm('Delete this debt?')) {
                debts = debts.filter(d => d.id !== editingDebtId);
                saveDebts();
                renderDebtList();
                updateDebtStats();
                closeModal('debtModal');
                editingDebtId = null;
                showToast('Debt removed');
            }
        }

        function addDebt() {
            const name = document.getElementById('debtNameInput').value.trim();
            const original = parseFloat(document.getElementById('debtOriginalInput').value);
            const balanceInput = document.getElementById('debtBalanceInput').value;
            const balance = balanceInput === '' ? original : parseFloat(balanceInput);
            const interest = parseFloat(document.getElementById('debtInterestInput').value) || 0;
            const minPayment = parseFloat(document.getElementById('debtMinPaymentInput').value) || 0;
            const startDate = document.getElementById('debtStartDateInput').value;

            if (!name) {
                showToast('Please enter an account name');
                return;
            }
            if (!original || original <= 0) {
                showToast('Please enter the original amount');
                return;
            }
            if (isNaN(balance) || balance < 0) {
                showToast('Please enter a valid balance');
                return;
            }

            if (editingDebtId) {
                // Update existing debt
                const index = debts.findIndex(d => d.id === editingDebtId);
                if (index !== -1) {
                    debts[index] = {
                        ...debts[index],
                        name,
                        original,
                        balance,
                        interest,
                        minPayment,
                        type: selectedDebtType,
                        icon: selectedDebtIcon,
                        schedule: selectedSchedule,
                        startDate: startDate
                    };
                }
                showToast('Debt updated!');
            } else {
                // Add new debt
                const debt = {
                    id: Date.now(),
                    name,
                    original,
                    balance,
                    interest,
                    minPayment,
                    type: selectedDebtType,
                    icon: selectedDebtIcon,
                    schedule: selectedSchedule,
                    startDate: startDate,
                    lastAutoPayment: null,
                    payments: [],
                    createdAt: new Date().toISOString()
                };
                debts.push(debt);
                showToast('Debt added! Let\'s crush it! ');
            }

            saveDebts();
            renderDebtList();
            updateDebtStats();
            processAutoPayments(); // Check if any auto payments are due
            closeModal('debtModal');
            editingDebtId = null;
        }

        function processAutoPayments() {
            const now = new Date();
            let paymentsProcessed = 0;

            debts.forEach(debt => {
                if (debt.schedule === 'none' || debt.balance <= 0 || !debt.minPayment) return;

                const startDate = new Date(debt.startDate);
                const lastPayment = debt.lastAutoPayment ? new Date(debt.lastAutoPayment) : null;
                
                let intervalDays;
                switch (debt.schedule) {
                    case 'weekly': intervalDays = 7; break;
                    case 'biweekly': intervalDays = 14; break;
                    case 'monthly': intervalDays = 30; break;
                    default: return;
                }

                // Calculate next payment date
                let nextPaymentDate;
                if (lastPayment) {
                    nextPaymentDate = new Date(lastPayment);
                    nextPaymentDate.setDate(nextPaymentDate.getDate() + intervalDays);
                } else {
                    nextPaymentDate = startDate;
                }

                // Process all due payments
                while (nextPaymentDate <= now && debt.balance > 0) {
                    const paymentAmount = Math.min(debt.minPayment, debt.balance);
                    debt.balance = Math.max(0, debt.balance - paymentAmount);
                    debt.payments = debt.payments || [];
                    debt.payments.push({
                        amount: paymentAmount,
                        date: nextPaymentDate.toISOString(),
                        auto: true
                    });
                    debt.lastAutoPayment = nextPaymentDate.toISOString();
                    paymentsProcessed++;
                    
                    // Move to next payment date
                    nextPaymentDate.setDate(nextPaymentDate.getDate() + intervalDays);
                }
            });

            if (paymentsProcessed > 0) {
                saveDebts();
                showToast(`${paymentsProcessed} auto-payment(s) processed! `);
            }
        }

        function getNextPaymentDate(debt) {
            if (debt.schedule === 'none' || debt.balance <= 0) return null;

            const lastPayment = debt.lastAutoPayment ? new Date(debt.lastAutoPayment) : new Date(debt.startDate);
            let intervalDays;
            switch (debt.schedule) {
                case 'weekly': intervalDays = 7; break;
                case 'biweekly': intervalDays = 14; break;
                case 'monthly': intervalDays = 30; break;
                default: return null;
            }

            const nextDate = new Date(lastPayment);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Keep adding intervals until we get a future date
            nextDate.setDate(nextDate.getDate() + intervalDays);
            while (nextDate < today) {
                nextDate.setDate(nextDate.getDate() + intervalDays);
            }
            
            return nextDate;
        }

        function openPaymentModal(debtId) {
            payingDebtId = debtId;
            const debt = debts.find(d => d.id === debtId);
            if (!debt) return;
            
            document.getElementById('paymentDebtName').textContent = `${debt.icon} ${debt.name}`;
            document.getElementById('paymentAmountInput').value = debt.minPayment || '';
            document.getElementById('crushItBtn').disabled = false;
            document.getElementById('paymentModal').classList.add('active');
            document.body.classList.add('modal-open');
        }
        
        function handleCrushIt() {
            const btn = document.getElementById('crushItBtn');
            if (btn.disabled) return; // Prevent double tap
            btn.disabled = true; // Disable immediately
            
            const amount = parseFloat(document.getElementById('paymentAmountInput').value);
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount');
                btn.disabled = false;
                return;
            }

            const debtIndex = debts.findIndex(d => d.id === payingDebtId);
            if (debtIndex === -1) {
                showToast('Error: Debt not found');
                btn.disabled = false;
                return;
            }

            // CLOSE MODAL IMMEDIATELY
            document.getElementById('paymentModal').classList.remove('active');
            document.body.classList.remove('modal-open');
            document.getElementById('paymentAmountInput').value = '';

            // Now process the payment
            const debt = debts[debtIndex];
            const previousBalance = debt.balance;
            debt.balance = Math.max(0, debt.balance - amount);
            debt.payments = debt.payments || [];
            debt.payments.push({
                amount,
                date: new Date().toISOString()
            });

            saveDebts();
            renderDebtList();
            updateDebtStats();
            calculateHealthScore();

            // Show feedback
            if (previousBalance > 0 && debt.balance === 0) {
                showCelebration(debt.name);
            } else {
                showToast(`Payment of ${formatCurrency(amount)} recorded! `);
            }

            payingDebtId = null;
        }

        function makePayment() {
            handleCrushIt();
        }
        
        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            if (modal) {
                modal.classList.remove('active');
            }
            document.body.classList.remove('modal-open');
            const input = document.getElementById('paymentAmountInput');
            if (input) {
                input.value = '';
            }
        }

        function deleteDebt(debtId) {
            if (confirm('Delete this debt?')) {
                debts = debts.filter(d => d.id !== debtId);
                saveDebts();
                renderDebtList();
                updateDebtStats();
                showToast('Debt removed');
            }
        }

        function quickDeleteDebt(debtId) {
            if (confirm('Delete this debt?')) {
                debts = debts.filter(d => d.id !== debtId);
                saveDebts();
                renderDebtList();
                updateDebtStats();
                calculateHealthScore();
                showToast('Debt deleted');
            }
        }

        function selectStrategy(strategy) {
            debtStrategy = strategy;
            localStorage.setItem('pocketflow_debt_strategy', strategy);
            document.querySelectorAll('.strategy-pill').forEach(c => {
                c.classList.toggle('active', c.dataset.strategy === strategy);
            });
            renderDebtList();
        }

        function renderDebtList() {
            const container = document.getElementById('debtList');
            const emptyState = document.getElementById('debtEmptyState');
            const listContainer = document.getElementById('debtListContainer');
            const quickStats = document.getElementById('quickStatsBar');
            const strategyPills = document.getElementById('strategyPills');
            const isArabic = currentLanguage === 'ar-funny';
            
            if (debts.length === 0) {
                emptyState.style.display = 'flex';
                listContainer.style.display = 'none';
                quickStats.style.display = 'none';
                strategyPills.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            listContainer.style.display = 'block';
            quickStats.style.display = 'flex';
            strategyPills.style.display = 'flex';

            // Sort based on strategy
            const sortedDebts = [...debts].sort((a, b) => {
                if (debtStrategy === 'avalanche') {
                    return (b.interest || 0) - (a.interest || 0);
                } else {
                    return a.balance - b.balance;
                }
            });

            const scheduleLabels = isArabic 
                ? { weekly: '', biweekly: ' ', monthly: '', none: '' }
                : { weekly: 'Weekly', biweekly: 'Bi-weekly', monthly: 'Monthly', none: 'Manual' };

            container.innerHTML = sortedDebts.map((debt, index) => {
                const paid = debt.original - debt.balance;
                const progress = debt.original > 0 ? (paid / debt.original) * 100 : 0;
                const isPaidOff = debt.balance === 0;
                const nextPayment = getNextPaymentDate(debt);
                
                let nextPaymentHtml = '';
                if (debt.schedule !== 'none' && debt.balance > 0 && nextPayment) {
                    const daysUntil = Math.ceil((nextPayment - new Date()) / (1000 * 60 * 60 * 24));
                    const dateStr = nextPayment.toLocaleDateString(isArabic ? 'ar-SA' : 'en-US', { month: 'short', day: 'numeric' });
                    const nextAutoText = isArabic 
                        ? `  : ${formatCurrency(debt.minPayment)}  ${dateStr} (${daysUntil} )`
                        : `Next auto-payment: ${formatCurrency(debt.minPayment)} on ${dateStr} (${daysUntil} days)`;
                    nextPaymentHtml = `
                        <div class="next-payment-info">
                            <span class="next-payment-info-icon"></span>
                            <span>${nextAutoText}</span>
                        </div>
                    `;
                }

                const exampleBadge = debt.isExample ? `<span class="example-badge">${isArabic ? '' : 'EXAMPLE'}</span>` : '';
                const paidBadge = isPaidOff ? `<span style="color: #22c55e; margin-left: 6px;">${isArabic ? ' ' : ' Paid'}</span>` : '';
                const balanceLabel = isArabic ? '' : 'Balance';
                const paidText = isArabic ? '' : 'paid';
                const noInterestText = isArabic ? ' ' : 'No interest';
                const editText = isArabic ? '' : 'Edit';
                const payText = isArabic ? '' : 'Pay';

                return `
                    <div class="debt-card ${isPaidOff ? 'paid-off' : ''} ${debt.isExample ? 'example-item' : ''}">
                        <div class="debt-card-header">
                            <div class="debt-card-info">
                                <div class="debt-card-icon">${debt.icon}</div>
                                <div>
                                    <div class="debt-card-name">
                                        ${debt.name}
                                        ${exampleBadge}
                                        ${paidBadge}
                                        ${debt.schedule !== 'none' && !isPaidOff ? `<span class="auto-pay-badge"> ${scheduleLabels[debt.schedule]}</span>` : ''}
                                    </div>
                                    <div class="debt-card-type">${debt.interest ? debt.interest + '% APR' : noInterestText}</div>
                                </div>
                            </div>
                            <div class="debt-card-balance">
                                <div class="debt-card-balance-label">${balanceLabel}</div>
                                <div class="debt-card-balance-value">${formatCurrency(debt.balance)}</div>
                            </div>
                        </div>
                        <div class="debt-card-progress">
                            <div class="debt-progress-info">
                                <span class="debt-progress-paid">${formatCurrency(paid)} ${paidText}</span>
                                <span class="debt-progress-percent">${Math.round(progress)}%</span>
                            </div>
                            <div class="debt-progress-track">
                                <div class="debt-progress-bar" style="width: ${progress}%"></div>
                            </div>
                        </div>
                        ${nextPaymentHtml}
                        <div class="debt-card-footer">
                            <button class="debt-action-btn secondary" onclick="openDebtModal(${debt.id})"> ${editText}</button>
                            <button class="debt-action-btn danger" onclick="quickDeleteDebt(${debt.id})" title="${isArabic ? '' : 'Delete'}"></button>
                            ${!isPaidOff ? `<button class="debt-action-btn primary" onclick="openPaymentModal(${debt.id})"> ${payText}</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateDebtStats() {
            const isArabic = currentLanguage === 'ar-funny';
            const totalDebt = debts.reduce((sum, d) => sum + d.balance, 0);
            const totalOriginal = debts.reduce((sum, d) => sum + d.original, 0);
            const totalPaid = totalOriginal - totalDebt;
            const paidOff = debts.filter(d => d.balance === 0).length;
            const avgProgress = totalOriginal > 0 ? (totalPaid / totalOriginal) * 100 : 0;

            document.getElementById('totalDebt').textContent = formatCurrency(totalDebt);
            document.getElementById('debtsPaidOff').textContent = paidOff;
            document.getElementById('totalPaidAmount').textContent = formatCurrency(totalPaid);
            document.getElementById('avgProgress').textContent = Math.round(avgProgress) + '%';

            // Calculate debt-free date estimate
            const monthlyPayment = debts.reduce((sum, d) => sum + (d.minPayment || 0), 0);
            if (monthlyPayment > 0 && totalDebt > 0) {
                const monthsToPayoff = Math.ceil(totalDebt / monthlyPayment);
                const freeDate = new Date();
                freeDate.setMonth(freeDate.getMonth() + monthsToPayoff);
                const freeDateText = isArabic 
                    ? ' ' + freeDate.toLocaleDateString('ar-SA', { month: 'short', year: 'numeric' })
                    : 'Free by ' + freeDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                const debtFreeDateEl = document.getElementById('debtFreeDate');
                if (debtFreeDateEl) debtFreeDateEl.textContent = freeDateText;
            } else if (totalDebt === 0 && debts.length > 0) {
                const debtFreeDateEl = document.getElementById('debtFreeDate');
                if (debtFreeDateEl) debtFreeDateEl.textContent = isArabic ? '   !' : ' DEBT FREE!';
            } else {
                const debtFreeDateEl = document.getElementById('debtFreeDate');
                if (debtFreeDateEl) debtFreeDateEl.textContent = isArabic ? '  ' : 'Add debts to start';
            }

            // Find next auto payment
            const upcomingPayments = debts
                .filter(d => d.schedule !== 'none' && d.balance > 0)
                .map(d => ({ debt: d, date: getNextPaymentDate(d) }))
                .filter(p => p.date)
                .sort((a, b) => a.date - b.date);

            if (upcomingPayments.length > 0) {
                const next = upcomingPayments[0];
                const daysUntil = Math.ceil((next.date - new Date()) / (1000 * 60 * 60 * 24));
                const nextAutoEl = document.getElementById('nextAutoPayment');
                if (nextAutoEl) nextAutoEl.textContent = daysUntil <= 0 ? (isArabic ? '!' : 'Today!') : `${daysUntil}${isArabic ? '' : 'd'}`;
            } else {
                const nextAutoEl = document.getElementById('nextAutoPayment');
                if (nextAutoEl) nextAutoEl.textContent = '-';
            }
        }

        function showCelebration(debtName) {
            const isArabic = currentLanguage === 'ar-funny';
            const overlay = document.getElementById('celebrationOverlay');
            const celebText = isArabic ? ` ${debtName} ! ` : `You completely paid off ${debtName}!`;
            document.getElementById('celebrationText').textContent = celebText;
            overlay.classList.add('active');
            
            // Create confetti
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.background = ['#ff6b9d', '#22c55e', '#3b82f6', '#fbbf24', '#a855f7'][Math.floor(Math.random() * 5)];
                overlay.appendChild(confetti);
            }

            // Auto close after 4 seconds
            setTimeout(closeCelebration, 4000);
        }

        function closeCelebration() {
            const overlay = document.getElementById('celebrationOverlay');
            overlay.classList.remove('active');
            // Remove confetti
            overlay.querySelectorAll('.confetti').forEach(c => c.remove());
        }

        function saveDebts() {
            localStorage.setItem('pocketflow_debts', JSON.stringify(debts));
        }

        // =====================
        // WEALTH BUILDER FUNCTIONS
        // =====================

        function initGoalTypeSelector() {
            // Goal type and schedule selectors now use onclick handlers in HTML
        }

        function openGoalModal(goalId = null) {
            editingGoalId = goalId;
            const modal = document.getElementById('goalModal');
            const title = document.getElementById('goalModalTitle');
            const btn = document.getElementById('goalSubmitBtn');
            const deleteBtn = document.getElementById('goalDeleteBtn');
            const isArabic = currentLanguage === 'ar-funny';
            
            // Set default due date to 6 months from now
            const defaultDate = new Date();
            defaultDate.setMonth(defaultDate.getMonth() + 6);
            
            if (goalId) {
                const goal = goals.find(g => g.id === goalId);
                if (goal) {
                    title.textContent = isArabic ? ' ' : 'Edit Goal';
                    btn.textContent = isArabic ? ' ' : 'Save Changes';
                    deleteBtn.style.display = 'block';
                    deleteBtn.innerHTML = isArabic ? '  ' : ' Delete Goal';
                    document.getElementById('goalNameInput').value = goal.name;
                    document.getElementById('goalTargetInput').value = goal.target;
                    document.getElementById('goalSavedInput').value = goal.saved;
                    document.getElementById('goalDueDateInput').value = goal.dueDate || '';
                    document.getElementById('goalAutoAmountInput').value = goal.autoAmount || '';
                    
                    // Select the right type
                    selectedGoalType = goal.type;
                    selectedGoalIcon = goal.icon;
                    document.querySelectorAll('.goal-type-item').forEach(o => {
                        o.classList.toggle('active', o.dataset.type === goal.type);
                    });

                    // Select schedule
                    selectedGoalSchedule = goal.schedule || 'weekly';
                    document.querySelectorAll('#goalModal .schedule-option').forEach(o => {
                        o.classList.toggle('active', o.dataset.schedule === selectedGoalSchedule);
                    });
                    document.getElementById('goalAutoAmountGroup').style.display = 
                        selectedGoalSchedule === 'none' ? 'none' : 'block';
                }
            } else {
                title.textContent = isArabic ? ' ' : 'Create Goal';
                btn.textContent = isArabic ? ' ' : 'Create Goal';
                deleteBtn.style.display = 'none';
                document.getElementById('goalNameInput').value = '';
                document.getElementById('goalTargetInput').value = '';
                document.getElementById('goalSavedInput').value = '';
                document.getElementById('goalDueDateInput').value = defaultDate.toISOString().split('T')[0];
                document.getElementById('goalAutoAmountInput').value = '';
                
                // Reset to defaults
                selectedGoalType = 'emergency';
                selectedGoalIcon = '';
                selectedGoalSchedule = 'weekly';
                document.querySelectorAll('.goal-type-item').forEach(o => {
                    o.classList.toggle('active', o.dataset.type === 'emergency');
                });
                document.querySelectorAll('#goalModal .schedule-option').forEach(o => {
                    o.classList.toggle('active', o.dataset.schedule === 'weekly');
                });
                document.getElementById('goalAutoAmountGroup').style.display = 'block';
            }
            
            modal.classList.add('active');
            document.body.classList.add('modal-open');
        }

        function addGoal() {
            const name = document.getElementById('goalNameInput').value.trim();
            const target = parseFloat(document.getElementById('goalTargetInput').value);
            const saved = parseFloat(document.getElementById('goalSavedInput').value) || 0;
            const dueDate = document.getElementById('goalDueDateInput').value;
            const autoAmount = parseFloat(document.getElementById('goalAutoAmountInput').value) || 0;

            if (!name) {
                showToast('Please enter a goal name');
                return;
            }
            if (!target || target <= 0) {
                showToast('Please enter a target amount');
                return;
            }

            if (editingGoalId) {
                const index = goals.findIndex(g => g.id === editingGoalId);
                if (index !== -1) {
                    goals[index] = {
                        ...goals[index],
                        name,
                        target,
                        saved: Math.min(saved, target),
                        dueDate,
                        autoAmount,
                        type: selectedGoalType,
                        icon: selectedGoalIcon,
                        schedule: selectedGoalSchedule
                    };
                }
                showToast('Goal updated!');
            } else {
                const goal = {
                    id: Date.now(),
                    name,
                    target,
                    saved: Math.min(saved, target),
                    dueDate,
                    autoAmount,
                    type: selectedGoalType,
                    icon: selectedGoalIcon,
                    schedule: selectedGoalSchedule,
                    lastAutoSave: null,
                    deposits: [],
                    createdAt: new Date().toISOString()
                };
                goals.push(goal);
                showToast('Goal created! Let\'s start saving! ');
            }

            saveGoals();
            renderGoalsList();
            updateGoalsStats();
            processAutoSavings();
            closeModal('goalModal');
            editingGoalId = null;
        }

        function deleteCurrentGoal() {
            if (editingGoalId && confirm('Delete this goal?')) {
                goals = goals.filter(g => g.id !== editingGoalId);
                saveGoals();
                renderGoalsList();
                updateGoalsStats();
                closeModal('goalModal');
                editingGoalId = null;
                showToast('Goal removed');
            }
        }

        function quickDeleteGoal(goalId) {
            if (confirm('Delete this goal?')) {
                goals = goals.filter(g => g.id !== goalId);
                saveGoals();
                renderGoalsList();
                updateGoalsStats();
                calculateHealthScore();
                showToast('Goal deleted');
            }
        }

        function openDepositModal(goalId) {
            depositingGoalId = goalId;
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            const isArabic = currentLanguage === 'ar-funny';
            
            // Translate modal title
            const modalTitle = document.querySelector('#depositModal .modal-title');
            if (modalTitle) modalTitle.textContent = isArabic ? ' ' : 'Add Savings';
            
            // Translate label
            const amountLabel = document.querySelector('#depositModal .input-label');
            if (amountLabel) amountLabel.textContent = isArabic ? ' ' : 'Amount to Save';
            
            // Translate button
            const saveBtn = document.querySelector('#depositModal .modal-save-btn');
            if (saveBtn) saveBtn.innerHTML = isArabic ? ' !' : ' Save It!';
            
            document.getElementById('depositGoalName').textContent = `${goal.icon} ${isArabic ? (goal.nameAr || goal.name) : goal.name}`;
            document.getElementById('depositAmountInput').value = goal.autoAmount || '';
            document.getElementById('depositModal').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function makeDeposit() {
            const isArabic = currentLanguage === 'ar-funny';
            const amount = parseFloat(document.getElementById('depositAmountInput').value);
            if (!amount || amount <= 0) {
                showToast(isArabic ? '  ' : 'Please enter a valid amount');
                return;
            }

            const goalIndex = goals.findIndex(g => g.id === depositingGoalId);
            if (goalIndex === -1) return;

            const goal = goals[goalIndex];
            const previousSaved = goal.saved;
            goal.saved = Math.min(goal.saved + amount, goal.target);
            goal.deposits = goal.deposits || [];
            goal.deposits.push({
                amount,
                date: new Date().toISOString()
            });

            saveGoals();
            renderGoalsList();
            updateGoalsStats();
            closeModal('depositModal');

            // Check if goal was just reached
            if (previousSaved < goal.target && goal.saved >= goal.target) {
                showGoalCelebration(goal.name);
            } else {
                showToast(`${formatCurrency(amount)} saved! Keep going! `);
            }

            depositingGoalId = null;
        }

        function processAutoSavings() {
            const now = new Date();
            let savingsProcessed = 0;

            goals.forEach(goal => {
                if (goal.schedule === 'none' || goal.saved >= goal.target || !goal.autoAmount) return;

                const createdDate = new Date(goal.createdAt);
                const lastSave = goal.lastAutoSave ? new Date(goal.lastAutoSave) : null;
                
                let intervalDays;
                switch (goal.schedule) {
                    case 'weekly': intervalDays = 7; break;
                    case 'biweekly': intervalDays = 14; break;
                    case 'monthly': intervalDays = 30; break;
                    default: return;
                }

                let nextSaveDate;
                if (lastSave) {
                    nextSaveDate = new Date(lastSave);
                    nextSaveDate.setDate(nextSaveDate.getDate() + intervalDays);
                } else {
                    nextSaveDate = createdDate;
                }

                while (nextSaveDate <= now && goal.saved < goal.target) {
                    const saveAmount = Math.min(goal.autoAmount, goal.target - goal.saved);
                    goal.saved += saveAmount;
                    goal.deposits = goal.deposits || [];
                    goal.deposits.push({
                        amount: saveAmount,
                        date: nextSaveDate.toISOString(),
                        auto: true
                    });
                    goal.lastAutoSave = nextSaveDate.toISOString();
                    savingsProcessed++;
                    
                    nextSaveDate.setDate(nextSaveDate.getDate() + intervalDays);
                }
            });

            if (savingsProcessed > 0) {
                saveGoals();
                showToast(`${savingsProcessed} auto-save(s) processed! `);
            }
        }

        function getNextSaveDate(goal) {
            if (goal.schedule === 'none' || goal.saved >= goal.target) return null;

            const lastSave = goal.lastAutoSave ? new Date(goal.lastAutoSave) : new Date(goal.createdAt);
            let intervalDays;
            switch (goal.schedule) {
                case 'weekly': intervalDays = 7; break;
                case 'biweekly': intervalDays = 14; break;
                case 'monthly': intervalDays = 30; break;
                default: return null;
            }

            const nextDate = new Date(lastSave);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Keep adding intervals until we get a future date
            nextDate.setDate(nextDate.getDate() + intervalDays);
            while (nextDate < today) {
                nextDate.setDate(nextDate.getDate() + intervalDays);
            }
            
            return nextDate;
        }

        function renderGoalsList() {
            const container = document.getElementById('goalsList');
            const emptyState = document.getElementById('goalsEmptyState');
            const listContainer = document.getElementById('goalsListContainer');
            const quickStats = document.getElementById('goalsQuickStats');
            const isArabic = currentLanguage === 'ar-funny';
            
            if (goals.length === 0) {
                emptyState.style.display = 'flex';
                listContainer.style.display = 'none';
                quickStats.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            listContainer.style.display = 'block';
            quickStats.style.display = 'flex';

            // Sort: incomplete first, then by progress
            const sortedGoals = [...goals].sort((a, b) => {
                const aComplete = a.saved >= a.target;
                const bComplete = b.saved >= b.target;
                if (aComplete !== bComplete) return aComplete ? 1 : -1;
                return (b.saved / b.target) - (a.saved / a.target);
            });

            const scheduleLabels = isArabic 
                ? { weekly: '', biweekly: ' ', monthly: '', none: '' }
                : { weekly: 'Weekly', biweekly: 'Bi-weekly', monthly: 'Monthly', none: 'Manual' };

            container.innerHTML = sortedGoals.map(goal => {
                const progress = goal.target > 0 ? (goal.saved / goal.target) * 100 : 0;
                const isComplete = goal.saved >= goal.target;
                const remaining = Math.max(0, goal.target - goal.saved);
                const nextSave = getNextSaveDate(goal);
                
                // Format due date
                let dueDateStr = '';
                if (goal.dueDate) {
                    const due = new Date(goal.dueDate);
                    dueDateStr = due.toLocaleDateString(isArabic ? 'ar-SA' : 'en-US', { month: 'short', day: 'numeric' });
                }

                let nextSaveHtml = '';
                if (goal.schedule !== 'none' && !isComplete && nextSave) {
                    const daysUntil = Math.ceil((nextSave - new Date()) / (1000 * 60 * 60 * 24));
                    const dateStr = nextSave.toLocaleDateString(isArabic ? 'ar-SA' : 'en-US', { month: 'short', day: 'numeric' });
                    const nextAutoText = isArabic 
                        ? `  : ${formatCurrency(goal.autoAmount)}  ${dateStr} (${daysUntil} )`
                        : `Next auto-save: ${formatCurrency(goal.autoAmount)} on ${dateStr} (${daysUntil} days)`;
                    nextSaveHtml = `
                        <div class="next-deposit-info">
                            <span></span>
                            <span>${nextAutoText}</span>
                        </div>
                    `;
                }

                const goalName = isArabic ? (goal.nameAr || goal.name) : goal.name;
                const exampleBadge = goal.isExample ? `<span class="example-badge">${isArabic ? '' : 'EXAMPLE'}</span>` : '';
                const dueDateText = dueDateStr 
                    ? `<span></span> ${isArabic ? '' : 'Due'} ${dueDateStr}` 
                    : (isArabic ? ' ' : 'No deadline set');
                const ofText = isArabic ? '' : 'of';
                const toGoText = isArabic ? '' : 'to go';
                const goalReachedText = isArabic ? '  !' : ' Goal reached!';
                const editText = isArabic ? '' : 'Edit';
                const addText = isArabic ? '' : 'Add';

                return `
                    <div class="goal-card ${isComplete ? 'completed' : ''} ${goal.isExample ? 'example-item' : ''}">
                        <div class="goal-card-header">
                            <div class="goal-card-info">
                                <div class="goal-card-icon">${goal.icon}</div>
                                <div>
                                    <div class="goal-card-name">
                                        ${goalName}
                                        ${exampleBadge}
                                        ${isComplete ? '<span style="color: #fbbf24; margin-left: 6px;"></span>' : ''}
                                        ${goal.schedule !== 'none' && !isComplete ? `<span class="auto-save-badge"> ${scheduleLabels[goal.schedule]}</span>` : ''}
                                    </div>
                                    <div class="goal-card-due">${dueDateText}</div>
                                </div>
                            </div>
                            <div class="goal-card-amounts">
                                <div class="goal-card-saved">${formatCurrency(goal.saved)}</div>
                                <div class="goal-card-target">${ofText} ${formatCurrency(goal.target)}</div>
                            </div>
                        </div>
                        <div class="goal-card-progress">
                            <div class="goal-progress-info">
                                <span class="goal-progress-remaining">${isComplete ? goalReachedText : formatCurrency(remaining) + ' ' + toGoText}</span>
                                <span class="goal-progress-percent">${Math.round(progress)}%</span>
                            </div>
                            <div class="goal-progress-track">
                                <div class="goal-progress-bar" style="width: ${Math.min(progress, 100)}%"></div>
                            </div>
                        </div>
                        ${nextSaveHtml}
                        <div class="goal-card-footer">
                            <button class="goal-action-btn secondary" onclick="window.openGoalModal && window.openGoalModal(${goal.id})"> ${editText}</button>
                            <button class="goal-action-btn danger" onclick="quickDeleteGoal(${goal.id})" title="${isArabic ? '' : 'Delete'}"></button>
                            ${!isComplete ? `<button class="goal-action-btn primary" onclick="openDepositModal(${goal.id})"> ${addText}</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateGoalsStats() {
            const totalSaved = goals.reduce((sum, g) => sum + g.saved, 0);
            const totalTarget = goals.reduce((sum, g) => sum + g.target, 0);
            const totalRemaining = Math.max(0, totalTarget - totalSaved);
            const completed = goals.filter(g => g.saved >= g.target).length;
            const overallProgress = totalTarget > 0 ? (totalSaved / totalTarget) * 100 : 0;

            const totalSavedEl = document.getElementById('totalSaved');
            const totalTargetEl = document.getElementById('totalTarget');
            const goalsCompletedEl = document.getElementById('goalsCompleted');
            const goalsProgressEl = document.getElementById('goalsProgress');
            const goalsRemainingEl = document.getElementById('goalsRemaining');
            
            if (totalSavedEl) totalSavedEl.textContent = formatCurrency(totalSaved);
            if (totalTargetEl) totalTargetEl.textContent = formatCurrency(totalTarget);
            if (goalsCompletedEl) goalsCompletedEl.textContent = completed;
            if (goalsProgressEl) goalsProgressEl.textContent = Math.round(overallProgress) + '%';
            if (goalsRemainingEl) goalsRemainingEl.textContent = formatCurrency(totalRemaining);
        }

        function showGoalCelebration(goalName) {
            const overlay = document.getElementById('goalCelebrationOverlay');
            const isArabic = currentLanguage === 'ar-funny';
            const celebText = isArabic 
                ? `  "${goalName}"! `
                : `You reached your "${goalName}" goal!`;
            document.getElementById('goalCelebrationText').textContent = celebText;
            overlay.classList.add('active');
            
            // Create confetti
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.background = ['#fbbf24', '#22c55e', '#3b82f6', '#7c3aed', '#f59e0b'][Math.floor(Math.random() * 5)];
                overlay.appendChild(confetti);
            }

            setTimeout(closeGoalCelebration, 5000);
        }

        function closeGoalCelebration() {
            const overlay = document.getElementById('goalCelebrationOverlay');
            overlay.classList.remove('active');
            overlay.querySelectorAll('.confetti').forEach(c => c.remove());
        }

        function saveGoals() {
            localStorage.setItem('pocketflow_goals', JSON.stringify(goals));
        }

        // =====================
        // EMPIRE (NET WORTH) FUNCTIONS
        // =====================

        function openEmpireModal(mode, itemId = null) {
            empireMode = mode;
            editingEmpireId = itemId;
            
            const modal = document.getElementById('empireModal');
            const title = document.getElementById('empireModalTitle');
            const btn = document.getElementById('empireSubmitBtn');
            const deleteBtn = document.getElementById('empireDeleteBtn');
            const typeGrid = document.getElementById('empireTypeGrid');
            
            const types = mode === 'asset' ? assetTypes : liabilityTypes;
            const colorClass = mode === 'asset' ? 'asset' : 'liability';
            const btnColor = mode === 'asset' ? '#10b981' : '#ef4444';
            
            // Render type grid
            typeGrid.innerHTML = types.map((t, i) => `
                <div class="empire-type-item ${colorClass} ${i === 0 ? 'active' : ''}" data-type="${t.id}" data-icon="${t.icon}">
                    <div class="empire-type-item-icon">${t.icon}</div>
                    <div class="empire-type-item-label">${t.name}</div>
                </div>
            `).join('');

            // Add click handlers
            typeGrid.querySelectorAll('.empire-type-item').forEach(opt => {
                opt.addEventListener('click', (e) => {
                    e.stopPropagation();
                    typeGrid.querySelectorAll('.empire-type-item').forEach(o => o.classList.remove('active'));
                    opt.classList.add('active');
                    selectedEmpireType = opt.dataset.type;
                    selectedEmpireIcon = opt.dataset.icon;
                });
            });

            selectedEmpireType = types[0].id;
            selectedEmpireIcon = types[0].icon;

            if (itemId) {
                const items = mode === 'asset' ? assets : liabilities;
                const item = items.find(i => i.id === itemId);
                if (item) {
                    title.textContent = mode === 'asset' ? 'Edit Asset' : 'Edit Liability';
                    btn.textContent = 'Save Changes';
                    deleteBtn.style.display = 'block';
                    document.getElementById('empireNameInput').value = item.name;
                    document.getElementById('empireValueInput').value = item.value;
                    document.getElementById('empireNotesInput').value = item.notes || '';
                    
                    // Select the right type
                    typeGrid.querySelectorAll('.empire-type-item').forEach(o => {
                        o.classList.toggle('active', o.dataset.type === item.type);
                        if (o.dataset.type === item.type) {
                            selectedEmpireType = item.type;
                            selectedEmpireIcon = item.icon;
                        }
                    });
                }
            } else {
                title.textContent = mode === 'asset' ? 'Add Asset' : 'Add Liability';
                btn.textContent = mode === 'asset' ? 'Add Asset' : 'Add Liability';
                deleteBtn.style.display = 'none';
                document.getElementById('empireNameInput').value = '';
                document.getElementById('empireValueInput').value = '';
                document.getElementById('empireNotesInput').value = '';
            }

            btn.style.background = btnColor;
            modal.classList.add('active');
            document.body.classList.add('modal-open');
        }

        function addEmpireItem() {
            const name = document.getElementById('empireNameInput').value.trim();
            const value = parseFloat(document.getElementById('empireValueInput').value);
            const notes = document.getElementById('empireNotesInput').value.trim();

            if (!name) {
                showToast('Please enter a name');
                return;
            }
            if (!value || value < 0) {
                showToast('Please enter a valid value');
                return;
            }

            const item = {
                id: editingEmpireId || Date.now(),
                name,
                value,
                notes,
                type: selectedEmpireType,
                icon: selectedEmpireIcon,
                updatedAt: new Date().toISOString()
            };

            if (empireMode === 'asset') {
                if (editingEmpireId) {
                    const index = assets.findIndex(a => a.id === editingEmpireId);
                    if (index !== -1) assets[index] = item;
                } else {
                    assets.push(item);
                }
                saveAssets();
                showToast(editingEmpireId ? 'Asset updated!' : 'Asset added! ');
            } else {
                if (editingEmpireId) {
                    const index = liabilities.findIndex(l => l.id === editingEmpireId);
                    if (index !== -1) liabilities[index] = item;
                } else {
                    liabilities.push(item);
                }
                saveLiabilities();
                showToast(editingEmpireId ? 'Liability updated!' : 'Liability added!');
            }

            renderEmpireLists();
            updateEmpireStats();
            closeModal('empireModal');
            editingEmpireId = null;
        }

        function deleteCurrentEmpireItem() {
            if (!editingEmpireId) return;
            
            if (confirm('Delete this item?')) {
                if (empireMode === 'asset') {
                    assets = assets.filter(a => a.id !== editingEmpireId);
                    saveAssets();
                } else {
                    liabilities = liabilities.filter(l => l.id !== editingEmpireId);
                    saveLiabilities();
                }
                
                renderEmpireLists();
                updateEmpireStats();
                closeModal('empireModal');
                editingEmpireId = null;
                showToast('Item deleted');
            }
        }

        function renderEmpireLists() {
            const isArabic = currentLanguage === 'ar-funny';
            
            // Render Assets
            const assetsContainer = document.getElementById('assetsList');
            if (assets.length === 0) {
                assetsContainer.innerHTML = `
                    <div class="empire-empty">
                        <div class="empire-empty-icon"></div>
                        <p class="empire-empty-text">${isArabic ? '  .   !' : 'No assets yet. Add your first!'}</p>
                    </div>
                `;
            } else {
                const totalAssets = assets.reduce((sum, a) => sum + a.value, 0);
                assetsContainer.innerHTML = assets.map(asset => {
                    const typeInfo = assetTypes.find(t => t.id === asset.type) || assetTypes[assetTypes.length - 1];
                    const exampleBadge = asset.isExample ? `<span class="example-badge">${isArabic ? '' : 'EXAMPLE'}</span>` : '';
                    const exampleClass = asset.isExample ? 'example-item' : '';
                    const typeName = isArabic ? (typeInfo.nameAr || typeInfo.name) : typeInfo.name;
                    return `
                        <div class="empire-item ${exampleClass}">
                            <div class="empire-item-icon asset">${asset.icon}</div>
                            <div class="empire-item-info" onclick="window.openEmpireModal && window.openEmpireModal('asset', ${asset.id})">
                                <div class="empire-item-name">${asset.name}${exampleBadge}</div>
                                <div class="empire-item-category">${typeName}</div>
                            </div>
                            <div class="empire-item-value asset">${formatCurrency(asset.value)}</div>
                            <div class="empire-item-actions">
                                <button class="empire-action-btn edit" onclick="window.openEmpireModal && window.openEmpireModal('asset', ${asset.id})" title="${isArabic ? '' : 'Edit'}"></button>
                                <button class="empire-action-btn delete" onclick="quickDeleteAsset(${asset.id})" title="${isArabic ? '' : 'Delete'}"></button>
                            </div>
                        </div>
                    `;
                }).join('') + `
                    <div class="empire-section-total">
                        <span class="empire-total-label assets">${isArabic ? ' ' : 'Total Assets'}</span>
                        <span class="empire-total-value assets">${formatCurrency(totalAssets)}</span>
                    </div>
                `;
            }

            // Render Liabilities
            const liabilitiesContainer = document.getElementById('liabilitiesList');
            if (liabilities.length === 0) {
                liabilitiesContainer.innerHTML = `
                    <div class="empire-empty">
                        <div class="empire-empty-icon"></div>
                        <p class="empire-empty-text">${isArabic ? '  . ! ' : 'No liabilities. Great job!'}</p>
                    </div>
                `;
            } else {
                const totalLiabilities = liabilities.reduce((sum, l) => sum + l.value, 0);
                liabilitiesContainer.innerHTML = liabilities.map(liability => {
                    const typeInfo = liabilityTypes.find(t => t.id === liability.type) || liabilityTypes[liabilityTypes.length - 1];
                    const exampleBadge = liability.isExample ? `<span class="example-badge">${isArabic ? '' : 'EXAMPLE'}</span>` : '';
                    const exampleClass = liability.isExample ? 'example-item' : '';
                    const typeName = isArabic ? (typeInfo.nameAr || typeInfo.name) : typeInfo.name;
                    return `
                        <div class="empire-item ${exampleClass}">
                            <div class="empire-item-icon liability">${liability.icon}</div>
                            <div class="empire-item-info" onclick="window.openEmpireModal && window.openEmpireModal('liability', ${liability.id})">
                                <div class="empire-item-name">${liability.name}${exampleBadge}</div>
                                <div class="empire-item-category">${typeName}</div>
                            </div>
                            <div class="empire-item-value liability">${formatCurrency(liability.value)}</div>
                            <div class="empire-item-actions">
                                <button class="empire-action-btn edit" onclick="window.openEmpireModal && window.openEmpireModal('liability', ${liability.id})" title="${isArabic ? '' : 'Edit'}"></button>
                                <button class="empire-action-btn delete" onclick="quickDeleteLiability(${liability.id})" title="${isArabic ? '' : 'Delete'}"></button>
                            </div>
                        </div>
                    `;
                }).join('') + `
                    <div class="empire-section-total">
                        <span class="empire-total-label liabilities">${isArabic ? ' ' : 'Total Liabilities'}</span>
                        <span class="empire-total-value liabilities">${formatCurrency(totalLiabilities)}</span>
                    </div>
                `;
            }
        }

        function updateEmpireStats() {
            const isArabic = currentLanguage === 'ar-funny';
            const totalAssets = assets.reduce((sum, a) => sum + a.value, 0);
            const totalLiabilities = liabilities.reduce((sum, l) => sum + l.value, 0);
            const netWorth = totalAssets - totalLiabilities;
            const total = totalAssets + totalLiabilities;
            
            // Net Worth Display
            const netWorthEl = document.getElementById('netWorthValue');
            netWorthEl.textContent = (netWorth < 0 ? '-' : '') + formatCurrency(Math.abs(netWorth));
            netWorthEl.className = 'net-worth-value ' + (netWorth >= 0 ? 'positive' : 'negative');

            // Bar chart
            const assetsPercent = total > 0 ? (totalAssets / total) * 100 : 50;
            const liabilitiesPercent = total > 0 ? (totalLiabilities / total) * 100 : 50;
            document.getElementById('assetsBar').style.width = assetsPercent + '%';
            document.getElementById('liabilitiesBar').style.width = liabilitiesPercent + '%';
            document.getElementById('assetsBarLabel').textContent = formatCurrency(totalAssets) + (isArabic ? ' ' : ' Assets');
            document.getElementById('liabilitiesBarLabel').textContent = formatCurrency(totalLiabilities) + (isArabic ? ' ' : ' Liabilities');

            // Quick stats
            document.getElementById('assetCount').textContent = assets.length;
            document.getElementById('liabilityCount').textContent = liabilities.length;
            
            // Wealth ratio (assets / liabilities)
            const wealthRatio = totalLiabilities > 0 ? Math.round((totalAssets / totalLiabilities) * 100) : (totalAssets > 0 ? '' : 0);
            document.getElementById('wealthRatio').textContent = wealthRatio === '' ? '' : wealthRatio + '%';
        }

        function saveAssets() {
            localStorage.setItem('pocketflow_assets', JSON.stringify(assets));
        }

        function saveLiabilities() {
            localStorage.setItem('pocketflow_liabilities', JSON.stringify(liabilities));
        }

        function quickDeleteAsset(assetId) {
            event.stopPropagation();
            if (confirm('Delete this asset?')) {
                assets = assets.filter(a => a.id !== assetId);
                saveAssets();
                renderEmpireLists();
                updateEmpireStats();
                calculateHealthScore();
                showToast('Asset deleted');
            }
        }

        function quickDeleteLiability(liabilityId) {
            event.stopPropagation();
            if (confirm('Delete this liability?')) {
                liabilities = liabilities.filter(l => l.id !== liabilityId);
                saveLiabilities();
                renderEmpireLists();
                updateEmpireStats();
                calculateHealthScore();
                showToast('Liability deleted');
            }
        }

        // =====================
        // RECURRING SUBSCRIPTIONS FUNCTIONS
        // =====================

        function selectSubscriptionType(element, type, icon) {
            document.querySelectorAll('.subscription-type-item').forEach(o => o.classList.remove('active'));
            element.classList.add('active');
            selectedSubscriptionType = type;
            selectedSubscriptionIcon = icon;
        }

        function selectBillingCycle(element, cycle) {
            document.querySelectorAll('.billing-cycle-option').forEach(o => o.classList.remove('active'));
            element.classList.add('active');
            selectedBillingCycle = cycle;
        }

        function openSubscriptionModal(subscriptionId = null) {
            editingSubscriptionId = subscriptionId;
            const modal = document.getElementById('subscriptionModal');
            const title = document.getElementById('subscriptionModalTitle');
            const btn = document.getElementById('subscriptionSubmitBtn');
            const deleteBtn = document.getElementById('subscriptionDeleteBtn');
            const isArabic = currentLanguage === 'ar-funny';
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            
            if (subscriptionId) {
                const sub = subscriptions.find(s => s.id === subscriptionId);
                if (sub) {
                    title.textContent = isArabic ? ' ' : 'Edit Subscription';
                    btn.textContent = isArabic ? ' ' : 'Save Changes';
                    deleteBtn.style.display = 'block';
                    deleteBtn.innerHTML = isArabic ? '  ' : ' Delete Subscription';
                    document.getElementById('subscriptionNameInput').value = sub.name;
                    document.getElementById('subscriptionAmountInput').value = sub.amount;
                    document.getElementById('subscriptionBillDateInput').value = sub.nextBillDate || today;
                    
                    // Select the right type
                    selectedSubscriptionType = sub.type;
                    selectedSubscriptionIcon = sub.icon;
                    document.querySelectorAll('.subscription-type-item').forEach(o => {
                        o.classList.toggle('active', o.dataset.type === sub.type);
                    });

                    // Select billing cycle
                    selectedBillingCycle = sub.billingCycle || 'monthly';
                    document.querySelectorAll('.billing-cycle-option').forEach(o => {
                        o.classList.toggle('active', o.dataset.cycle === selectedBillingCycle);
                    });
                }
            } else {
                title.textContent = isArabic ? ' ' : 'Add Subscription';
                btn.textContent = isArabic ? ' ' : 'Add Subscription';
                deleteBtn.style.display = 'none';
                document.getElementById('subscriptionNameInput').value = '';
                document.getElementById('subscriptionAmountInput').value = '';
                document.getElementById('subscriptionBillDateInput').value = today;
                
                // Reset to defaults
                selectedSubscriptionType = 'streaming';
                selectedSubscriptionIcon = '';
                selectedBillingCycle = 'monthly';
                document.querySelectorAll('.subscription-type-item').forEach(o => {
                    o.classList.toggle('active', o.dataset.type === 'streaming');
                });
                document.querySelectorAll('.billing-cycle-option').forEach(o => {
                    o.classList.toggle('active', o.dataset.cycle === 'monthly');
                });
            }
            
            modal.classList.add('active');
            document.body.classList.add('modal-open');
        }

        function addSubscription() {
            const name = document.getElementById('subscriptionNameInput').value.trim();
            const amount = parseFloat(document.getElementById('subscriptionAmountInput').value);
            const nextBillDate = document.getElementById('subscriptionBillDateInput').value;

            if (!name) {
                showToast('Please enter a service name');
                return;
            }
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount');
                return;
            }

            if (editingSubscriptionId) {
                const index = subscriptions.findIndex(s => s.id === editingSubscriptionId);
                if (index !== -1) {
                    subscriptions[index] = {
                        ...subscriptions[index],
                        name,
                        amount,
                        nextBillDate,
                        type: selectedSubscriptionType,
                        icon: selectedSubscriptionIcon,
                        billingCycle: selectedBillingCycle
                    };
                }
                showToast('Subscription updated!');
            } else {
                const subscription = {
                    id: Date.now(),
                    name,
                    amount,
                    nextBillDate,
                    type: selectedSubscriptionType,
                    icon: selectedSubscriptionIcon,
                    billingCycle: selectedBillingCycle,
                    createdAt: new Date().toISOString()
                };
                subscriptions.push(subscription);
                showToast('Subscription added!');
            }

            saveSubscriptions();
            renderSubscriptionsList();
            updateSubscriptionTotals();
            closeModal('subscriptionModal');
            editingSubscriptionId = null;
        }

        function deleteCurrentSubscription() {
            if (editingSubscriptionId && confirm('Delete this subscription?')) {
                subscriptions = subscriptions.filter(s => s.id !== editingSubscriptionId);
                saveSubscriptions();
                renderSubscriptionsList();
                updateSubscriptionTotals();
                closeModal('subscriptionModal');
                editingSubscriptionId = null;
                showToast('Subscription removed');
            }
        }

        function deleteSubscription(id) {
            if (confirm('Delete this subscription?')) {
                subscriptions = subscriptions.filter(s => s.id !== id);
                saveSubscriptions();
                renderSubscriptionsList();
                updateSubscriptionTotals();
                showToast('Subscription removed');
            }
        }

        function quickDeleteSubscription(id) {
            if (confirm('Delete this subscription?')) {
                subscriptions = subscriptions.filter(s => s.id !== id);
                saveSubscriptions();
                renderSubscriptionsList();
                updateSubscriptionTotals();
                calculateHealthScore();
                showToast('Subscription deleted');
            }
        }

        function renderSubscriptionsList() {
            const container = document.getElementById('recurringList');
            const emptyState = document.getElementById('recurringEmpty');
            const listContainer = document.getElementById('recurringListContainer');
            const statsContainer = document.getElementById('recurringStats');
            const isArabic = currentLanguage === 'ar-funny';

            if (subscriptions.length === 0) {
                emptyState.style.display = 'block';
                listContainer.style.display = 'none';
                statsContainer.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            listContainer.style.display = 'block';
            statsContainer.style.display = 'grid';

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Auto-update past bill dates to the next billing cycle
            let needsSave = false;
            subscriptions.forEach(sub => {
                if (sub.nextBillDate) {
                    let billDate = new Date(sub.nextBillDate);
                    const interval = sub.billingCycle === 'yearly' ? 365 : 30;
                    
                    // Keep advancing until the bill date is today or in the future
                    while (billDate < today) {
                        billDate.setDate(billDate.getDate() + interval);
                        needsSave = true;
                    }
                    
                    if (needsSave) {
                        sub.nextBillDate = billDate.toISOString().split('T')[0];
                    }
                }
            });
            
            if (needsSave) {
                saveSubscriptions();
            }

            // Sort by next bill date
            const sorted = [...subscriptions].sort((a, b) => {
                const dateA = new Date(a.nextBillDate || '9999-12-31');
                const dateB = new Date(b.nextBillDate || '9999-12-31');
                return dateA - dateB;
            });

            container.innerHTML = sorted.map(sub => {
                const monthly = sub.billingCycle === 'yearly' ? sub.amount / 12 : sub.amount;
                const yearly = sub.billingCycle === 'yearly' ? sub.amount : sub.amount * 12;
                
                let nextBillText = '-';
                let isDueSoon = false;
                
                if (sub.nextBillDate) {
                    const billDate = new Date(sub.nextBillDate);
                    const daysUntil = Math.ceil((billDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntil <= 0) {
                        nextBillText = isArabic ? '' : 'Due today';
                        isDueSoon = true;
                    } else if (daysUntil <= 3) {
                        nextBillText = isArabic ? `${daysUntil} ` : `${daysUntil} day${daysUntil > 1 ? 's' : ''}`;
                        isDueSoon = true;
                    } else if (daysUntil <= 7) {
                        nextBillText = isArabic ? `${daysUntil} ` : `${daysUntil} days`;
                    } else {
                        nextBillText = billDate.toLocaleDateString(isArabic ? 'ar-SA' : 'en-US', { month: 'short', day: 'numeric' });
                    }
                }
                
                const cycleText = isArabic 
                    ? (sub.billingCycle === 'yearly' ? '' : '')
                    : sub.billingCycle.toUpperCase();
                const yrText = isArabic ? '/' : '/yr';
                const dueSoonText = isArabic ? '' : 'DUE SOON';
                const exampleText = isArabic ? '' : 'EXAMPLE';
                
                return `
                    <div class="recurring-item ${isDueSoon ? 'due-soon' : ''} ${sub.isExample ? 'example-item' : ''}">
                        <div class="recurring-item-icon ${sub.type}">${sub.icon}</div>
                        <div class="recurring-item-details">
                            <div class="recurring-item-name">${sub.name}${sub.isExample ? `<span class="example-badge">${exampleText}</span>` : ''}</div>
                            <div class="recurring-item-meta">
                                <span class="recurring-item-cycle">${cycleText}</span>
                                <span> ${nextBillText}</span>
                                ${isDueSoon ? `<span class="due-badge">${dueSoonText}</span>` : ''}
                            </div>
                        </div>
                        <div class="recurring-item-amounts">
                            <div class="recurring-item-monthly">${formatCurrency(monthly)}</div>
                            <div class="recurring-item-yearly">${formatCurrency(yearly)}${yrText}</div>
                        </div>
                        <div class="recurring-item-actions">
                            <button class="recurring-item-action-btn" onclick="openSubscriptionModal(${sub.id})" title="${isArabic ? '' : 'Edit'}"></button>
                            <button class="recurring-item-action-btn delete" onclick="quickDeleteSubscription(${sub.id})" title="${isArabic ? '' : 'Delete'}"></button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateSubscriptionTotals() {
            let monthlyTotal = 0;
            let yearlyTotal = 0;

            subscriptions.forEach(sub => {
                if (sub.billingCycle === 'yearly') {
                    monthlyTotal += sub.amount / 12;
                    yearlyTotal += sub.amount;
                } else {
                    monthlyTotal += sub.amount;
                    yearlyTotal += sub.amount * 12;
                }
            });

            document.getElementById('recurringMonthlyTotal').textContent = formatCurrency(monthlyTotal);
            document.getElementById('recurringYearlyTotal').textContent = formatCurrency(yearlyTotal);

            // Update stats
            document.getElementById('recurringCount').textContent = subscriptions.length;
            
            const avgMonthly = subscriptions.length > 0 ? monthlyTotal / subscriptions.length : 0;
            document.getElementById('recurringAvg').textContent = formatCurrency(avgMonthly);

            // Find next bill date
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let nextBillDate = null;
            subscriptions.forEach(sub => {
                if (sub.nextBillDate) {
                    const billDate = new Date(sub.nextBillDate);
                    if (billDate >= today && (!nextBillDate || billDate < nextBillDate)) {
                        nextBillDate = billDate;
                    }
                }
            });

            if (nextBillDate) {
                const daysUntil = Math.ceil((nextBillDate - today) / (1000 * 60 * 60 * 24));
                if (daysUntil === 0) {
                    document.getElementById('recurringNext').textContent = 'Today';
                } else if (daysUntil === 1) {
                    document.getElementById('recurringNext').textContent = 'Tomorrow';
                } else {
                    document.getElementById('recurringNext').textContent = nextBillDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
            } else {
                document.getElementById('recurringNext').textContent = '-';
            }
        }

        function saveSubscriptions() {
            localStorage.setItem('pocketflow_subscriptions', JSON.stringify(subscriptions));
        }

        // ==================
        // SPLIT COSTS
        // ==================
        
        function saveSplitFriends() {
            localStorage.setItem('pocketflow_split_friends', JSON.stringify(splitFriends));
        }
        
        function saveSplitGroups() {
            localStorage.setItem('pocketflow_split_groups', JSON.stringify(splitGroups));
        }
        
        function saveSplitExpenses() {
            localStorage.setItem('pocketflow_split_expenses', JSON.stringify(splitExpenses));
        }
        
        function openAddFriendModal() {
            document.getElementById('friendNameInput').value = '';
            document.getElementById('friendEmailInput').value = '';
            document.getElementById('addFriendModal').classList.add('active');
            document.body.classList.add('modal-open');
        }
        
        function addFriend() {
            const name = document.getElementById('friendNameInput').value.trim();
            const email = document.getElementById('friendEmailInput').value.trim();
            
            if (!name) {
                showToast('Please enter a name');
                return;
            }
            
            const friend = {
                id: Date.now(),
                name: name,
                email: email || '',
                avatar: name.charAt(0).toUpperCase(),
                createdAt: new Date().toISOString()
            };
            
            splitFriends.push(friend);
            saveSplitFriends();
            renderSplitFriends();
            updateSplitBalances();
            closeModal('addFriendModal');
            showToast('Friend added! ');
        }
        
        function deleteFriend(friendId) {
            if (confirm('Remove this friend? Their expense history will be kept.')) {
                splitFriends = splitFriends.filter(f => f.id !== friendId);
                saveSplitFriends();
                renderSplitFriends();
                updateSplitBalances();
                showToast('Friend removed');
            }
        }
        
        function openCreateGroupModal() {
            document.getElementById('groupNameInput').value = '';
            selectedGroupIcon = '';
            // Reset icon selection UI
            document.querySelectorAll('.split-icon-item').forEach(el => el.classList.remove('active'));
            document.querySelector('.split-icon-item[data-icon=""]')?.classList.add('active');
            renderGroupMemberSelection();
            document.getElementById('createGroupModal').classList.add('active');
            document.body.classList.add('modal-open');
        }
        
        function selectGroupIcon(element, icon) {
            selectedGroupIcon = icon;
            document.querySelectorAll('.split-icon-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        }
        
        function renderGroupMemberSelection() {
            const container = document.getElementById('groupMembersSelect');
            selectedSplitMembers = [];
            
            if (!container) return;
            
            if (splitFriends.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">Add friends first to create a group</p>';
                return;
            }
            
            container.innerHTML = splitFriends.map(friend => `
                <div class="split-member-chip" data-id="${friend.id}" onclick="toggleGroupMember(${friend.id}, this)">
                    <div class="split-member-chip-avatar">${friend.avatar}</div>
                    <span class="split-member-chip-name">${friend.name}</span>
                </div>
            `).join('');
        }
        
        function toggleGroupMember(friendId, element) {
            element.classList.toggle('selected');
            if (selectedSplitMembers.includes(friendId)) {
                selectedSplitMembers = selectedSplitMembers.filter(id => id !== friendId);
            } else {
                selectedSplitMembers.push(friendId);
            }
        }
        
        function createGroup() {
            const name = document.getElementById('groupNameInput').value.trim();
            const icon = selectedGroupIcon || '';
            
            if (!name) {
                showToast('Please enter a group name');
                return;
            }
            
            const group = {
                id: Date.now(),
                name: name,
                icon: icon,
                members: [...selectedSplitMembers],
                createdAt: new Date().toISOString()
            };
            
            splitGroups.push(group);
            saveSplitGroups();
            renderSplitGroups();
            closeModal('createGroupModal');
            showToast('Group created! ');
        }
        
        function deleteGroup(groupId) {
            if (confirm('Delete this group? Expense history will be kept.')) {
                splitGroups = splitGroups.filter(g => g.id !== groupId);
                saveSplitGroups();
                renderSplitGroups();
                updateSplitBalances();
                showToast('Group deleted');
            }
        }
        
        function openAddExpenseModal() {
            document.getElementById('splitExpenseDescInput').value = '';
            document.getElementById('splitExpenseAmountInput').value = '';
            selectedSplitMethod = 'equal';
            selectedPayer = 'me';
            currentGroupId = null;
            
            // Render group/friend selection
            renderExpenseGroupSelection();
            renderExpensePayerSelection();
            
            document.getElementById('addSplitExpenseModal').classList.add('active');
            document.body.classList.add('modal-open');
        }
        
        function openAddExpenseForGroup() {
            openAddExpenseModal();
        }
        
        function renderExpenseGroupSelection() {
            const container = document.getElementById('expenseGroupSelection');
            
            let html = '<div class="split-member-select">';
            
            // Add individual friends
            splitFriends.forEach(friend => {
                html += `
                    <div class="split-member-chip" data-type="friend" data-id="${friend.id}" onclick="selectExpenseTarget('friend', ${friend.id}, this)">
                        <div class="split-member-chip-avatar">${friend.avatar}</div>
                        <span class="split-member-chip-name">${friend.name}</span>
                    </div>
                `;
            });
            
            // Add groups
            splitGroups.forEach(group => {
                html += `
                    <div class="split-member-chip" data-type="group" data-id="${group.id}" onclick="selectExpenseTarget('group', ${group.id}, this)">
                        <div class="split-member-chip-avatar" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">${group.icon}</div>
                        <span class="split-member-chip-name">${group.name}</span>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (splitFriends.length === 0 && splitGroups.length === 0) {
                html = '<p style="color: var(--text-muted); font-size: 13px;">Add friends or create groups first</p>';
            }
            
            container.innerHTML = html;
        }
        
        function selectExpenseTarget(type, id, element) {
            document.querySelectorAll('#expenseGroupSelection .split-member-chip').forEach(el => {
                el.classList.remove('selected');
            });
            element.classList.add('selected');
            
            currentGroupId = { type, id };
            renderExpensePayerSelection();
        }
        
        function renderExpensePayerSelection() {
            const container = document.getElementById('expensePayerSelection');
            
            let members = [{ id: 'me', name: 'Me', avatar: '' }];
            
            if (currentGroupId) {
                if (currentGroupId.type === 'friend') {
                    const friend = splitFriends.find(f => f.id === currentGroupId.id);
                    if (friend) members.push(friend);
                } else if (currentGroupId.type === 'group') {
                    const group = splitGroups.find(g => g.id === currentGroupId.id);
                    if (group) {
                        group.members.forEach(memberId => {
                            const friend = splitFriends.find(f => f.id === memberId);
                            if (friend) members.push(friend);
                        });
                    }
                }
            }
            
            container.innerHTML = members.map(member => `
                <div class="split-member-chip ${member.id === selectedPayer ? 'selected' : ''}" 
                     onclick="selectPayer('${member.id}', this)">
                    <div class="split-member-chip-avatar">${member.avatar || member.name.charAt(0)}</div>
                    <span class="split-member-chip-name">${member.name}</span>
                </div>
            `).join('');
        }
        
        function selectPayer(payerId, element) {
            document.querySelectorAll('#expensePayerSelection .split-member-chip').forEach(el => {
                el.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedPayer = payerId;
        }
        
        function selectSplitMethod(method, element) {
            document.querySelectorAll('.split-method-option').forEach(el => {
                el.classList.remove('active');
            });
            element.classList.add('active');
            selectedSplitMethod = method;
        }
        
        function addSplitExpense() {
            const description = document.getElementById('splitExpenseDescInput').value.trim();
            const amount = parseFloat(document.getElementById('splitExpenseAmountInput').value);
            
            if (!description) {
                showToast('Please enter a description');
                return;
            }
            
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount');
                return;
            }
            
            if (!currentGroupId) {
                showToast('Please select who to split with');
                return;
            }
            
            // Calculate splits
            let splits = [];
            let members = ['me'];
            
            if (currentGroupId.type === 'friend') {
                members.push(currentGroupId.id);
            } else if (currentGroupId.type === 'group') {
                const group = splitGroups.find(g => g.id === currentGroupId.id);
                if (group) {
                    members = ['me', ...group.members];
                }
            }
            
            const shareAmount = amount / members.length;
            
            members.forEach(memberId => {
                splits.push({
                    memberId: memberId,
                    share: shareAmount,
                    paid: memberId === selectedPayer ? amount : 0
                });
            });
            
            const expense = {
                id: Date.now(),
                description: description,
                amount: amount,
                paidBy: selectedPayer,
                targetType: currentGroupId.type,
                targetId: currentGroupId.id,
                splitMethod: selectedSplitMethod,
                splits: splits,
                settled: false,
                createdAt: new Date().toISOString()
            };
            
            splitExpenses.push(expense);
            saveSplitExpenses();
            renderSplitActivity();
            renderSplitSettlements();
            updateSplitBalances();
            closeModal('addSplitExpenseModal');
            showToast('Expense added! ');
        }
        
        function renderSplitFriends() {
            const container = document.getElementById('splitFriendsList');
            const isArabic = currentLanguage === 'ar-funny';
            
            if (splitFriends.length === 0) {
                container.innerHTML = `
                    <div class="split-empty-state">
                        <div class="split-empty-icon"></div>
                        <p>${isArabic ? '     ' : 'No friends added yet'}</p>
                        <button class="split-empty-btn" onclick="window.openAddFriendModal && window.openAddFriendModal()">${isArabic ? '  ' : 'Add Your First Friend'}</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = splitFriends.map(friend => {
                const balance = calculateFriendBalance(friend.id);
                let balanceClass = 'zero';
                let balanceText = isArabic ? '  ' : 'Settled up';
                
                if (balance > 0) {
                    balanceClass = 'positive';
                    balanceText = isArabic ? ' ' : 'owes you';
                } else if (balance < 0) {
                    balanceClass = 'negative';
                    balanceText = isArabic ? ' ' : 'you owe';
                }
                
                return `
                    <div class="split-friend-card">
                        <div class="split-friend-avatar">${friend.avatar}</div>
                        <div class="split-friend-info">
                            <div class="split-friend-name">${friend.name}</div>
                            <div class="split-friend-email">${friend.email || (isArabic ? ' ' : 'No email')}</div>
                        </div>
                        <div class="split-friend-balance">
                            <div class="split-friend-balance-label">${balanceText}</div>
                            <div class="split-friend-balance-value ${balanceClass}">${formatCurrency(Math.abs(balance))}</div>
                        </div>
                        <div class="split-friend-actions">
                            ${balance !== 0 ? `<button class="split-friend-action-btn settle" onclick="settleWithFriend(${friend.id})" title="${isArabic ? '' : 'Settle'}"></button>` : ''}
                            <button class="split-friend-action-btn delete" onclick="deleteFriend(${friend.id})" title="${isArabic ? '' : 'Remove'}"></button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderSplitGroups() {
            const container = document.getElementById('splitGroupsList');
            const isArabic = currentLanguage === 'ar-funny';
            
            if (splitGroups.length === 0) {
                container.innerHTML = `
                    <div class="split-empty-state">
                        <div class="split-empty-icon"></div>
                        <p>${isArabic ? '     ' : 'No groups created yet'}</p>
                        <button class="split-empty-btn" onclick="window.openCreateGroupModal && window.openCreateGroupModal()">${isArabic ? '  ' : 'Create Your First Group'}</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = splitGroups.map(group => {
                const memberCount = group.members.length + 1; // +1 for "me"
                const balance = calculateGroupBalance(group.id);
                let balanceClass = balance >= 0 ? 'positive' : 'negative';
                let balancePrefix = balance >= 0 ? '+' : '';
                
                const groupExpenses = splitExpenses.filter(e => e.targetType === 'group' && e.targetId === group.id);
                const membersText = isArabic ? `${memberCount} ` : `${memberCount} members`;
                const expensesText = isArabic ? `${groupExpenses.length} ` : `${groupExpenses.length} expenses`;
                
                return `
                    <div class="split-group-card">
                        <div class="split-group-header" onclick="toggleGroupExpand(${group.id})">
                            <div class="split-group-icon">${group.icon}</div>
                            <div class="split-group-info">
                                <div class="split-group-name">${group.name}</div>
                                <div class="split-group-members">${membersText}  ${expensesText}</div>
                            </div>
                            <div class="split-group-balance">
                                <div class="split-group-balance-value ${balanceClass}">${balancePrefix}${formatCurrency(Math.abs(balance))}</div>
                            </div>
                        </div>
                        <div class="split-group-expanded" id="groupExpanded-${group.id}" style="display: none;">
                            ${groupExpenses.length > 0 ? groupExpenses.slice(-3).map(exp => `
                                <div class="split-group-expense">
                                    <div class="split-expense-icon"></div>
                                    <div class="split-expense-info">
                                        <div class="split-expense-desc">${exp.description}</div>
                                        <div class="split-expense-meta">${new Date(exp.createdAt).toLocaleDateString(isArabic ? 'ar-SA' : 'en-US')}</div>
                                    </div>
                                    <div class="split-expense-amount">${formatCurrency(exp.amount)}</div>
                                </div>
                            `).join('') : `<p style="color: var(--text-muted); font-size: 13px; padding: 10px 0;">${isArabic ? '    ' : 'No expenses yet'}</p>`}
                            <div class="split-group-actions">
                                <button class="split-group-action-btn secondary" onclick="deleteGroup(${group.id})"> ${isArabic ? '' : 'Delete'}</button>
                                <button class="split-group-action-btn primary" onclick="currentGroupId = {type: 'group', id: ${group.id}}; openAddExpenseModal();">+ ${isArabic ? ' ' : 'Add Expense'}</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function toggleGroupExpand(groupId) {
            const el = document.getElementById(`groupExpanded-${groupId}`);
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }
        
        function renderSplitActivity() {
            const container = document.getElementById('splitActivityList');
            
            if (splitExpenses.length === 0) {
                container.innerHTML = `
                    <div class="split-empty-state">
                        <div class="split-empty-icon"></div>
                        <p>${currentLanguage === 'ar-funny' ? '   ' : 'No expenses to split yet'}</p>
                    </div>
                `;
                return;
            }
            
            const sortedExpenses = [...splitExpenses].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 10);
            const isArabic = currentLanguage === 'ar-funny';
            
            container.innerHTML = sortedExpenses.map(exp => {
                let targetName = isArabic ? ' ' : 'Unknown';
                if (exp.targetType === 'friend') {
                    const friend = splitFriends.find(f => f.id === exp.targetId);
                    targetName = friend ? friend.name : (isArabic ? ' ' : 'Unknown');
                } else if (exp.targetType === 'group') {
                    const group = splitGroups.find(g => g.id === exp.targetId);
                    targetName = group ? group.name : (isArabic ? ' ' : 'Unknown');
                }
                
                const payerName = exp.paidBy === 'me' ? (isArabic ? '' : 'You') : (splitFriends.find(f => f.id === exp.paidBy)?.name || (isArabic ? '' : 'Someone'));
                const paidForText = isArabic ? `<strong>${payerName}</strong>  ${exp.description}` : `<strong>${payerName}</strong> paid for ${exp.description}`;
                
                return `
                    <div class="split-activity-item">
                        <div class="split-activity-icon"></div>
                        <div class="split-activity-info">
                            <div class="split-activity-text">${paidForText}</div>
                            <div class="split-activity-date">${targetName}  ${new Date(exp.createdAt).toLocaleDateString(isArabic ? 'ar-SA' : 'en-US')}</div>
                        </div>
                        <div class="split-activity-amount">${formatCurrency(exp.amount)}</div>
                    </div>
                `;
            }).join('');
        }
        
        function renderSplitSettlements() {
            const container = document.getElementById('splitSettlementsList');
            const settlements = calculateSettlements();
            const isArabic = currentLanguage === 'ar-funny';
            
            if (settlements.length === 0) {
                container.innerHTML = `
                    <div class="split-empty-state">
                        <div class="split-empty-icon"></div>
                        <p>${isArabic ? '  ! ' : 'All settled up!'}</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = settlements.map(s => {
                const fromName = s.from === 'me' ? (isArabic ? '' : 'You') : (splitFriends.find(f => f.id === s.from)?.name || (isArabic ? '' : 'Someone'));
                const toName = s.to === 'me' ? (isArabic ? '' : 'you') : (splitFriends.find(f => f.id === s.to)?.name || (isArabic ? '' : 'someone'));
                const fromAvatar = s.from === 'me' ? (isArabic ? '' : 'Y') : (splitFriends.find(f => f.id === s.from)?.avatar || '?');
                const toAvatar = s.to === 'me' ? (isArabic ? '' : 'Y') : (splitFriends.find(f => f.id === s.to)?.avatar || '?');
                const owesText = isArabic ? `${fromName}   ${toName}` : `${fromName} owes ${toName}`;
                
                return `
                    <div class="split-settlement-item">
                        <div class="split-settlement-avatars">
                            <div class="split-settlement-avatar">${fromAvatar}</div>
                            <span class="split-settlement-arrow">${isArabic ? '' : ''}</span>
                            <div class="split-settlement-avatar">${toAvatar}</div>
                        </div>
                        <div class="split-settlement-info">
                            <div class="split-settlement-text">${owesText}</div>
                        </div>
                        <div class="split-settlement-amount">${formatCurrency(s.amount)}</div>
                        <button class="split-settle-btn" onclick="settleDebt('${s.from}', '${s.to}', ${s.amount})">${isArabic ? '' : 'Settle'}</button>
                    </div>
                `;
            }).join('');
        }
        
        function calculateFriendBalance(friendId) {
            let balance = 0;
            
            splitExpenses.forEach(exp => {
                if (exp.settled) return;
                
                // Check if this expense involves this friend
                const mySplit = exp.splits.find(s => s.memberId === 'me');
                const friendSplit = exp.splits.find(s => s.memberId === friendId);
                
                if (!friendSplit) return;
                
                // If I paid, friend owes me their share
                if (exp.paidBy === 'me') {
                    balance += friendSplit.share;
                }
                // If friend paid, I owe them my share
                else if (exp.paidBy === friendId) {
                    balance -= mySplit ? mySplit.share : 0;
                }
            });
            
            return balance;
        }
        
        function calculateGroupBalance(groupId) {
            let balance = 0;
            
            splitExpenses.forEach(exp => {
                if (exp.settled) return;
                if (exp.targetType !== 'group' || exp.targetId !== groupId) return;
                
                const mySplit = exp.splits.find(s => s.memberId === 'me');
                
                if (exp.paidBy === 'me') {
                    // I paid, so I'm owed (total - my share)
                    balance += exp.amount - (mySplit ? mySplit.share : 0);
                } else {
                    // Someone else paid, I owe my share
                    balance -= mySplit ? mySplit.share : 0;
                }
            });
            
            return balance;
        }
        
        function calculateSettlements() {
            // Calculate net balance for each person
            const balances = { me: 0 };
            
            splitFriends.forEach(f => {
                balances[f.id] = 0;
            });
            
            splitExpenses.forEach(exp => {
                if (exp.settled) return;
                
                exp.splits.forEach(split => {
                    if (balances[split.memberId] !== undefined) {
                        balances[split.memberId] -= split.share;
                        if (balances[exp.paidBy] !== undefined) {
                            balances[exp.paidBy] += split.share;
                        }
                    }
                });
            });
            
            // Debt minimization algorithm
            const settlements = [];
            const debtors = [];
            const creditors = [];
            
            Object.entries(balances).forEach(([id, balance]) => {
                if (balance < -0.01) {
                    debtors.push({ id, amount: -balance });
                } else if (balance > 0.01) {
                    creditors.push({ id, amount: balance });
                }
            });
            
            // Sort for optimal matching
            debtors.sort((a, b) => b.amount - a.amount);
            creditors.sort((a, b) => b.amount - a.amount);
            
            while (debtors.length > 0 && creditors.length > 0) {
                const debtor = debtors[0];
                const creditor = creditors[0];
                
                const amount = Math.min(debtor.amount, creditor.amount);
                
                if (amount > 0.01) {
                    settlements.push({
                        from: debtor.id,
                        to: creditor.id,
                        amount: Math.round(amount * 100) / 100
                    });
                }
                
                debtor.amount -= amount;
                creditor.amount -= amount;
                
                if (debtor.amount < 0.01) debtors.shift();
                if (creditor.amount < 0.01) creditors.shift();
            }
            
            return settlements;
        }
        
        function settleWithFriend(friendId) {
            if (confirm('Mark all expenses with this friend as settled?')) {
                splitExpenses.forEach(exp => {
                    if (exp.targetType === 'friend' && exp.targetId === friendId) {
                        exp.settled = true;
                    }
                });
                saveSplitExpenses();
                renderSplitFriends();
                renderSplitActivity();
                renderSplitSettlements();
                updateSplitBalances();
                showToast('Settled up! ');
            }
        }
        
        function settleDebt(fromId, toId, amount) {
            if (confirm(`Mark ${formatCurrency(amount)} as settled?`)) {
                // Find and settle relevant expenses
                splitExpenses.forEach(exp => {
                    if (exp.settled) return;
                    
                    const fromSplit = exp.splits.find(s => s.memberId === fromId);
                    const toSplit = exp.splits.find(s => s.memberId === toId);
                    
                    if (fromSplit && exp.paidBy === toId) {
                        exp.settled = true;
                    }
                });
                
                saveSplitExpenses();
                renderSplitFriends();
                renderSplitGroups();
                renderSplitActivity();
                renderSplitSettlements();
                updateSplitBalances();
                showToast('Payment recorded! ');
            }
        }
        
        function updateSplitBalances() {
            let owedToYou = 0;
            let youOwe = 0;
            
            splitFriends.forEach(friend => {
                const balance = calculateFriendBalance(friend.id);
                if (balance > 0) {
                    owedToYou += balance;
                } else {
                    youOwe += Math.abs(balance);
                }
            });
            
            document.getElementById('splitOwedToYou').textContent = formatCurrency(owedToYou);
            document.getElementById('splitYouOwe').textContent = formatCurrency(youOwe);
        }
        
        function initSplitCost() {
            renderSplitFriends();
            renderSplitGroups();
            renderSplitActivity();
            renderSplitSettlements();
            updateSplitBalances();
        }

        // Start app
        init();

        // iOS Safari fix - make all buttons with onclick work
        document.addEventListener('DOMContentLoaded', function() {
            // Fix for iOS not firing click events properly
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                document.body.style.cursor = 'pointer';
                
                // Add touch handlers to all interactive elements
                const clickables = document.querySelectorAll('button, [onclick], .nav-item, .category-item, .debt-card, .goal-card, .transaction-item, .recurring-item, .empire-item');
                clickables.forEach(el => {
                    el.style.cursor = 'pointer';
                });
            }
            
            // Hide bottom nav on scroll down, show on scroll up
            let lastScrollTop = 0;
            let navHidden = false;
            const bottomNav = document.querySelector('.bottom-nav');
            
            function handleScroll(scrollTop) {
                if (scrollTop > lastScrollTop && scrollTop > 60 && !navHidden) {
                    // Scrolling down - hide nav
                    bottomNav.style.transform = 'translateY(100%)';
                    bottomNav.style.transition = 'transform 0.3s ease';
                    navHidden = true;
                } else if (scrollTop < lastScrollTop - 5 && navHidden) {
                    // Scrolling up - show nav
                    bottomNav.style.transform = 'translateY(0)';
                    navHidden = false;
                }
                lastScrollTop = scrollTop;
            }
            
            // Add scroll listeners to all pages
            document.querySelectorAll('.page').forEach(page => {
                page.addEventListener('scroll', function() {
                    handleScroll(this.scrollTop);
                }, { passive: true });
                
                // Also listen for touch scroll
                page.addEventListener('touchmove', function() {
                    handleScroll(this.scrollTop);
                }, { passive: true });
            });
            
            // Reset nav visibility when switching pages
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    bottomNav.style.transform = 'translateY(0)';
                    navHidden = false;
                    lastScrollTop = 0;
                });
            });
        });
        
        // Expose all main functions globally
        window.addDebt = addDebt;
        window.addGoal = addGoal;
        window.addTransaction = addTransaction;
        window.addEmpireItem = addEmpireItem;
        window.addSubscription = addSubscription;
        window.makePayment = makePayment;
        window.handleCrushIt = handleCrushIt;
        window.makeDeposit = makeDeposit;
        window.closePaymentModal = closePaymentModal;
        window.closeModal = closeModal;
        window.deleteCurrentDebt = deleteCurrentDebt;
        window.deleteCurrentGoal = deleteCurrentGoal;
        window.deleteCurrentEmpireItem = deleteCurrentEmpireItem;
        window.deleteCurrentSubscription = deleteCurrentSubscription;
        window.openModal = openModal;
        window.openDebtModal = openDebtModal;
        window.openGoalModal = openGoalModal;
        window.openEmpireModal = openEmpireModal;
        window.openSubscriptionModal = openSubscriptionModal;
        window.openPaymentModal = openPaymentModal;
        window.openDepositModal = openDepositModal;
        window.switchPage = switchPage;
        window.selectCategory = selectCategory;
        window.selectDebtType = selectDebtType;
        window.selectGoalType = selectGoalType;
        window.selectEmpireType = selectEmpireType;
        window.selectSubscriptionType = selectSubscriptionType;
        window.selectFrequency = selectFrequency;
        window.toggleRecurring = toggleRecurring;
        window.toggleDarkMode = toggleDarkMode;
        window.resetData = resetData;
        window.clearExamples = clearExamples;
        window.quickDeleteDebt = quickDeleteDebt;
        window.quickDeleteGoal = quickDeleteGoal;
        window.quickDeleteAsset = quickDeleteAsset;
        window.quickDeleteLiability = quickDeleteLiability;
        window.quickDeleteSubscription = quickDeleteSubscription;
        window.deleteTransaction = deleteTransaction;
        window.editTransaction = editTransaction;
        window.replayOnboarding = replayOnboarding;
        window.exportData = exportData;
        window.exportCSV = typeof exportCSV !== 'undefined' ? exportCSV : function(){};
        window.importData = typeof importData !== 'undefined' ? importData : function(){};
        window.clearExampleData = typeof clearExampleData !== 'undefined' ? clearExampleData : clearExamples;
        
        // Split Cost functions
        window.openAddFriendModal = openAddFriendModal;
        window.addFriend = addFriend;
        window.deleteFriend = deleteFriend;
        window.openCreateGroupModal = openCreateGroupModal;
        window.createGroup = createGroup;
        window.deleteGroup = deleteGroup;
        window.openAddExpenseModal = openAddExpenseModal;
        window.addSplitExpense = addSplitExpense;
        window.toggleGroupMember = toggleGroupMember;
        window.selectExpenseTarget = selectExpenseTarget;
        window.selectPayer = selectPayer;
        window.selectSplitMethod = selectSplitMethod;
        window.settleWithFriend = settleWithFriend;
        window.settleDebt = settleDebt;
        window.toggleGroupExpand = toggleGroupExpand;
        window.selectGroupIcon = selectGroupIcon;
        
        // Language functions
        window.setLanguage = setLanguage;
        window.t = t;
        window.toggleLanguageQuick = toggleLanguageQuick;
        
        // Floating menu functions
        window.toggleFloatingMenu = toggleFloatingMenu;
        window.switchPageFromMenu = switchPageFromMenu;
    </script>
</body>
</html>
